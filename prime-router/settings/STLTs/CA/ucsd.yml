# University of California San Diego settings for staging
#
# To submit to staging, run:
# ./prime login --env staging
# ./prime multiple-settings set --env staging --input ./settings/STLTs/CA/ucsd.yml
#
# Tho add the sender key:
#  ./prime organization addkey --env staging --public-key /path/to/public/key.pem --scope "ucsd.*.report" --orgName ucsd --kid ucsd.etor-nbs-orders --doit
#
# You may use the below curl command to submit a request. You just need to replace the TOKEN with the auth JWT and the path to the FHIR message to send 
# curl -H 'Authorization: Bearer TOKEN' -H 'Client: flexion.etor-service-sender' -H 'Content-Type: application/fhir+ndjson' --data-binary '@/path/to/fhir/oru.fhir' 'https://staging.prime.cdc.gov/api/waters'

---
- name: "ucsd"
  description: "University of California San Diego"
  jurisdiction: "STATE"
  stateCode: "CA"
  senders:
    - name: "etor-nbs-orders"
      organizationName: "ucsd"
      topic: "etor-ti"
      customerStatus: "active"
      format: "HL7"
  receivers:
    - name: "etor-nbs-results"
      organizationName: "ucsd"
      topic: "etor-ti"
      customerStatus: "active"
      translation:
        type: "HL7"
        schemaName: "classpath:/metadata/hl7_mapping/ORU_R01/ORU_R01-base.yml"
        useBatchHeaders: false
        receivingApplicationName: "EPIC-INNERCONNECT"
        receivingFacilityName: "CA"
      jurisdictionalFilter:
        - "Bundle.entry.resource.ofType(MessageHeader).event.code = 'R01'"
        - "Bundle.entry.resource.ofType(MessageHeader).meta.tag.where(system = 'http://localcodes.org/ETOR').code = 'ETOR'"
        - "Bundle.entry.resource.ofType(MessageHeader).sender.resolve().identifier.where(value = 'CDPH').exists()"
        - "Bundle.entry.resource.ofType(DiagnosticReport)[0].basedOn.resolve().requester.resolve().organization.resolve().extension.where(url = 'https://reportstream.cdc.gov/fhir/StructureDefinition/xon-organization').extension.where(url = 'XON.10').value in ('R797' | 'R508')"
      qualityFilter:
        - "true"
      timing:
        operation: "MERGE"
        numberPerDay: 1440
        initialTime: "00:00"
        timeZone: "EASTERN"
        maxReportCount: 100
      transport:
        type: "REST"
        authType: "two-legged"
        authTokenUrl: "https://epicproxy-np.et0502.epichosted.com/FhirProxy/oauth2/token"
        reportUrl: "https://epicproxy-np.et0502.epichosted.com/CDPH_NBGS_TST/api/epic/2015/EDI/HTTP/HL7v2/910377"
        parameters:
          grant_type: "client_credentials"
          client_assertion_type: "urn:ietf:params:oauth:client-assertion-type:jwt-bearer"
          client_assertion: "client_secret"
        headers: { }
        authHeaders:
          Content-Type: "application/x-www-form-urlencoded"
