extends: ../original-pipeline-transforms
constants:
  serviceRequest: 'Bundle.entry.resource.ofType(ServiceRequest)'
  diagnosticReport: 'Bundle.entry.resource.ofType(DiagnosticReport)'
  patient: 'Bundle.entry.resource.ofType(Patient)'
  specimen: 'Bundle.entry.resource.ofType(Specimen)'
elements:

  # MSH
  - name: sending-application-target-msh3-extension
    condition: true
    resource: 'Bundle.entry.resource.ofType(MessageHeader)'
    bundleProperty: '%resource.source.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/namespace-id").value[x]'
    value: [ '"CDC PRIME - Atlanta"' ]

  - name: sending-application-universal-id-extension
    condition: true
    resource: 'Bundle.entry.resource.ofType(MessageHeader)'
    bundleProperty: '%resource.source.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/universal-id").value[x]'
    value: [ '"2.16.840.1.114222.4.1.237821"' ]

  - name: sending-application-universal-id-type-extension
    condition: true
    resource: 'Bundle.entry.resource.ofType(MessageHeader)'
    bundleProperty: '%resource.source.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/universal-id-type").value[x]'
    value: [ '"ISO"' ]

  - name: sending-application-target-msh3
    condition: true
    resource: 'Bundle.entry.resource.ofType(MessageHeader)'
    bundleProperty: '%resource.source.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/hl7-use").value[x]'
    value: [ '"sending-application"' ]

  - name: sr-order-control-business-event
    bundleProperty: '%serviceRequest.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/business-event").value[x]'
    value: [ '%serviceRequest.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/order-control").value.coding[0].code' ]

  - name: sr-sending-application-facility-identifier-extension
    resource: 'Bundle.entry.resource.ofType(MessageHeader).sender.resolve()'
    bundleProperty: '%resource.identifier[1].extension("https://reportstream.cdc.gov/fhir/StructureDefinition/identifier-namespace-id").value[x]'
    value: [ '%resource.name' ]
  #
  - name: sr-sending-application-facility-identifier-value
    resource: 'Bundle.entry.resource.ofType(MessageHeader).sender.resolve()'
    bundleProperty: '%resource.identifier[1].value'
    value: [ '%resource.name' ]

  - name: sr-sending-application-universal-id-identifier-extension
    resource: 'Bundle.entry.resource.ofType(MessageHeader).sender.resolve()'
    bundleProperty: '%resource.identifier[0].extension("https://reportstream.cdc.gov/fhir/StructureDefinition/identifier-universal-id").value[x]'
    value: [ '%resource.identifier[0].value' ]


  - name: sr-message-event-code-code
    bundleProperty: 'Bundle.entry.resource.ofType(MessageHeader).event.display'
    value: [ '"ORU^R01^ORU_R01"' ]

  # Order Observation Request filler identifier - this was being populated in CA receiver transforms
  #                                               should've been a sender transform in the first place since
  #                                               this is needed for NY too
  - name: sr-observation-request-identifier-filler
    bundleProperty: '%diagnosticReport.identifier[0].type.coding.code'
    value: [ '"FILL"' ]

  - name: sr-observation-request-identifier-filler-value
    bundleProperty: '%diagnosticReport.identifier[0].value'
    value: [ '%diagnosticReport.identifier[0].value' ]

  - name: sr-observation-request-identifier-filler-namespace-id
    bundleProperty: '%diagnosticReport.identifier[0].extension("https://reportstream.cdc.gov/fhir/StructureDefinition/assigning-authority").extension("https://reportstream.cdc.gov/fhir/StructureDefinition/assigning-authority-namespace-id").value[x]'
    value: [ '%diagnosticReport.basedOn.resolve().performer.resolve().name' ]

  - name: sr-observation-request-identifier-filler-universal-id
    bundleProperty: '%diagnosticReport.identifier[0].extension("https://reportstream.cdc.gov/fhir/StructureDefinition/assigning-authority").extension("https://reportstream.cdc.gov/fhir/StructureDefinition/assigning-authority-universal-id").value[x]'
    value: [ '%diagnosticReport.basedOn.resolve().performer.resolve().identifier.value' ]

  - name: sr-observation-request-identifier-filler-universal-id-type
    bundleProperty: '%diagnosticReport.identifier[0].extension("https://reportstream.cdc.gov/fhir/StructureDefinition/assigning-authority").extension("https://reportstream.cdc.gov/fhir/StructureDefinition/universal-id-type").value[x]'
    value: [ '%diagnosticReport.basedOn.resolve().performer.resolve().identifier.type.coding[0].code' ]

  - name: sr-diagnostic-report-identifier-filler-hl7-use
    bundleProperty: '%diagnosticReport.identifier[0].extension("https://reportstream.cdc.gov/fhir/StructureDefinition/hl7-use").value[x]'
    value: [ '"orc-3-filler-order-number"' ]

  # Order Observation Request placer identifier - this was being populated in CA receiver transforms
  #                                               should've been a sender transform in the first place since
  #                                               this is needed for NY too
  - name: sr-observation-request-identifier-placer-value
    bundleProperty: '%diagnosticReport.identifier[1].value'
    value: [ '%diagnosticReport.identifier[0].value' ]

  - name: sr-observation-request-identifier-placer-hl7-use
    bundleProperty: '%diagnosticReport.identifier[1].extension("https://reportstream.cdc.gov/fhir/StructureDefinition/hl7-use").value[x]'
    value: [ '"orc-2-placer-order-number"' ]

  - name: sr-observation-request-identifier-placer-namespace-id
    bundleProperty: '%diagnosticReport.identifier[1].extension("https://reportstream.cdc.gov/fhir/StructureDefinition/assigning-authority").extension("https://reportstream.cdc.gov/fhir/StructureDefinition/assigning-authority-namespace-id").value[x]'
    value: [ '%diagnosticReport.basedOn.resolve().performer.resolve().name' ]

  - name: sr-observation-request-identifier-placer-universal-id
    bundleProperty: '%diagnosticReport.identifier[1].extension("https://reportstream.cdc.gov/fhir/StructureDefinition/assigning-authority").extension("https://reportstream.cdc.gov/fhir/StructureDefinition/assigning-authority-universal-id").value[x]'
    value: [ '%diagnosticReport.basedOn.resolve().performer.resolve().identifier.value' ]

  - name: sr-observation-request-identifier-placer-universal-id-type
    bundleProperty: '%diagnosticReport.identifier[1].extension("https://reportstream.cdc.gov/fhir/StructureDefinition/assigning-authority").extension("https://reportstream.cdc.gov/fhir/StructureDefinition/universal-id-type").value[x]'
    value: [ '%diagnosticReport.basedOn.resolve().performer.resolve().identifier.type.coding[0].code' ]

  - name: sr-observation-request-identifier-placer-type-coding-code
    bundleProperty: '%diagnosticReport.identifier[1].type.coding[0].code'
    value: [ '"PLAC"' ]

  - name: sr-observation-request-identifier-placer-type-coding-system
    bundleProperty: '%diagnosticReport.identifier[1].type.coding[0].system'
    value: [ '"http://terminology.hl7.org/CodeSystem/v2-0203"' ]

  # SR sends AOEs under ServiceRequest.supportingInfo, but our FHIR to HL7 mappings map Observations
  # under supportingInfo to SPM OBX segments. To be able to exclude this Observations from being map under SPM we need
  # to identify with the AOE tag
  - name: sr-supporting-info-aoe-tag
    resource: 'Bundle.entry.resource.ofType(ServiceRequest).supportingInfo.resolve()'
    bundleProperty: '%resource.meta.tag.code'
    value: [ '"AOE"' ]

  # This is populated as a sender transform in the Covid pipeline
  - name: sr-ordering-facility-name-type-code
    bundleProperty: '%serviceRequest.requester.resolve().organization.resolve().extension("https://reportstream.cdc.gov/fhir/StructureDefinition/organization-name-type").valueCoding.code'
    value: [ '"L"' ]

  #  Simple report is not sending a unique Specimen identifier, grabbing it from Diagnostic Report
  #  STLTs use SPM identifier as their Accession number to uniquely identify reports sent to them
  - name: sr-specimen-identifier
    bundleProperty: '%diagnosticReport.specimen.resolve().identifier.value'
    value: [ '%diagnosticReport.identifier.value' ]

  # The Covid pipeline checks if this is a valid NPI and adds the NPI identifier type if it is
  - name: sr-ordering-provider-id-authority-type
    condition: '%resource.identifier.value.empty().not()'
    resource: 'Bundle.entry.resource.ofType(Practitioner)'
    bundleProperty: '%resource.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/identifier-type").valueCodeableConcept.coding.code'
    value: [ '"NPI"' ]

  # This is populated as a sender transform in the Covid pipeline
  - name: sr-ordering-provider-name-type-code
    condition: '%resource.name.use.exists().not()'
    resource: 'Bundle.entry.resource.ofType(Practitioner)'
    bundleProperty: '%resource.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/xcn10-name-type-code").value[x]'
    value: [ '"L"' ]

  # This were being populated as CA Receiver transforms, but should be Sender Transforms
  - name: sr-patient-assigning-facility-name
    bundleProperty: '%patient.identifier.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/assigning-facility-namespace-id").value[x]'
    value: [ '%diagnosticReport.basedOn.resolve().performer.resolve().name' ]

  - name: sr-patient-assigning-facility-id
    bundleProperty: '%patient.identifier.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/assigning-facility-universal-id").value[x]'
    value: [ '%diagnosticReport.basedOn.resolve().performer.resolve().identifier.value' ]

  - name: sr-patient-telecom
    resource: '%patient.telecom'
    resourceIndex: telecomIndex
    schema: datatypes/simple-report-telecom

  # Covid pipeline populates this by looking at the hl70005 value-set version
  - name: sr-patient-race-version
    resource: '%patient.extension("http://ibm.com/fhir/cdm/StructureDefinition/local-race-cd").value'
    bundleProperty: '%resource.coding.version'
    value: [ '"2.5.1"' ]

  # This is populated as a sender transform in the Covid pipeline
  - name: sr-patient-name-type
    bundleProperty: '%patient.name.use'
    value: [ '"official"' ]

  # Covid pipeline populates this by looking at the hl70189 value-set version
  - name: sr-patient-ethnic-group-version
    resource: '%patient.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/ethnic-group").value'
    bundleProperty: '%resource.coding.version'
    value: [ '"2.9"' ]

  # Covid pipeline populates this by looking at the hl70078 value-set version
  - name: sr-observation-abnormal-flag-version
    condition: '%resource.interpretation.empty().not()'
    resource: 'Bundle.entry.resource.ofType(Observation)'
    bundleProperty: '%resource.interpretation.coding.version'
    value: [ '"2.7"' ]

  # Covid pipeline populates this by looking at the hl70078 value-set version
  - name: sr-specimen-type-version
    condition: '%resource.type.empty().not()'
    resource: 'Bundle.entry.resource.ofType(Specimen)'
    bundleProperty: '%resource.type.coding.version'
    value: [ '"2.67"' ]

  # Covid pipeline populates this by looking at the sender-automation/aoe value-set version
  # But some AOEs have different versions, we need the ability to lookup that version
  # So the current solution is to move the sender-automation/aoe to the sender_automation_value_set_row lookup table
  - name: sr-observation-code-version
    resource: 'Bundle.entry.resource.ofType(Observation)'
    condition: '%resource.code.coding.exists()'
    bundleProperty: '%resource.code.coding.version'
    value: [ '%resource.code.coding.code' ]
    valueSet:
      lookupTable:
        tableName: sender_automation_value_set_row
        keyColumn: code
        valueColumn: version

  # Covid pipeline populates this date using a sender transform
  - name: sr-observation-date
    resource: 'Bundle.entry.resource.ofType(Observation)'
    condition: '%resource.effective.exists().not()'
    bundleProperty: '%resource.effective[x]'
    value: [ 'Bundle.entry.resource.ofType(Specimen).collection.collected' ]

  - name: sr-observation-date-extension
    resource: 'Bundle.entry.resource.ofType(Observation)'
    bundleProperty: '%resource.effective.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/hl7v2-date-time").value[x]'
    value: [ 'Bundle.entry.resource.ofType(Specimen).collection.collected' ]

  - name: sr-performing-organization-name-non-pracrole-assigning-authority
    condition: '%resource.performer.resolve().ofType(Organization).exists()'
    resource: 'Bundle.entry.resource.ofType(Observation)'
    bundleProperty: '%resource.performer.resolve().ofType(Organization).identifier[0].extension("https://reportstream.cdc.gov/fhir/StructureDefinition/assigning-authority").extension("https://reportstream.cdc.gov/fhir/StructureDefinition/namespace-id").value[x]'
    value: [ '%resource.performer.resolve().ofType(Organization).identifier[0].extension("https://reportstream.cdc.gov/fhir/StructureDefinition/assigning-authority").extension("https://reportstream.cdc.gov/fhir/StructureDefinition/namespace-id").value[x].getIdType()' ]

  # Covid pipeline populates this using a sender transform
  - name: sr-performing-organization-name-non-pracrole-assigning-authority-id
    condition: '%resource.performer.resolve().ofType(Organization).exists()'
    resource: 'Bundle.entry.resource.ofType(Observation)'
    bundleProperty: '%resource.performer.resolve().ofType(Organization).identifier[0].extension("https://reportstream.cdc.gov/fhir/StructureDefinition/assigning-authority").extension("https://reportstream.cdc.gov/fhir/StructureDefinition/universal-id").value[x]'
    value: [ '"2.16.840.1.113883.4.7"' ]

  - name: sr-performing-organization-name-non-pracrole-assigning-authority-id-type
    condition: '%resource.performer.resolve().ofType(Organization).exists()'
    resource: 'Bundle.entry.resource.ofType(Observation)'
    bundleProperty: '%resource.performer.resolve().ofType(Organization).identifier[0].extension("https://reportstream.cdc.gov/fhir/StructureDefinition/assigning-authority").extension("https://reportstream.cdc.gov/fhir/StructureDefinition/universal-id-type").value[x]'
    value: [ '"ISO"' ]


  - name: sr-performing-organization-name-non-pracrole-namespace
    condition: 'Bundle.entry.resource.ofType(Observation).performer.resolve().ofType(Organization).exists()'
    resource: 'Bundle.entry.resource.ofType(Observation).performer.resolve().ofType(Organization).identifier.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/assigning-authority")'
    bundleProperty: '%resource.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/namespace-id").value[x]'
    value: [ 'Bundle.entry.resource.ofType(Observation).performer.resolve().ofType(Organization).identifier[0].value.getIdType()' ]

  - name: sr-performing-organization-identifier-type-code-system
    condition: '%resource.exists() and %resource.identifier.type.where(coding.system = "http://terminology.hl7.org/CodeSystem/v2-0203").exists().not()'
    resource: 'Bundle.entry.resource.ofType(Observation).performer.resolve().ofType(Organization)'
    bundleProperty: '%resource.identifier[1].type.coding.system'
    value: [ '"http://terminology.hl7.org/CodeSystem/v2-0203"' ]

  - name: sr-performing-organization-identifier-type-code
    condition: 'Bundle.entry.resource.ofType(Observation).performer.resolve().ofType(Organization).exists() and %resource.coding.code.exists().not()'
    resource: 'Bundle.entry.resource.ofType(Observation).performer.resolve().ofType(Organization).identifier.type.where(coding.system = "http://terminology.hl7.org/CodeSystem/v2-0203")'
    bundleProperty: '%resource.coding.code'
    value: [ '"XX"' ]

  - name: sr-observation-code-display
    condition: '%resource.code.coding[0].display.empty() and %resource.code.text.empty().not()'
    resource: 'Bundle.entry.resource.ofType(Observation)'
    bundleProperty: '%resource.code.coding[0].display'
    value: [ '%resource.code.text' ]

  # Populating display based on text
  - name: sr-patient-race-display
    resource: '%patient.extension("http://ibm.com/fhir/cdm/StructureDefinition/local-race-cd").value'
    bundleProperty: '%resource.coding[0].display'
    value: [ '%resource.text' ]

  - name: sr-patient-deceased-indicator-default
    condition: '%resource.deceased.exists().not()'
    resource: 'Bundle.entry.resource.ofType(Patient)'
    bundleProperty: '%resource.deceased[x]'
    value: [ 'false' ]

  # Populating display based on text
  - name: sr-specimen-type-display
    resource: 'Bundle.entry.resource.ofType(Specimen)'
    condition: '%resource.type.exists() and %resource.type.coding[0].display.exists().not()'
    bundleProperty: '%resource.type.coding[0].display'
    value: [ '%resource.type.text' ]

  - name: sr-observation-producer-id-identifier
    resource: 'Bundle.entry.resource.ofType(Observation)'
    bundleProperty: '%resource.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/producer-id").value[x]'
    value: [ '%diagnosticReport.basedOn.resolve().performer' ]

  - name: sr-observation-producer-id-identifier
    resource: 'Bundle.entry.resource.ofType(Observation)'
    condition: '%resource.performer.exists().not()'
    bundleProperty: '%resource.performer'
    value: [ '%diagnosticReport.basedOn.resolve().performer' ]

  - name: sr-observation-producer-id-hl7use
    resource: 'Bundle.entry.resource.ofType(Observation).performer.resolve()'
    bundleProperty: '%resource.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/hl7-use")[1].value[x]'
    value: [ '"obx-15-producer-id"' ]

  - name: sr-observation-performing-org-hl7use
    resource: 'Bundle.entry.resource.ofType(Observation).performer.resolve()'
    bundleProperty: '%resource.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/hl7-use")[0].value[x]'
    value: [ '"obx-25-performing-organization"' ]

  - name: sr-observation-producer-id-cwe-identifier
    resource: 'Bundle.entry.resource.ofType(Observation).performer.resolve()'
    bundleProperty: '%resource.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/cwe-organization").valueCodeableConcept.coding.code'
    value: [ '%resource.identifier.value' ]

  - name: sr-observation-producer-id-cwe-display
    resource: 'Bundle.entry.resource.ofType(Observation).performer.resolve()'
    bundleProperty: '%resource.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/cwe-organization").valueCodeableConcept.coding.display'
    value: [ '%resource.name' ]

  - name: sr-observation-producer-id-cwe-system
    resource: 'Bundle.entry.resource.ofType(Observation).performer.resolve()'
    bundleProperty: '%resource.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/cwe-organization").valueCodeableConcept.coding.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/cwe-coding-system").value[x]'
    value: [ '%resource.identifier.type.coding.code' ]

  - name: sr-observation-producer-id-cwe-coding
    resource: 'Bundle.entry.resource.ofType(Observation).performer.resolve()'
    bundleProperty: '%resource.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/cwe-organization").valueCodeableConcept.coding.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/cwe-coding").value[x]'
    value: [ '"coding"' ]

  - name: sr-observation-producer-id-system
    bundleProperty: '%diagnosticReport.basedOn.resolve().performer.resolve().identifier[0].extension("https://reportstream.cdc.gov/fhir/StructureDefinition/coding-system").valueCodeableConcept.coding.code'
    value: [ '%diagnosticReport.basedOn.resolve().performer.resolve().identifier[0].value.getIdType()' ]

  - name: sr-ordering-facility-phone
    resource: '%diagnosticReport.basedOn.resolve().requester.resolve().organization.resolve().contact[0].telecom'
    resourceIndex: telecomIndex
    schema: datatypes/simple-report-telecom

  - name: sr-ordering-facility-telecom
    condition: '%diagnosticReport.basedOn.resolve().requester.resolve().organization.resolve().contact.empty()'
    resource: '%diagnosticReport.basedOn.resolve().requester.resolve().organization.resolve().telecom'
    resourceIndex: telecomIndex
    schema: datatypes/simple-report-telecom

  # To populate SPM-2 appropriately, we need to overwrite the existing specimen.identifier[0]
  # The value that exists in there is not used anywhere in the expected HL7 while the expected
  # values can be found in the diagnostic report and its referenced organization
  - name: sr-specimen-placer-assigned-identifier-value
    bundleProperty: '%specimen.identifier[0].value'
    value: [ '%diagnosticReport.id' ]

  - name: sr-specimen-placer-assigned-identifier-type-coding-code
    bundleProperty: '%specimen.identifier[0].type.coding[0].code'
    value: [ '"PGN"' ]

  - name: sr-specimen-placer-assigned-identifier-type-coding-system
    bundleProperty: '%specimen.identifier[0].type.coding[0].system'
    value: [ '"http://terminology.hl7.org/CodeSystem/v2-0203"' ]

  - name: sr-specimen-placer-assigned-identifier-namespace-id
    bundleProperty: '%specimen.identifier[0].extension("https://reportstream.cdc.gov/fhir/StructureDefinition/namespace-id").value[x]'
    value: [ '%diagnosticReport.basedOn.resolve().performer.resolve().name' ]

  - name: sr-specimen-placer-assigned-identifier-universal-id
    bundleProperty: '%specimen.identifier[0].extension("https://reportstream.cdc.gov/fhir/StructureDefinition/universal-id").value[x]'
    value: [ '%diagnosticReport.basedOn.resolve().performer.resolve().identifier[0].value' ]

  - name: sr-specimen-placer-assigned-identifier-universal-id-type
    bundleProperty: '%specimen.identifier[0].extension("https://reportstream.cdc.gov/fhir/StructureDefinition/universal-id-type").value[x]'
    value: [ '%diagnosticReport.basedOn.resolve().performer.resolve().identifier[0].type.coding[0].code' ]

  - name: sr-specimen-placer-assigned-identifier-hl7-use
    bundleProperty: '%specimen.identifier[0].extension("https://reportstream.cdc.gov/fhir/StructureDefinition/hl7-use").value[x]'
    value: [ '"specimen-id-placer"' ]

  - name: sr-specimen-placer-assigned-identifier-filler-extension-identifier-value
    bundleProperty: '%specimen.identifier[0].extension("https://reportstream.cdc.gov/fhir/StructureDefinition/filler-assigned-identifier").extension("https://reportstream.cdc.gov/fhir/StructureDefinition/entity-identifier").value[x]'
    value: [ '%diagnosticReport.id' ]

  - name: sr-specimen-placer-assigned-identifier-filler-extension-identifier-namespace-id
    bundleProperty: '%specimen.identifier[0].extension("https://reportstream.cdc.gov/fhir/StructureDefinition/filler-assigned-identifier").extension("https://reportstream.cdc.gov/fhir/StructureDefinition/namespace-id").value[x]'
    value: [ '%diagnosticReport.basedOn.resolve().performer.resolve().name' ]

  - name: sr-specimen-placer-assigned-identifier-filler-extension-identifier-universal-id
    bundleProperty: '%specimen.identifier[0].extension("https://reportstream.cdc.gov/fhir/StructureDefinition/filler-assigned-identifier").extension("https://reportstream.cdc.gov/fhir/StructureDefinition/universal-id").value[x]'
    value: [ '%diagnosticReport.basedOn.resolve().performer.resolve().identifier[0].value' ]

  - name: sr-specimen-placer-assigned-identifier-filler-extension-identifier-universal-id-type
    bundleProperty: '%specimen.identifier[0].extension("https://reportstream.cdc.gov/fhir/StructureDefinition/filler-assigned-identifier").extension("https://reportstream.cdc.gov/fhir/StructureDefinition/universal-id-type").value[x]'
    value: [ '%diagnosticReport.basedOn.resolve().performer.resolve().identifier[0].type.coding[0].code' ]



  # Service Request

  ## Placer Order
  - name: sr-service-request-placer-order
    bundleProperty: '%serviceRequest.identifier'
    value: [ '%diagnosticReport.identifier[1]' ]

  ## Filler Order
  - name: sr-service-request-filler-order
    bundleProperty: '%serviceRequest.identifier'
    value: [ '%diagnosticReport.identifier[0]' ]

  - name: sr-service-request-obr-placer-order-extension
    bundleProperty: '%serviceRequest.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/obr-observation-request").extension("obr-2-placer-order-number").value[x]'
    value: [ '%diagnosticReport.identifier[1]' ]

  - name: sr-service-request-obr-filler-order-extension
    bundleProperty: '%serviceRequest.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/obr-observation-request").extension("obr-3-filler-order-number").value[x]'
    value: [ '%diagnosticReport.identifier[0]' ]

  ## Code
  - name: sr-service-request-code-extension
    bundleProperty: '%serviceRequest.code.coding.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/cwe-coding").value[x]'
    value: [ '"coding"' ]

  ## Code
  - name: sr-service-request-code-system-extension
    bundleProperty: '%serviceRequest.code.coding.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/cwe-coding-system").value[x]'
    value: [ '%serviceRequest.code.coding.system.getCodingSystemMapping()' ]

  ## Requester
  - name: sr-service-request-requester-telecom
    resource: '%serviceRequest.requester.resolve().practitioner.resolve().telecom'
    resourceIndex: telecomIndex
    schema: datatypes/simple-report-telecom

  - name: sr-service-request-requester-callback-number-extension
    bundleProperty: '%serviceRequest.requester.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/callback-number").value[x]'
    value: [ '%serviceRequest.requester.resolve().practitioner.resolve().telecom[0]' ]

  - name: sr-order-requester-callback-number-hl7-use
    bundleProperty: '%serviceRequest.requester.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/callback-number").valueContactPoint.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/hl7v2Name").value[x]'
    value: [ '"orc-14-callback-phone-number"' ]

  - name: sr-order-requester-hl7-use-orc-12
    bundleProperty: '%serviceRequest.requester.resolve().practitioner.resolve().extension("https://reportstream.cdc.gov/fhir/StructureDefinition/hl7v2Name").value[x]'
    value: [ '"orc-12-ordering-provider"' ]

  - name: sr-order-requester-given-name
    bundleProperty: '%serviceRequest.requester.resolve().practitioner.resolve().extension("https://reportstream.cdc.gov/fhir/StructureDefinition/xcn3-given-name").value[x]'
    value: [ '%serviceRequest.requester.resolve().practitioner.resolve().name.given[0]' ]

  - name: sr-order-requester-second-given-name
    bundleProperty: '%serviceRequest.requester.resolve().practitioner.resolve().extension("https://reportstream.cdc.gov/fhir/StructureDefinition/xcn4-second-given-name").value[x]'
    value: [ '%serviceRequest.requester.resolve().practitioner.resolve().name.given[1]' ]

  - name: sr-service-request-obr-ordering-provider-extension
    bundleProperty: '%serviceRequest.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/obr-observation-request").extension("obr-16-ordering-provider").value[x]'
    value: [ '%serviceRequest.requester.resolve().practitioner' ]

  - name: sr-service-request-obr-callback-number-extension
    bundleProperty: '%serviceRequest.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/obr-observation-request").extension("https://reportstream.cdc.gov/fhir/StructureDefinition/callback-number").value[x]'
    value: [ '%serviceRequest.requester.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/callback-number").value' ]

  - name: sr-service-request-requester-address-street
    bundleProperty: '%serviceRequest.requester.resolve().practitioner.resolve().address.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/xad1-sad1-street-or-mailing-address").value[x]'
    value: [ '%serviceRequest.requester.resolve().practitioner.resolve().address.line[0]' ]

  # order-effective-date
  - name: sr-service-request-orc-order-effective-date
    bundleProperty: '%serviceRequest.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/orc-common-order").extension("orc-15-order-effective-date").value[x]'
    value: [ '%serviceRequest.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/order-effective-date").value' ]



  # Organization
  - name: sr-organization-address-street
    resource: 'Bundle.entry.resource.ofType(Organization)'
    bundleProperty: '%resource.address.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/xad1-sad1-street-or-mailing-address").value[x]'
    value: [ '%resource.address.line[0]' ]

  - name: sr-organization-address-street-dwelling
    resource: 'Bundle.entry.resource.ofType(Organization)'
    bundleProperty: '%resource.address.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/xad2-other-designation").value[x]'
    value: [ '%resource.address.line[1]' ]

  - name: sr-organization-identifier
    resource: 'Bundle.entry.resource.ofType(Organization)'
    bundleProperty: '%resource.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/xon10-organization-identifier").value[x]'
    value: [ '%resource.identifier[0].value' ]

  - name: sr-ordering-facility-name-type-code-coding-hl7-name
    bundleProperty: '%serviceRequest.requester.resolve().organization.resolve().extension("https://reportstream.cdc.gov/fhir/StructureDefinition/organization-name-type").valueCoding.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/cwe-coding").valueCodeableConcept.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/hl7v2Name").value[x]'
    value: [ '"organization-name-type-code"' ]

  - name: sr-ordering-facility-name-type-code-coding-type
    bundleProperty: '%serviceRequest.requester.resolve().organization.resolve().extension("https://reportstream.cdc.gov/fhir/StructureDefinition/organization-name-type").valueCoding.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/cwe-coding").valueCodeableConcept.coding.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/cwe-coding").value[x]'
    value: [ '"coding"' ]

  - name: sr-ordering-facility-name-type-code-coding-name
    bundleProperty: '%serviceRequest.requester.resolve().organization.resolve().extension("https://reportstream.cdc.gov/fhir/StructureDefinition/organization-name-type").valueCoding.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/cwe-coding").valueCodeableConcept.coding.code'
    value: [ '"L"' ]

  # Diagnostic Report

  ## results-rpt-status-change-datetime
  - name: sr-diagnostic-report-obr-results-rpt-status-change-datetime
    resource: '%diagnosticReport.issued'
    bundleProperty: '%resource.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/hl7v2-date-time").value[x]'
    value: [ '%diagnosticReport.issued' ]

  - name: sr-diagnostic-report-effective-date-time
    resource: '%diagnosticReport.effective'
    bundleProperty: '%resource.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/hl7v2-date-time").value[x]'
    value: [ '%diagnosticReport.effective' ]


  # Observation
  - name: sr-observation-value-type-cwe
    resource: 'Bundle.entry.resource.ofType(Observation)'
    bundleProperty: '%resource.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/obx-observation").extension("obx-2-value-type").value[x]'
    value: [ '"CWE"' ]

  - name: sr-observation-status
    resource: 'Bundle.entry.resource.ofType(Observation)'
    bundleProperty: '%resource.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/obx-observation").extension("obx-11-observation-status").value[x]'
    value: [ '%resource.status' ]
    valueSet:
      values:
        registered: I
        preliminary: P
        final: F
        corrected: C
        amended: C
        entered-in-error: W

  - name: sr-observation-identifier-coding
    resource: 'Bundle.entry.resource.ofType(Observation)'
    bundleProperty: '%resource.code.coding.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/cwe-coding").value[x]'
    value: [ '"coding"' ]

  - name: sr-observation-identifier-coding-system
    resource: 'Bundle.entry.resource.ofType(Observation)'
    condition: '%resource.code.coding.system.exists() and %resource.code.coding.system.getCodingSystemMapping().exists()'
    bundleProperty: '%resource.code.coding.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/cwe-coding-system").value[x]'
    value: [ '%resource.code.coding.system.getCodingSystemMapping()' ]

  - name: sr-observation-value-coding
    resource: 'Bundle.entry.resource.ofType(Observation)'
    bundleProperty: '%resource.value.coding.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/cwe-coding").value[x]'
    value: [ '"coding"' ]

  - name: sr-observation-value-coding-system
    resource: 'Bundle.entry.resource.ofType(Observation)'
    condition: '%resource.value.coding.system.exists() and %resource.value.coding.system.getCodingSystemMapping().exists()'
    bundleProperty: '%resource.value.coding.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/cwe-coding-system").value[x]'
    value: [ '%resource.value.coding.system.getCodingSystemMapping()' ]

  - name: sr-observation-interpretation-coding
    resource: 'Bundle.entry.resource.ofType(Observation)'
    bundleProperty: '%resource.interpretation.coding.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/cwe-coding").value[x]'
    value: [ '"coding"' ]

  - name: sr-observation-interpretation-coding-system
    condition: '%resource.interpretation.coding.system.exists() and %resource.interpretation.coding.system.getCodingSystemMapping().exists()'
    resource: 'Bundle.entry.resource.ofType(Observation)'
    bundleProperty: '%resource.interpretation.coding.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/cwe-coding-system").value[x]'
    value: [ '%resource.interpretation.coding.system.getCodingSystemMapping()' ]

  - name: sr-observation-method-coding
    resource: 'Bundle.entry.resource.ofType(Observation)'
    bundleProperty: '%resource.method.coding.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/cwe-coding").value[x]'
    value: [ '"coding"' ]

  - name: sr-observation-analysis-datetime
    resource: 'Bundle.entry.resource.ofType(Observation)'
    bundleProperty: '%resource.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/analysis-date-time").value[x]'
    value: [ '%resource.issued' ]

  - name: sr-observation-analysis-datetime-extension
    resource: 'Bundle.entry.resource.ofType(Observation)'
    bundleProperty: '%resource.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/analysis-date-time").value.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/hl7v2-date-time").value[x]'
    value: [ '%resource.issued' ]
