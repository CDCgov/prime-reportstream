extends: ../default-sender-transform
elements:

  - name: sr-observation-request-identifier-filler
    bundleProperty: 'Bundle.entry.resource.ofType(DiagnosticReport).identifier[0].type.coding.code'
    value: [ '"FILL"' ]

  - name: sr-observation-request-identifier-filler-system
    bundleProperty: 'Bundle.entry.resource.ofType(DiagnosticReport).identifier[0].system'
    value: [ 'Bundle.entry.resource.ofType(DiagnosticReport).basedOn.resolve().performer.resolve().name' ]

  - name: sr-observation-request-identifier-filler-id
    bundleProperty: 'Bundle.entry.resource.ofType(DiagnosticReport).identifier[0].extension("https://reportstream.cdc.gov/fhir/StructureDefinition/universal-id").value[x]'
    value: [ 'Bundle.entry.resource.ofType(DiagnosticReport).basedOn.resolve().performer.resolve().identifier.value' ]

  - name: sr-observation-request-identifier-placer
    bundleProperty: 'Bundle.entry.resource.ofType(DiagnosticReport).identifier[1].type.coding.code'
    value: [ '"PLAC"' ]

  - name: sr-observation-request-identifier-placer-value
    bundleProperty: 'Bundle.entry.resource.ofType(DiagnosticReport).identifier[1].value'
    value: [ 'Bundle.entry.resource.ofType(DiagnosticReport).identifier[0].value' ]

  - name: sr-observation-request-identifier-placer-system
    bundleProperty: 'Bundle.entry.resource.ofType(DiagnosticReport).identifier[1].system'
    value: [ 'Bundle.entry.resource.ofType(DiagnosticReport).basedOn.resolve().performer.resolve().name' ]

  - name: sr-observation-request-identifier-placer-id
    bundleProperty: 'Bundle.entry.resource.ofType(DiagnosticReport).identifier[1].extension("https://reportstream.cdc.gov/fhir/StructureDefinition/universal-id").value[x]'
    value: [ 'Bundle.entry.resource.ofType(DiagnosticReport).basedOn.resolve().performer.resolve().identifier.value' ]

  - name: sr-patient-assigning-facility-name
    bundleProperty: 'Bundle.entry.resource.ofType(Patient).identifier.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/assigning-facility-namespace-id").value[x]'
    value: [ 'Bundle.entry.resource.ofType(DiagnosticReport).basedOn.resolve().performer.resolve().name' ]


  - name: sr-patient-assigning-facility-id
    bundleProperty: 'Bundle.entry.resource.ofType(Patient).identifier.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/assigning-facility-universal-id").value[x]'
    value: [ 'Bundle.entry.resource.ofType(DiagnosticReport).basedOn.resolve().performer.resolve().identifier.value' ]

  - name: sr-observation-request-identifier-placer-system
    bundleProperty: 'Bundle.entry.resource.ofType(DiagnosticReport).identifier[1].system'
    value: [ 'Bundle.entry.resource.ofType(DiagnosticReport).basedOn.resolve().performer.resolve().name' ]

  - name: sr-observation-request-identifier-placer-id
    bundleProperty: 'Bundle.entry.resource.ofType(DiagnosticReport).identifier[1].extension("https://reportstream.cdc.gov/fhir/StructureDefinition/universal-id").value[x]'
    value: [ 'Bundle.entry.resource.ofType(DiagnosticReport).basedOn.resolve().performer.resolve().identifier.value' ]

  - name: sr-supporting-info
    resource: 'Bundle.entry.resource.ofType(ServiceRequest).supportingInfo.resolve()'
    schema: sr-supporting-info
    resourceIndex: supportInfoIndex

  - name: sr-ordering-facility-name-type-code
    bundleProperty: 'Bundle.entry.resource.ofType(ServiceRequest).requester.resolve().organization.resolve().extension("https://reportstream.cdc.gov/fhir/StructureDefinition/organization-name-type").valueCoding.code'
    value: ['"L"']

  #  Simple report is not sending a unique Specimen identifier, grabbing it from Diagnostic Report
  #  STLTs use SPM identifier as their Accession number to uniquely identify reports sent to them
  - name: sr-specimen-identifier
    bundleProperty: 'Bundle.entry.resource.ofType(DiagnosticReport).specimen.resolve().identifier.value'
    value: [ 'Bundle.entry.resource.ofType(DiagnosticReport).identifier.value' ]

  - name: sr-ordering-provider-id-authority-type
    condition: '%resource.identifier.value.empty().not()'
    resource: 'Bundle.entry.resource.ofType(Practitioner)'
    bundleProperty: '%resource.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/identifier-type").valueCodeableConcept.coding.code'
    value: [ '"NPI"' ]

  - name: sr-ordering-provider-name-type-code
    condition: '%resource.value.empty().not()'
    resource: 'Bundle.entry.resource.ofType(Practitioner)'
    bundleProperty: '%resource.name.use'
    value: [ '"official"' ]





