resourceType: Patient
# Represents data that needs to be extracted for a Patient Resource in FHIR
# reference: https://www.hl7.org/fhir/patient.html
id:
  type: STRING
  valueOf: "GeneralUtils.generateResourceId()"
  expressionType: JEXL

identifier:
  expressionType: nested
  generateList: true
  expressions:
    - condition: $pid2 NOT_NULL
      expressionType: resource
      specs: PID.2
      valueOf: datatypes/CX/Identifier
      vars:
        identifierIndexName: patient-id
        pid2: PID.2
    - condition: $pid3 NOT_NULL
      expressionType: resource
      specs: PID.3
      valueOf: datatypes/CX/Identifier
      generateList: true
      vars:
        identifierIndexName: patient-identifier-list
        pid3: PID.3
    - condition: $pid4 NOT_NULL
      expressionType: resource
      specs: PID.4
      valueOf: datatypes/CX/Identifier
      vars:
        identifierIndexName: alternate-patient-id
        pid4: PID.4

name:
  expressionType: nested
  generateList: true
  expressions:
    - condition: $pid9 NOT_NULL
      expressionType: resource
      specs: PID.5
      valueOf: datatypes/XPN/HumanName
      vars:
        hl7Use: patient-name
        pid9: PID.9
    - condition: $pid9 NOT_NULL
      expressionType: resource
      specs: PID.9
      valueOf: datatypes/XPN/HumanName
      vars:
        hl7Use: patient-alias
        pid9: PID.9

birthDate:
  expressionType: nested
  expressions:
    - type: DATE
      valueOf: PID.7
      expressionType: HL7Spec
    - condition: $pid7 NOT_NULL
      vars:
        pid7: PID.7
        dateTimeIn: PID.7, GeneralUtils.dateTimeWithZoneId(dateTimeIn,ZONEID)
        isTime: PID.7, GeneralUtils.dateTimeWithZoneId(isTime,ZONEID).length() > 10
        # util adds dashes between year and month and day extending length to 10 (yyyy-mm-dd)
      expressionType: nested
      expressionsMap:
        # this extension is needed to comply with the official HL7v2-to-FHIR mapping
        extension_1:
          condition: $dateTimeIn NOT_NULL && $isTime EQUALS "true"
          generateList: true
          expressionType: nested
          expressionsMap:
            url:
              type: SYSTEM_URL
              value: birthTime
            valueDateTime:
              valueOf: $dateTimeIn
              expressionType: HL7Spec
        # this extension is needed to reliably translate back to HL7 from FHIR
        extension_2:
          generateList: true
          expressionType: nested
          expressionsMap:
            url:
              type: SYSTEM_URL
              value: hl7v2-date-time
            valueString:
              type: STRING
              valueOf: $pid7
              expressionType: HL7Spec

gender:
  type: ADMINISTRATIVE_GENDER
  valueOf: PID.8
  expressionType: HL7Spec

address:
  condition: $pid11 NOT_NULL
  valueOf: datatypes/XAD/Address
  generateList: true
  expressionType: resource
  specs: PID.11
  vars:
    pid11: PID.11

telecom:
  expressionType: nested
  expressions:
    - condition: $pid13 NOT_NULL
      valueOf: datatypes/XTN/ContactPoint
      generateList: true
      expressionType: resource
      specs: PID.13
      vars:
        pid13: PID.13
      constants:
        useCode: home
    - condition: $pid14 NOT_NULL
      valueOf: datatypes/XTN/ContactPoint
      generateList: true
      expressionType: resource
      specs: PID.14
      vars:
        pid14: PID.14
      constants:
        useCode: work

communication:
  expressionType: nested
  condition: $pid15 NOT_NULL
  vars:
    pid15: PID.15
  expressionsMap:
    language:
      valueOf: datatypes/CWE/CodeableConcept
      expressionType: resource
      specs: PID.15

maritalStatus:
  condition: $pid16 NOT_NULL
  vars:
    pid16: PID.16
  valueOf: datatypes/CWE/CodeableConcept
  expressionType: resource
  specs: PID.16

link:
  expressionType: nested
  expressionsMap:
    other:
      valueOf: datatypes/CX/RelatedPerson-mother
      expressionType: reference
      specs: PID.21
    type:
      type: STRING
      valueOf: "seealso"

multipleBirthBoolean:
  condition: $multipleBirthIndicator NOT_NULL && $birthOrder NULL
  type: BOOLEAN
  valueOf: PID.24
  expressionType: HL7Spec
  vars:
    multipleBirthIndicator: PID.24
    birthOrder: PID.25

multipleBirthInteger:
  condition: $birthOrder NOT_NULL
  type: INTEGER
  valueOf: PID.25
  expressionType: HL7Spec
  vars:
    birthOrder: PID.25

extension:
  expressionType: nested
  expressions:
    - condition: $pid6 NOT_NULL
      expressionType: nested
      vars:
        pid6: PID.6
      expressionMap:
        url:
          type: SYSTEM_URL
          value: mothersMaidenName
        valueString:
      valueHumanName:
        valueOf: datatypes/XPN/HumanName
        expressionType: resource
        specs: PID.6
    - condition: $pid10 NOT_NULL
      expressionType: nested
      specs: PID.10
      generateList: true
      vars:
        pid10: PID.10
      expressionsMap:
        url:
          type: SYSTEM_URL
          value: race
        valueCodeableConcept:
          valueOf: datatypes/CWE/CodeableConcept
          expressionType: resource
          specs: CWE
    - condition: $pid17 NOT_NULL
      expressionType: nested
      generateList: true
      vars:
        pid17: PID.17
      expressionsMap:
        url:
          type: SYSTEM_URL
          value: religion
        valueCodeableConcept:
          valueOf: datatypes/CWE/CodeableConcept
          expressionType: resource
          specs: PID.17
    - condition: $pid22 NOT_NULL
      expressionType: nested
      generateList: true
      vars:
        pid22: PID.22
      expressionsMap:
        url:
          type: SYSTEM_URL
          value: ethnic-group
        valueCodeableConcept:
          valueOf: datatypes/CWE/CodeableConcept
          expressionType: resource
          specs: PID.22
    - condition: $pid23 NOT_NULL
      expressionType: nested
      generateList: true
      vars:
        pid23: PID.23
      expressionsMap:
        url:
          type: SYSTEM_URL
          value: patient-birthPlace
        valueAddress:
          expressionType: nested
          expressionsMap:
            text:
              valueOf: PID.23
              type: STRING
    - expressionType: nested
      expressionsMap:
        url:
          type: STRING
          value: pid-patient
        extension:
          expressionType: nested
          expressions:
            - expressionType: nested
              expressionsMap:
                url:
                  type: STRING
                  value: pid-24-multiple-birth-indicator
                valueString:
                  type: STRING
                  valueOf: PID.24
                  expressionType: HL7Spec
    - expressionType: nested
      condition: $citizenship NOT_NULL
      generateList: true
      vars:
        citizenship: STRING_ALL, PID.26
      constants:
        hl7v2Name: "citizenship"
      expressionsMap:
        url:
          type: SYSTEM_URL
          value: patient-citizenship
        extension:
          generateList: true
          expressionType: nested
          expressionsMap:
            url:
              type: SYSTEM_URL
              value: code
            valueCodeableConcept:
              valueOf: datatypes/CWE/CodeableConcept
              expressionType: resource
              specs: PID.26
    - expressionType: nested
      condition: $tribalCitizenship NOT_NULL
      generateList: true
      vars:
        tribalCitizenship: STRING_ALL, PID.39
      constants:
        hl7v2Name: "tribal-citizenship"
      expressionsMap:
        url:
          type: SYSTEM_URL
          value: patient-citizenship
        extension:
          generateList: true
          expressionType: nested
          expressionsMap:
            url:
              type: SYSTEM_URL
              value: code
            valueCodeableConcept:
              valueOf: datatypes/CWE/CodeableConcept
              expressionType: resource
              specs: PID.39