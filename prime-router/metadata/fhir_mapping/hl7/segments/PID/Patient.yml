resourceType: Patient
# Represents data that needs to be extracted for a Patient Resource in FHIR
# reference: https://www.hl7.org/fhir/patient.html
id:
  type: STRING
  valueOf: "GeneralUtils.generateResourceId()"
  expressionType: JEXL

identifier:
  expressionType: nested
  generateList: true
  expressions:
    - condition: $pid2 NOT_NULL
      expressionType: resource
      specs: PID.2
      valueOf: datatypes/CX/Identifier
      vars:
        identifierIndexName: patient-id
        pid2: STRING_ALL, PID.2
    - condition: $pid3 NOT_NULL
      expressionType: resource
      specs: PID.3
      valueOf: datatypes/CX/Identifier
      generateList: true
      vars:
        identifierIndexName: patient-identifier-list
        pid3: STRING_ALL, PID.3
    - condition: $pid4 NOT_NULL
      expressionType: resource
      specs: PID.4
      valueOf: datatypes/CX/Identifier
      vars:
        identifierIndexName: alternate-patient-id
        pid4: STRING_ALL, PID.4

name:
  expressionType: nested
  generateList: true
  expressions:
    - condition: $pid9 NOT_NULL
      expressionType: resource
      specs: PID.5
      valueOf: datatypes/XPN/HumanName
      vars:
        hl7Use: patient-name
        pid9: STRING_ALL, PID.9
    - condition: $pid9 NOT_NULL
      expressionType: resource
      specs: PID.9
      valueOf: datatypes/XPN/HumanName
      vars:
        hl7Use: patient-alias
        pid9: STRING_ALL, PID.9

birthDate:
  type: DATE
  valueOf: PID.7
  expressionType: HL7Spec

_birthDate:
  condition: $pid7 NOT_NULL
  vars:
    pid7: PID.7
    dateTimeIn: PID.7, GeneralUtils.dateTimeWithZoneId(dateTimeIn,ZONEID)
    isTime: PID.7, GeneralUtils.dateTimeWithZoneId(isTime,ZONEID).length() > 10
  expressionType: nested
  expressionsMap:
    # this extension is needed to comply with the official HL7v2-to-FHIR mapping
    extension_1:
      condition: $dateTimeIn NOT_NULL && $isTime EQUALS "true"
      generateList: true
      expressionType: nested
      expressionsMap:
        url:
          type: SYSTEM_URL
          value: birthTime
        valueDateTime:
          valueOf: $dateTimeIn
          expressionType: HL7Spec
    # this extension is needed to reliably translate back to HL7 from FHIR
    extension_2:
      generateList: true
      expressionType: nested
      expressionsMap:
        url:
          type: SYSTEM_URL
          value: hl7v2-date-time
        valueString:
          type: STRING
          valueOf: $pid7
          expressionType: HL7Spec

gender:
  type: ADMINISTRATIVE_GENDER
  valueOf: PID.8
  expressionType: HL7Spec

address:
  condition: $pid11 NOT_NULL
  valueOf: datatypes/XAD/Address
  generateList: true
  expressionType: resource
  specs: PID.11
  vars:
    pid11: STRING_ALL, PID.11

telecom:
  expressionType: nested
  expressions:
    - condition: $pid13 NOT_NULL
      valueOf: datatypes/XTN/ContactPoint
      generateList: true
      expressionType: resource
      specs: PID.13
      vars:
        pid13: STRING_ALL, PID.13
      constants:
        useCode: home
    - condition: $pid14 NOT_NULL
      valueOf: datatypes/XTN/ContactPoint
      generateList: true
      expressionType: resource
      specs: PID.14
      vars:
        pid14: STRING_ALL, PID.14
      constants:
        useCode: work
    - condition: $pid40 NOT_NULL
      valueOf: datatypes/XTN/ContactPoint
      generateList: true
      expressionType: resource
      specs: PID.40
      vars:
        pid40: STRING_ALL, PID.40

communication:
  expressionType: nested
  condition: $pid15 NOT_NULL
  vars:
    pid15: STRING_ALL, PID.15
  expressionsMap:
    language:
      valueOf: datatypes/CWE/CodeableConcept
      expressionType: resource
      specs: PID.15

maritalStatus:
  condition: $pid16 NOT_NULL
  vars:
    pid16: STRING_ALL, PID.16
  valueOf: datatypes/CWE/CodeableConcept
  expressionType: resource
  specs: PID.16

link:
  expressionType: nested
  vars:
    pid21: STRING_ALL, PID.21
  expressionsMap:
    other:
      valueOf: datatypes/CX/RelatedPerson-mother
      expressionType: reference
      specs: PID.21
    type:
      type: STRING
      valueOf: "seealso"

multipleBirthBoolean:
  condition: $multipleBirthIndicator NOT_NULL && $birthOrder NULL
  type: BOOLEAN
  valueOf: PID.24
  expressionType: HL7Spec
  vars:
    multipleBirthIndicator: PID.24
    birthOrder: PID.25

multipleBirthInteger:
  condition: $birthOrder NOT_NULL
  type: INTEGER
  valueOf: PID.25
  expressionType: HL7Spec
  vars:
    birthOrder: PID.25

deceasedBoolean:
  condition: $deceasedBool NOT_NULL && $deceasedDateTime NULL
  type: BOOLEAN
  valueOf: PID.30
  expressionType: HL7Spec
  vars:
    deceasedBool: PID.30
    deceasedDateTime: PID.29

deceasedDateTime:
  condition: $dateTimeIn NOT_NULL
  type: STRING
  valueOf: "GeneralUtils.dateTimeWithZoneId(dateTimeIn,ZONEID)"
  expressionType: JEXL
  vars:
    dateTimeIn: PID.29

_deceasedDateTime:
  expressionType: nested
  condition: pid29 NOT_NULL
  vars:
    pid29: STRING, PID.29
  expressionsMap:
    extension_1:
      generateList: true
      expressionType: nested
      expressionsMap:
        url:
          type: SYSTEM_URL
          value: hl7v2-date-time
        valueString:
          type: STRING
          valueOf: $pid29
          expressionType: HL7Spec

meta:
  expressionType: nested
  expressionsMap:
    lastupdated:
      condition: $dateTimeIn NOT_NULL
      type: STRING
      valueOf: "GeneralUtils.dateTimeWithZoneId(dateTimeIn,ZONEID)"
      expressionType: JEXL
      vars:
        dateTimeIn: PID.33
    extension:
      condition: $pid34 NOT_NULL
      vars:
        pid34: STRING_ALL, PID.34
      expressionType: nested
      expressionsMap:
        url:
          type: STRING
          value: last-updated-facility-namespace-id
        valueReference:
          valueOf: datatypes/HD/Organization
          expressionType: reference
          specs: PID.34

generalPractitioner:
  condition: $patientPrimaryFacility NOT_NULL
  valueOf: datatypes/XON/Organization
  generateList: true
  expressionType: reference
  specs: PD1.3
  vars:
    patientPrimaryFacility: PD1.3

extension:
  expressionType: nested
  expressions:
    - expressionType: resource
      valueOf: segments/PID/PIDExtension
    - expressionType: resource
      valueOf: segments/PID/PD1Extension
    - condition: $pid6 NOT_NULL
      expressionType: nested
      vars:
        pid6: STRING_ALL, PID.6
      expressionMap:
        url:
          type: SYSTEM_URL
          value: mothersMaidenName
        valueHumanName:
          valueOf: datatypes/XPN/HumanName
          expressionType: resource
          specs: PID.6
    - condition: $pid10 NOT_NULL
      expressionType: nested
      specs: PID.10
      generateList: true
      vars:
        pid10: STRING_ALL, PID.10
      expressionsMap:
        url:
          type: SYSTEM_URL
          value: race
        valueCodeableConcept:
          valueOf: datatypes/CWE/CodeableConcept
          expressionType: resource
          specs: CWE
    - condition: $pid17 NOT_NULL
      expressionType: nested
      generateList: true
      vars:
        pid17: STRING_ALL, PID.17
      expressionsMap:
        url:
          type: SYSTEM_URL
          value: religion
        valueCodeableConcept:
          valueOf: datatypes/CWE/CodeableConcept
          expressionType: resource
          specs: PID.17
    - condition: $pid22 NOT_NULL
      expressionType: nested
      generateList: true
      vars:
        pid22: STRING_ALL, PID.22
      expressionsMap:
        url:
          type: SYSTEM_URL
          value: ethnic-group
        valueCodeableConcept:
          valueOf: datatypes/CWE/CodeableConcept
          expressionType: resource
          specs: PID.22
    - condition: $pid23 NOT_NULL
      expressionType: nested
      generateList: true
      vars:
        pid23: STRING_ALL, PID.23
      expressionsMap:
        url:
          type: SYSTEM_URL
          value: patient-birthPlace
        valueAddress:
          expressionType: nested
          expressionsMap:
            text:
              valueOf: PID.23
              type: STRING
    - expressionType: nested
      condition: $pid26 NOT_NULL
      generateList: true
      vars:
        PID26: STRING_ALL, PID.26
      constants:
        hl7v2Name: "citizenship"
      expressionsMap:
        url:
          type: SYSTEM_URL
          value: patient-citizenship
        extension:
          generateList: true
          expressionType: nested
          expressionsMap:
            url:
              type: SYSTEM_URL
              value: code
            valueCodeableConcept:
              valueOf: datatypes/CWE/CodeableConcept
              expressionType: resource
              specs: PID.26
    - expressionType: nested
      condition: $pid39 NOT_NULL
      generateList: true
      vars:
        pid39: STRING_ALL, PID.39
      constants:
        hl7v2Name: "tribal-citizenship"
      expressionsMap:
        url:
          type: SYSTEM_URL
          value: patient-citizenship
        extension:
          generateList: true
          expressionType: nested
          expressionsMap:
            url:
              type: SYSTEM_URL
              value: code
            valueCodeableConcept:
              valueOf: datatypes/CWE/CodeableConcept
              expressionType: resource
              specs: PID.39
    - condition: $pid27 NOT_NULL
      vars:
        pid27: STRING_ALL, PID.27
      expressionType: nested
      generateList: true
      expressionsMap:
        url:
          type: SYSTEM_URL
          value: veteran-military-status
        valueCodeableConcept:
          valueOf: datatypes/CWE/CodeableConcept
          expressionType: resource
          specs: PID.27
    - expressionType: nested
      condition: $pid28 NOT_NULL
      generateList: true
      vars:
        pid18: STRING_ALL, PID.28
      constants:
        hl7v2Name: "nationality"
      expressionsMap:
        url:
          type: SYSTEM_URL
          value: nationality
        extension:
          generateList: true
          expressionType: nested
          expressionsMap:
            url:
              type: SYSTEM_URL
              value: code
            valueCodeableConcept:
              valueOf: datatypes/CWE/CodeableConcept
              expressionType: resource
              specs: PID.28
    - condition: $pid31 NOT_NULL
      vars:
        pid31: STRING_ALL, PID.31
      expressionType: nested
      expressionsMap:
        url:
          type: STRING
          value: identity-unknown
        valueString:
          type: STRING
          valueOf: PID.31
          expressionType: HL7Spec
    - condition: $pid35 NOT_NULL || $pid36 NOT_NULL || $pid37 NOT_NULL
      vars:
        pid35: STRING_ALL, PID.35
        pid36: STRING_ALL, PID.36
        pid37: STRING, PID.37
      expressionType: nested
      generateList: true
      constants:
        hl7v2Name: "patient-animal"
      expressionsMap:
        url:
          type: SYSTEM_URL
          value: patient-animal
        extension:
          generateList: true
          expressionType: nested
          expressions:
            - condition: $pid35 NOT_NULL
              expressionType: nested
              expressionsMap:
                url:
                  type: STRING
                  value: species
                valueCodeableConcept:
                  valueOf: datatypes/CWE/CodeableConcept
                  expressionType: resource
                  specs: PID.35
            - condition: $pid36 NOT_NULL
              expressionType: nested
              expressionsMap:
                url:
                  type: STRING
                  value: breed
                valueCodeableConcept:
                  valueOf: datatypes/CWE/CodeableConcept
                  expressionType: resource
                  specs: PID.36
            - condition: $pid37 NOT_NULL
              expressionType: nested
              expressionsMap:
                url:
                  type: SYSTEM_URL
                  value: strain
                valueString:
                  type: STRING
                  valueOf: PID.37
                  expressionType: HL7Spec
    - condition: $pd15 NOT_NULL
      vars:
        pd15: STRING_ALL, PD1.5
      expressionType: nested
      generateList: true
      expressionsMap:
        url:
          type: SYSTEM_URL
          value: studentStatus
        valueCodeableConcept:
          valueOf: datatypes/CWE/CodeableConcept
          expressionType: resource
          specs: PD1.5
    - condition: $pd16 NOT_NULL
      vars:
        pd16: STRING_ALL, PD1.6
      expressionType: nested
      generateList: true
      expressionsMap:
        url:
          type: SYSTEM_URL
          value: patient-disability
        valueCodeableConcept:
          valueOf: datatypes/CWE/CodeableConcept
          expressionType: resource
          specs: PD1.6
    - condition: $pd17 NOT_NULL
      vars:
        pd17: STRING_ALL, PD1.7
      expressionType: nested
      generateList: true
      expressionsMap:
        url:
          type: SYSTEM_URL
          value: livingWill
        valueCodeableConcept:
          valueOf: datatypes/CWE/CodeableConcept
          expressionType: resource
          specs: PD1.7
    - condition: $pd114 NOT_NULL
      vars:
        pd114: STRING_ALL, PD1.14
      expressionType: nested
      expressionsMap:
        url:
          type: STRING
          value: patient-congregation
        valueString:
          valueOf: datatypes/CWE/CodeableConcept
          expressionType: resource
          specs: PD1.14