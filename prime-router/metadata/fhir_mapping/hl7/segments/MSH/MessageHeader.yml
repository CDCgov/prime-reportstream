resourceType: MessageHeader

id:
  type: NAMED_UUID
  valueOf: MSH.10
  expressionType: HL7Spec

eventCoding:
  expressionType: resource
  valueOf: datatypes/MSG/Coding
  specs: MSH.9
  required: true

meta:
  expressionType: resource
  valueOf: datatypes/PT/Meta
  specs: MSH.11
  vars:
    metaSecurity: STRING, MSH.8

source:
  expressionType: nested
  vars:
    msh3: STRING_ALL, MSH.3
    msh24: STRING_ALL, MSH.24
  expressions:
    - constants:
        messageHeaderSourceField: sending-application
      condition: $msh3 NOT_NULL
      valueOf: segments/MSH/datatypes/HD/Source
      expressionType: resource
      specs: MSH.3
    - constants:
        messageHeaderSourceField: sending-network-address
      condition: $msh3 NULL && $msh24 NOT_NULL
      valueOf: segments/MSH/datatypes/HD/Source
      expressionType: resource
      specs: MSH.24
    - condition: $msh24 NULL && $msh3 NULL
      valueOf: segments/MSH/segments/SFT/Source
      expressionType: resource
      specs: SFT


sender:
  condition: $msh4 NOT_NULL || $organizationCountry NOT_NULL
  valueOf: datatypes/HD/Organization
  expressionType: reference
  generateList: true
  specs: MSH.4
  vars:
    organizationCountry: MSH.17
    msh4: STRING_ALL, MSH.4

destination:
  vars:
    msh6: MSH.6
    msh23: MSH.23
    msh5: STRING_ALL, MSH.5
    msh25: STRING_ALL, MSH.25
  expressionType: nested
  generateList: true
  expressions:
    - constants:
        messageHeaderDestinationField: receiving-application
      condition: $msh5 NOT_NULL
      expressionType: resource
      valueOf: segments/MSH/datatypes/HD/Destination
      specs: MSH.5
    - constants:
        messageHeaderDestinationField: receiving-network-address
      condition: $msh25 NOT_NULL && $msh25 NOT_EQUALS $msh5
      valueOf: segments/MSH/datatypes/HD/Destination
      expressionType: resource
      specs: MSH.25
    - constants:
        messageHeaderDestinationField: receiving-network-address
      condition: $msh25 NOT_NULL && $msh5 NULL
      valueOf: segments/MSH/datatypes/HD/Destination
      expressionType: resource
      specs: MSH.25
    - expressionType: nested
      condition: $msh6 NOT_NULL && $msh5 NULL && $msh25 NULL
      constants:
        hdOrganizationHL7Use: receiving-facility
      expressionsMap:
        receiver:
          expressionType: reference
          valueOf: datatypes/HD/Organization
          specs: MSH.6
    - expressionType: nested
      condition: $msh6 NOT_NULL && $msh23 NOT_NULL
      constants:
        xonOrganizationHL7Use: receiving-responsible-organization
      expressionsMap:
        receiver:
          expressionType: reference
          valueOf: datatypes/XON/Organization
          specs: MSH.23

language:
  vars:
    cwe1: MSH.19.1
  expressionType: nested
  expressions:
    - condition: $cwe1 NOT_NULL
      valueOf: MSH.19.1
      type: STRING
      expressionType: HL7Spec
    - condition: $cwe1 NULL
      valueOf: MSH.19.4
      type: STRING
      expressionType: HL7Spec


# MSH.10 is captured in Bundle.Identifier
# MSH.12 is hardcoded to 2.5.1
extension_messageHeader:
  generateList: true
  expressionType: nested
  expressions:
    - condition: $msh2 NOT_NULL && $msh2 EQUALS_STRING ^~\&#
      expressionType: nested
      vars:
        msh2: String, MSH.2
      expressionsMap:
        url:
          type: SYSTEM_URL
          value: encoding-characters
        valueString:
          type: STRING
          valueOf: MSH.2
          expressionType: HL7Spec
    - expressionType: nested
      vars:
        msh7: MSH.7
      condition: $msh7 NOT_NULL
      expressionsMap:
        url:
          type: SYSTEM_URL
          value: msh-7-datetime-of-message
        valueString:
          type: STRING
          expressionType: HL7Spec
          valueOf: MSH.7
    - expressionType: nested
      vars:
        msh13: MSH.13
      expressionsMap:
        url:
          type: SYSTEM_URL
          value: msh-13-sequence-number
        valueString:
          type: STRING
          expressionType: HL7Spec
          valueOf: MSH.13
    - expressionType: nested
      vars:
        msh14: MSH.14
      expressionsMap:
        url:
          type: SYSTEM_URL
          value: msh-14-continuation-pointer
        valueString:
          type: STRING
          expressionType: HL7Spec
          valueOf: MSH.14
    - condition: $msh15 NOT_NULL
      expressionType: nested
      vars:
        msh15: MSH.15
      expressionsMap:
        url:
          type: SYSTEM_URL
          value: msh-15-accept-acknowledgement-type
        valueString:
          valueOf: MSH.15
          expressionType: HL7Spec
          type: STRING
    - condition: $msh16 NOT_NULL
      expressionType: nested
      vars:
        msh16: MSH.16
      expressionsMap:
        url:
          type: SYSTEM_URL
          value: msh-16-application-acknowledgement-type
        valueString:
          type: STRING
          valueOf: MSH.16
          expressionType: HL7Spec
    - vars:
        msh19: STRING_ALL, MSH.19
      condition: $msh19 NOT_NULL
      expressionType: nested
      expressionsMap:
        url:
          type: SYSTEM_URL
          value: msh-19-principal-language-of-message
        valueCodeableConcept:
          expressionType: resource
          valueOf: datatypes/CWE/CodeableConcept
          specs: MSH.19
    - vars:
        msh20: MSH.20
      condition: $msh20 NOT_NULL
      expressionType: nested
      expressionsMap:
        url:
          type: SYSTEM_URL
          value: msh-20-alternate-character-set-handling-scheme
        valueString:
          type: STRING
          expressionType: HL7Spec
          valueOf: MSH.20
    - vars:
        msh3: STRING_ALL, MSH.3
        msh24: STRING_ALL, MSH.24
      constants:
        extensionUrl: msh-24-hd-extension
      condition: $msh3 NOT_NULL && $msh24 NOT_NULL
      expressionType: resource
      valueOf: datatypes/HD/ExtensionHD
      specs: MSH.24
    - vars:
        msh5: STRING_ALL, MSH.5
        msh25: STRING_ALL, MSH.25
      constants:
        extensionUrl: msh-25-hd-extension
      condition: $msh5 EQUALS $msh25
      expressionType: resource
      valueOf: datatypes/HD/ExtensionHD
      specs: MSH.25

# TODO there is a bug in the library where if these are included in
# expressions array above only one value is generated
extension_1:
  expressionType: nested
  generateList: true
  specs: MSH.21
  expressionsMap:
    url:
      type: SYSTEM_URL
      value: msh21-source-message-profile-id
    valueIdentifier:
      generateList: true
      valueOf: datatype/Identifier_SystemID
      expressionType: resource

extension_2:
  condition: $msh18 NOT_NULL
  expressionType: nested
  generateList: true
  vars:
    msh18: STRING_ALL, MSH.18
  specs: MSH.18
  expressionsMap:
    url:
      type: SYSTEM_URL
      value: character-set
    valueString:
      generateList: true
      type: STRING
      valueOf: $BASE_VALUE
      expressionType: HL7Spec

responsible:
  vars:
    msh22: MSH.22
  condition: $msh22 NOT_NULL
  expressionType: reference
  valueOf: datatypes/XON/Organization
  specs: MSH.22
