resourceType: ServiceRequest

# Not Implementing
# ORC.7 deprecated in the NIST spec
# ORC.26 deprecated in the NIST spec
# ORC.32 not mapped, not in NIST spec
# ORC.34 not mapped, not in NIST spec
# OBR.5 deprecated in NIST spec
# OBR.6 deprecated in NIST spec
# OBR.30 deprecated in NIST spec
# OBR.37 deprecated in NIST spec
# OBR.38 deprecated in NIST spec
# OBR.40 deprecated in NIST spec
# OBR.41 deprecated in NIST spec
# OBR.42 deprecated in NIST spec
# OBR.43 deprecated in NIST spec
# OBR.54 not mapped, not in NIST

id:
  type: STRING
  valueOf: "GeneralUtils.generateResourceId()"
  expressionType: JEXL

status:
  type: SERVICE_REQUEST_STATUS
  default: "unknown"
  valueOf: ORC.5 | ORC.1
  expressionType: HL7Spec

intent:
  expressionType: nested
  vars:
    obr11: OBR.11
  expressions:
    - condition: $obr11 NOT_EQUALS G && $obr11 NOT_EQUALS A
      type: STRING
      value: "order"
    - condition: $obr11 EQUALS A
      type: STRING
      value: "#add-on#"
    - condition: $obr11 EQUALS G
      type: STRING
      value: "reflex-order"
_intent:
  expressionType: nested
  expressionsMap:
    extension:
      generateList: true
      expressionType: nested
      expressionsMap:
        url:
          type: SYSTEM_URL
          value: obr-11-specimen-action-code
        valueId:
          type: STRING
          valueOf: OBR.11
          expressionType: HL7Spec


identifier:
  expressionType: nested
  generateList: true
  vars:
    obr2: STRING_ALL, OBR.2
    orc2: STRING_ALL, ORC.2
    obr3: STRING_ALL, OBR.3
    orc3: STRING_ALL, ORC.3
    orc4: STRING_ALL, ORC.4
    obr53: STRING_ALL, OBR.53
    orc33: STRING_ALL, ORC.33
  expressions:
    - condition: $orc2 NOT_NULL
      valueOf: datatypes/EI/Identifier
      expressionType: resource
      specs: ORC.2
      constants:
        code: "PLAC"
        system: "http://terminology.hl7.org/CodeSystem/v2-0203"
        display: "Placer Identifier"
        hl7Use: "orc-2-placer-order-number"
    - condition: $orc2 NULL && $obr2 NOT_NULL
      valueOf: datatypes/EI/Identifier
      expressionType: resource
      specs: OBR.2
      constants:
        code: "PLAC"
        system: "http://terminology.hl7.org/CodeSystem/v2-0203"
        display: "Placer Identifier"
        hl7Use: "obr-2-placer-order-number"
    - condition: $orc3 NOT_NULL
      valueOf: datatypes/EI/Identifier
      expressionType: resource
      specs: ORC.3
      constants:
        system: "http://terminology.hl7.org/CodeSystem/v2-0203"
        code: "FILL"
        display: "Filler Identifier"
        hl7Use: "orc-3-filler-order-number"
    - condition: $orc3 NULL && $obr3 NOT_NULL
      valueOf: datatypes/EI/Identifier
      expressionType: resource
      specs: OBR.3
      constants:
        system: "http://terminology.hl7.org/CodeSystem/v2-0203"
        code: "FILL"
        display: "Filler Identifier"
        hl7Use: "obr-3-filler-order-number"
    - condition: $orc4 NOT_NULL
      valueOf: datatypes/EI/Identifier
      expressionType: resource
      specs: ORC.4
      constants:
        system: "http://terminology.hl7.org/CodeSystem/v2-0203"
        code: "PGN"
        hl7Use: "orc-4-placer-group-number"
    - condition: $orc4 NOT_NULL
      valueOf: datatypes/EI/Identifier
      expressionType: resource
      specs: ORC.4
      constants:
        system: "http://terminology.hl7.org/CodeSystem/v2-0203"
        code: "FGN"
        hl7Use: "orc-4-placer-group-number"
    - condition: $orc33 NOT_NULL
      valueOf: datatypes/CX/Identifier
      expressionType: resource
      specs: ORC.33
      constants:
        identifierIndexName: "orc-33-alternate-placer-order-number"
    - condition: $orc33 NULL && $obr53 NOT_NULL
      valueOf: datatypes/CX/Identifier
      expressionType: resource
      specs: OBR.53
      constants:
        identifierIndexName: "obr-53-alternate-placer-order-number"

code:
  valueOf: datatypes/cwe/CodeableConcept
  expressionType: resource
  specs: OBR.4

occurrenceDateTime:
  vars:
    obr6: OBR.6
  valueOf: "GeneralUtils.dateTimeWithZoneId(obr6,ZONEID)"
  expressionType: JEXL

_occurrenceDateTime:
  vars:
    obr6: STRING,OBR.6
  condition: $obr6 NOT_NULL
  expressionType: nested
  expressionsMap:
    extension:
      generateList: true
      expressionType: nested
      expressionsMap:
        url:
          type: SYSTEM_URL
          value: hl7v2-date-time
        valueString:
          type: STRING
          valueOf: OBR.6
          expressionType: HL7Spec

occurrencePeriod:
  expressionType: nested
  vars:
    obr7: OBR.7
    obr8: OBR.8
  condition: $obr7 NOT_NULL || $obr8 NOT_NULL
  expressionsMap:
    start:
      valueOf: "GeneralUtils.dateTimeWithZoneId(obr7,ZONEID)"
      expressionType: JEXL
    _start:
      expressionType: nested
      condition: $obr7 NOT_NULL
      expressionsMap:
        extension_1:
          generateList: true
          expressionType: nested
          expressionsMap:
            url:
              type: SYSTEM_URL
              value: hl7v2-date-time
            valueString:
              type: STRING
              valueOf: $obr7
              expressionType: HL7Spec
    end:
      valueOf: "GeneralUtils.dateTimeWithZoneId(obr8,ZONEID)"
      expressionType: JEXL
    _end:
      expressionType: nested
      condition: $obr7 NOT_NULL
      expressionsMap:
        extension_1:
          generateList: true
          expressionType: nested
          expressionsMap:
            url:
              type: SYSTEM_URL
              value: hl7v2-date-time
            valueString:
              type: STRING
              valueOf: $obr8
              expressionType: HL7Spec

authoredOn:
  condition: $orderControl EQUALS NW
  type: STRING
  valueOf: "GeneralUtils.dateTimeWithZoneId(dateTimeIn,ZONEID)"
  expressionType: JEXL
  vars:
    dateTimeIn: ORC.9
    orderControl: String, ORC.1
_authoredOn:
  expressionType: nested
  condition: $orderControl EQUALS NW && $dateTimeIn NOT_NULL
  vars:
    dateTimeIn: ORC.9
    orderControl: String, ORC.1
  expressionsMap:
    extension_1:
      generateList: true
      expressionType: nested
      expressionsMap:
        url:
          type: SYSTEM_URL
          value: hl7v2-date-time
        valueString:
          type: STRING
          valueOf: $dateTimeIn
          expressionType: HL7Spec

requester:
  expressionType: nested
  vars:
    orc12: STRING_ALL, ORC.12
    obr16: STRING_ALL, OBR.16
    orc14: STRING_ALL, ORC.14
    obr17: STRING_ALL, OBR.17
    orc21: STRING_ALL, ORC.21
    orc22: STRING_ALL, ORC.22
    orc23: STRING_ALL, ORC.23
    orc24: STRING_ALL, ORC.24
  expressions:
    - condition: $orc21 NOT_NULL || $orc22 NOT_NULL || $orc23 NOT_NULL || $orc24 NOT_NULL
      expressionType: reference
      valueOf: segments/ORC/PractitionerRole
    - condition: $obr17 NULL && $orc21 NULL && $orc22 NULL && $orc23 NULL && $orc24 NOT_NULL
      expressionType: reference
      valueOf: datatypes/XCN/Practitioner
      specs: ORC.12 | OBR.16
      constants:
        XADAddress: ORC.24
    - condition: $orc14 NOT_NULL
      expressionType: nested
      expressionsMap:
        extension:
          generateList: true
          expressionType: nested
          expressionsMap:
            url:
              type: SYSTEM_URL
              value: callback-number
            valueContactPoint:
              valueOf: datatypes/XTN/ContactPoint
              expressionType: resource
              specs: ORC.14
    - condition: $orc14 NULL && $obr17 NOT_NULL
      expressionType: nested
      expressionsMap:
        extension:
          generateList: true
          expressionType: nested
          expressionsMap:
            url:
              type: SYSTEM_URL
              value: callback-number
            valueContactPoint:
              valueOf: datatypes/XTN/ContactPoint
              expressionType: resource
              specs: OBR.17

# TODO order type concept
locationCode:
  vars:
    orc29: STRING_ALL, ORC.29
  condition: $orc29 NOT_NULL
  expressionType: resource
  valueOf: datatypes/cwe/CodeableConcept
  specs: ORC.29

reasonCode:
  vars:
    obr31: STRING_ALL, OBR.31
  condition: $obr31 NOT_NULL
  valueOf: datatypes/cwe/CodeableConcept
  generateList: true
  expressionType: resource
  specs: OBR.31

orderDetail:
  generateList: true
  expressionType: nested
  expressions:
    - expressionType: resource
      vars:
        obr47: STRING_ALL, OBR.47
      condition: $obr47 NOT_NULL
      valueOf: datatypes/cwe/CodeableConcept
      specs: OBR.47
      constants:
        hl7v2Name: placer-supplemental-service-information
    - expressionType: resource
      vars:
        obr48: STRING_ALL, OBR.48
      condition: $obr48 NOT_NULL
      valueOf: datatypes/cwe/CodeableConcept
      specs: OBR.48
      constants:
        hl7v2Name: filler-supplemental-service-information

extension:
  expressionType: nested
  generateList: true
  expressions:
    - expressionType: nested
      vars:
        orc1: STRING, ORC.1
      condition: $orc1 NOT_NULL
      expressionsMap:
        url:
          type: SYSTEM_URL
          value: business-event
        valueCode:
          type: STRING
          expressionType: HL7Spec
          valueOf: ORC.1
    - expressionType: nested
      vars:
        orc9: STRING, ORC.9
      condition: $orc9 NOT_NULL && $orc9 NOT_EQUALS NW
      expressionsMap:
        url:
          type: SYSTEM_URL
          value: business-event
        valueString:
          type: STRING
          expressionType: HL7Spec
          valueOf: ORC.9
    - expressionType: nested
      vars:
        orc25: ORC.25
      condition: $orc25 NOT_NULL
      expressionsMap:
        url:
          type: SYSTEM_URL
          value: status-modifier
        valueCodeableConcept:
          expressionType: resource
          valueOf: datatypes/CWE/CodeableConcept
          specs: ORC.25
    # ORC data
    - expressionType: resource
      valueOf: segments/ORC/ORCExtension
    # OBR Data
    - expressionType: resource
      valueOf: segments/ORC/OBRExtension

subject:
  valueOf: datatype/Reference
  expressionType: resource
  specs: $Patient

note:
  valueOf: datatype/Annotation
  condition: $annotationText NOT_NULL
  expressionType: resource
  vars:
    annotationText: NTE.3 *&, GeneralUtils.concatenateWithChar(annotationText, '\n')

supportingInfo:
  valueOf: resource/Observation
  expressionType: reference
  constants:
    suppressNote: 'true'