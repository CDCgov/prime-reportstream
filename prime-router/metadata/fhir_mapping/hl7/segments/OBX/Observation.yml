resourceType: Observation

# Not implementing OBX.5 when OBX.2 is RP as the inventory say it still needs to be resolved
# Not implementing OBX.5 when OBX.2 is CF, the type does not exist in NIST and the mapping is wrong in the inventory
# Not implementing OBX.5 when OBX.2 is NA (Numeric Array), the inventory does not specify how that should map to SampledData
# Not implementing OBX.22 not in mapping deprecated in NIST
# Not implementing OBX.26 not in mapping not in NIST
# Not implementing OBX.27 not in mapping not in NIST
# Not implementing OBX.28 not in mapping not in NIST
# Not implementing OBX.29 not in mapping not in NIST
# Not implementing OBX.31 not in mapping not in NIST
# Not implementing OBX.32 not in mapping not in NIST
# Not implementing OBX.33 as it's not in the NIST spec the logic in the inventory cannot be implemented in the library

id:
  type: STRING
  valueOf: "GeneralUtils.generateResourceId()"
  expressionType: JEXL

code:
  required: true
  expressionType: resource
  valueOf: datatypes/CWE/CodeableConcept
  specs: OBX.3

# TODO how to handle repeating OBX.5???
valueString:
  vars:
    obx2: STRING, OBX.2
  expressionType: nested
  expressions:
    - condition: $obx2 EQUALS ST || $obx2 EQUALS FT || $obx2 EQUALS TX
      type: STRING_ALL
      valueOf: OBX.5
      expressionType: HL7Spec
    - condition: $obx2 EQUALS VR
      vars:
        obx51: OBX.5.1
        obx52: OBX.5.2
        vrValue: $obx51 + $dash + $obx52
      constants:
        dash: "-"
      type: STRING
      valueOf: $vrValue
    - condition: $obx2 EQUALS SN && $obx53 EQUALS +
      vars:
        obx51: OBX.5.1
        obx52: OBX.5.2
        obx53: OBX.5.3
        obx54: OBX.5.4
        value: $obx51 + $plus + $obx52 + $plus + $obx53 + $plus + $obx54
      constants:
        plus: "+"

valueCodeableConcept:
  expressionType: nested
  vars:
    obx2: STRING, OBX.2
  specs: OBX.5
  expressions:
    - condition: $obx2 EQUALS CNE
      valueOf: datatypes/CNE/CodeableConcept
    - condition: $obx2 EQUALS CWE
      valueOf: datatypes/CWE/CodeableConcept
    - condition: $obx2 EQUALS CE
      valueOf: datatypes/CE/CodeableConcept
    - condition: $obx2 EQUALS IS
      expressionType: nested
      expressionsMap:
        coding:
          expressionType: nested
          generateList: true
          expressions:
            - type: STRING
              expressionType: HL7Spec

valuePeriod:
  condition: $obx2 EQUALS DR
  valueOf: datatypes/DR/Period
  expressionType: resource
  specs: OBX.5
  vars:
    obx2: STRING, OBX.2
    start: OBX.5.1
    end: OBX.5.2

valueDateTime:
  condition: $obx2 EQUALS DT || $obx2 EQUALS DTM
  type: STRING
  valueOf: "GeneralUtils.dateTimeWithZoneId(dateTimeIn,ZONEID)"
  expressionType: JEXL
  vars:
    dateTimeIn: OBX.5
    obx2: STRING, OBX.2
_valueDateTime:
  expressionType: nested
  condition: $obx2 EQUALS DT || $obx2 EQUALS DTM
  vars:
    dateTimeIn: OBX.5
    obx2: STRING, OBX.2
  expressionsMap:
    extension_1:
      condition: $dateTimeIn NOT_NULL
      generateList: true
      expressionType: nested
      expressionsMap:
        url:
          type: SYSTEM_URL
          value: hl7v2-date-time
        valueString:
          type: STRING
          valueOf: $dateTimeIn
          expressionType: HL7Spec

valueTime:
  condition: $obx2 EQUALS TM
  type: STRING
  valueOf: OBX.5
  expressionType: HL7Spec
  vars:
    obx2: STRING, OBX.2

valueRange:
  vars:
    obx2: STRING, OBX.2
    CWERangeUnits: OBX.6
    obx53: STRING, OBX.5.3
  expressionType: nested
  specs: OBX.5
  expressions:
    - condition: $obx2 EQUALS NR
      valueOf: datatypes/NR/Range
      expressionType: resource
    - condition: $obx2 EQUALS SN && $obx53 EQUALS -
      valueOf: datatypes/SN/Range
      expressionType: resource


valueRatio:
  vars:
    obx2: OBX.2
    obx53: OBX.5.3
    CWERangeUnits: OBX.6
  condition: >
    $obx2 EQUALS SN && ($obx53 EQUALS : || obx53 EQUALS /)
  valueOf: datatypes/SN/Ratio
  expressionType: resource
  specs: OBX.5

valueQuantity:
  vars:
    obx2: OBX.2
    CWEQuantityUnits: OBX.6
    obx53: OBX.5.3
  expressionType: nested
  expressions:
    - condition: $obx2 EQUALS NM
      expressionType: nested
      expressionsMap:
        value:
          type: STRING
          expressionType: HL7Spec
          valueOf: OBX.5
        code:
          condition: $identifier NOT_NULL && $nameOfCodingSystem NOT_NULL
          type: STRING
          expressionType: HL7Spec
          valueOf: $CWEQuantityUnits.1
          vars:
            identifier: $CWEQuantityUnits.1
            nameOfCodingSystem: $CWEQuantityUnits.3
        unit:
          expressionType: nested
          condition:
          vars:
            identifier: $CWEQuantityUnits.1
            text: $CWEQuantityUnits.2
          expressions:
            - condition: $text NULL && $identifier NOT_NULL
              type: STRING
              valueOf: $CWEQuantityUnits.1
              expressionType: HL7Spec
            - condition: $text NOT_NULL
              type: STRING
              valueOf: $CWEQuantityUnits.2
              expressionType: HL7Spec
        system:
          condition: $identifier NOT_NULL && $nameOfCodingSystem NOT_NULL
          type: SYSTEM_URL
          expressionType: HL7Spec
          valueOf: $CWEQuantityUnits.1
          vars:
            identifier: $CWEQuantityUnits.1
            nameOfCodingSystem: $CWEQuantityUnits.3
        extension:
          generateList: true
          expressionType: nested
          expressionsMap:
            url:
              type: SYSTEM_URL
              value: 'cwe-quantity'
            valueCodeableConcept:
              valueOf: datatypes/CWE/CodeableConcept
              expressionType: resource
              specs: $CWEQuantityUnits
    - condition: >
        $obx2 EQUALS SN && $obx53 NOT_EQUALS : && $obx53 NOT_EQUALS / && $obx53 NOT_EQUALS - && $obx53 NOT_EQUALS +
      expressionType: resource
      valueOf: datatypes/SN/Quantity

referenceRange:
  expressionType: nested
  generateList: true
  expressionsMap:
    text:
      expressionType: HL7Spec
      type: STRING
      valueOf: OBX.7

interpretation:
  valueOf: datatypes/CWE/CodeableConcept
  expressionType: resource
  specs: OBX.8

status:
  type: OBSERVATION_STATUS
  default: unknown
  valueOf: OBX.11
  expressionType: HL7Spec

# TODO collapse and use new type
dataAbsentReason_1:
  condition: $obx11 EQUALS_STRING X
  vars:
    obx11: STRING, OBX.11
  constants:
    primaryCode: cannot-be-obtained
    primarySystem: http://terminology.hl7.org/CodeSystem/data-absent-reason
  valueOf: datatype/CodeableConcept
  expressionType: resource
  generateList: true

dataAbsentReason_2:
  condition: $obx11 EQUALS_STRING N
  vars:
    obx11: STRING, OBX.11
  constants:
    alternateCode: "not-asked"
    alternateSystem: "http://terminology.hl7.org/CodeSystem/data-absent-reason"
  valueOf: datatype/CodeableConcept
  generateList: true

dataAbsentReason_3:
  condition: $obx2 EQUALS ST && $obx5 EQUALS_STRING $emptyString
  vars:
    obx2: STRING, OBX.2
    obx5: STRING, OBX.5
  constants:
    primaryCode: "unknown"
    primarySystem: "http://terminology.hl7.org/CodeSystem/data-absent-reason"
    emptyString: ""
  valueOf: datatype/CodeableConcept
  expressionType: resource
  generateList: true

effectiveDateTime:
  type: STRING
  valueOf: "GeneralUtils.dateTimeWithZoneId(dateTimeIn,ZONEID)"
  expressionType: JEXL
  vars:
    dateTimeIn: OBX.14
_effectiveDateTime:
  expressionType: nested
  condition: $dateTimeIn NOT_NULL
  vars:
    dateTimeIn: OBX.14
  expressionsMap:
    extension_1:
      generateList: true
      expressionType: nested
      expressionsMap:
        url:
          type: SYSTEM_URL
          value: hl7v2-date-time
        valueString:
          type: STRING
          valueOf: $dateTimeIn
          expressionType: HL7Spec

method:
  valueOf: datatypes/CWE/CodeableConcept
  expressionType: resource
  specs: OBX.17

device:
  valueOf: segments/OBX/Device
  expressionType: reference
  specs: OBX.18

performer:
  generateList: true
  expressionType: nested
  expressions:
    - expressionType: reference
      valueOf: segments/OBX/PractitionerRole
      vars:
        OBXPractitionerComponent: OBX.16
      constants:
        OBXPractitionerRoleSystem: "responsibleObserver"
        OBXPractitionerRoleCode: "http://terminology.hl7.org/CodeSystem/practitioner-role"
    - expressionType: reference
      vars:
        obx25: STRING_ALL, OBX.25
        OBXPractitionerComponent: OBX.25
        OBXPractitionerRoleOrganization: OBX.23
        OBXPractitionerRoleOrganizationAddress: OBX.24
      condition: $obx25 NOT_NULL
      valueOf: segments/OBX/PractitionerRole
      constants:
        OBXPractitionerRoleSystem: "MDIR"
        OBXPractitionerRoleCode: "http://terminology.hl7.org/CodeSystem/v2-0912"
    - expressionType: reference
      vars:
        obx25: STRING_ALL, OBX.25
        XADAddress: OBX.24
      condition: $obx25 NULL
      valueOf: datatypes/XON/Organization
      specs: OBX.23

bodySite:
  valueOf: datatypes/CWE/CodeableConcept
  expressionType: resource
  specs: OBX.20

identifier:
  valueOf: datatypes/EI/Identifier
  specs: OBX.21
  constants:
    code: "FILL"

extension:
  generateList: true
  expressionType: nested
  expressions:
    - expressionType: nested
      vars:
        obx4: STRING,OBX.4
      condition: $obx4 NOT_NULL
      expressionsMap:
        url:
          type: SYSTEM_URL
          value: sub-id
        valueString:
          expressionType: HL7Spec
          type: STRING
          valueOf: OBX.4
    - expressionType: nested
      vars:
        obx10: STRING_ALL,OBX.10
      condition: $obx10 NOT_NuLL
      expressionsMap:
        url:
          type: SYSTEM_URL
          value: nature-of-abnormal-test
        valueCodeableConcept:
          valueOf: datatypes/CWE/CodeableConcept
          expressionType: resource
          specs: OBX.10
    - expressionType: nested
      vars:
        obx19: STRING, OBX.19
      condition: $obx19 NOT_NULL
      expressionsMap:
        url:
          type: SYSTEM_URL
          value: analysis-date-time
        valueDateTime:
          type: STRING
          valueOf: "GeneralUtils.dateTimeWithZoneId(dateTimeIn,ZONEID)"
          expressionType: JEXL
          vars:
            dateTimeIn: OBX.19
        _valueDateTime:
          expressionType: nested
          condition: $obx19 NOT_NULL
          vars:
            obx19: OBX.19
          expressionsMap:
            extension_1:
              generateList: true
              expressionType: nested
              expressionsMap:
                url:
                  type: SYSTEM_URL
                  value: hl7v2-date-time
                valueString:
                  type: STRING
                  valueOf: $obx19
                  expressionType: HL7Spec
    - expressionType: nested
      vars:
        obx30: STRING_ALL, OBX.30
      condition: $obx30 NOT_NULL
      expressionsMap:
        url:
          type: SYSTEM_URL
          value: observation-sub-type
        valueCode:
          type: STRING
          expressionType: HL7Spec
          specs: OBX.30
    - expressionType: nested
      vars:
        obx2: OBX.2
        obx54: OBX.5.4
      condition: $obx2 EQUALS ED && $obx54 EQUALS Base64
      expressionsMap:
        url:
          type: SYSTEM_URL
          #          "https://hl7.org/fhir/R5/StructureDefinition/extension-Observation.valueAttachment
          value: observation-value-attachment
        valueAttachment:
          valueOf: datatypes/ED/Attachment
          expressionType: resource
          specs: OBX.5
    - expressionType: resource
      valueOf: segments/OBX/OBXExtension

subject:
  valueOf: datatype/Reference
  expressionType: resource
  specs: $Patient

encounter:
  valueOf: datatype/Reference
  expressionType: resource
  specs: $Encounter

# $suppressNote is a constant that can be passed in so that a note is not generated
# This was required when we translate the SPECIMEN.OBX segment so that the created observation
# does not include notes from the OBSERVATION GROUP
# ORDER_OBSERVATION
#   NTE -> Should not be included as part of the Observation created from the OBX
#   SPECIMEN
#     OBX
# See use here: https://github.com/CDCgov/prime-reportstream/blob/813fe6d15e780af3ea88eb61ddfbdf2a8f4462a9/prime-router/metadata/fhir_mapping/hl7/resource/ServiceRequest.yml#L380
note:
  valueOf: datatype/Annotation
  condition: $annotationText NOT_NULL && $suppressNote NULL
  expressionType: resource
  useGroup: true
  vars:
    annotationText: NTE.3 *&, GeneralUtils.concatenateWithChar(annotationText, '\n')

specimen:
  valueOf: datatype/Reference
  expressionType: resource
  specs: $Specimen
  useGroup: true
