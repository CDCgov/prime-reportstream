elements:
  - name: encoding-characters
    condition: '%resource.extension(%`rsext-encoding-characters`).exists()'
    value: [ '%resource.extension(%`rsext-encoding-characters`).value' ]
    hl7Spec: [ MSH-2 ]

  - name: sending-application-source
    condition: '%resource.extension(%`rsext-hl7-use`).value = "sending-application"'
    resource: '%resource.source'
    schema: Source/HD
    constants:
      hl7HDField: 'MSH-3'

  - name: sending-facility
    resource: '%resource.sender.resolve()'
    condition: '%resource.exists()'
    constants:
      hl7HDField: 'MSH-4'
    schema: ../Organization/HD

  - name: receiving-application
    resource: '%resource.destination.where(extension(%`rsext-hl7-use`).value = "receiving-application")'
    schema: Destination/HD
    constants:
      hl7HDField: 'MSH-5'

  - name: receiving-facility
    resource: '%resource.destination.receiver.resolve().where(extension(%`rsext-hl7-use`).value = "receiving-facility")'
    schema: ../Organization/HD
    constants:
      hl7HDField: 'MSH-6'

  - name: datetime-of-message
    value: [ '%resource.extension(%`rsext-msh-7-datetime-of-message`).value' ]
    hl7Spec: [ MSH-7 ]

  # This element is needed to enforce that one of the two message times is present in the FHIR bundle
  - name: message-date-time
    value:
      - '%resource.extension(%`rsext-msh-7-datetime-of-message`).value'
      - Bundle.entry.resource.ofType(Provenance).recorded
      - Bundle.timestamp
    required: true
    hl7Spec: [ MSH-7 ]

  # This element follows the usual date mapping for dates/dateTimes, overwriting the result from the previous element
  - name: message-date-time
    resource: 'Bundle.entry.resource.ofType(Provenance).recorded'
    condition: '%resource.exists()'
    constants:
      dtmFieldPath: 'MSH-7'
    schema: ../../datatypes/dateTime/DTMorDT

  - name: security
    value: [ '%resource.meta.security.code' ]
    hl7Spec: [ MSH-8-1 ]

  - name: message-event-coding
    schema: ../../datatypes/coding/MSG
    condition: '%resource.is(Coding)'
    resource: '%resource.event'
    constants:
      hl7MSGField: MSH-9

  - name: message-control-id
    value: [ 'Bundle.identifier.value' ]
    required: true
    hl7Spec: [ MSH-10 ]

  - name: message-processing
    schema: ../../datatypes/meta/PT
    resource: '%resource.meta'
    constants:
      hl7PTField: MSH-11

  - name: version-id
    value: [ '"2.5.1"' ]
    hl7Spec: [ MSH-12 ]

  - name: continuation-pointer
    value: [ '%resource.extension(%`rsext-msh-13-sequence-number`).value' ]
    hl7Spec: [ MSH-13 ]

  - name: continuation-pointer
    value: [ '%resource.extension(%`rsext-msh-14-continuation-pointer`).value' ]
    hl7Spec: [ MSH-14 ]

  - name: accept-acknowledgement-type
    value: [ '%resource.extension(%`rsext-msh-15-accept-acknowledgement-type`).value' ]
    hl7Spec: [ MSH-15 ]

  - name: app-acknowledgement-type
    value: [ '%resource.extension(%`rsext-msh-16-application-acknowledgement-type`).value' ]
    hl7Spec: [ MSH-16 ]

  - name: country-code
    value: [ '%resource.sender.resolve().address.country' ]
    hl7Spec: [ MSH-17 ]

  - name: message-character-set
    resource: '%resource.extension(%`rsext-character-set`).value'
    resourceIndex: characterSetIndex
    schema: extensionCharacterSetList/ID

  - name: principal-lanuage-of-message
    resource: '%resource.extension(%`rsext-msh-19-principal-language-of-message`).value'
    schema: ../../datatypes/codeableConcept/CWE
    constants:
      cweField: 'MSH-19'

  - name: alternate-character-set
    value: [ '%resource.extension(%`rsext-msh-20-alternate-character-set-handling-scheme`).value' ]
    hl7Spec: [ MSH-20 ]

  - name: message-profile-identifier
    resource: '%resource.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/msh21-source-message-profile-id").value'
    condition: '%resource.exists()'
    constants:
      entityIdFieldPath: 'MSH-21(%{entityIdIndex})'
    schema: ../../common/datatype/ei-entity-identifier
    resourceIndex: entityIdIndex

  - name: responsible
    resource: '%resource.responsible.resolve()'
    condition: '%resource.exists()'
    schema: ../Organization/XON
    constants:
      hl7XONField: 'MSH-22'

  - name: receiving-responsible-organization
    resource: '%resource.destination.receiver.resolve().where(extension(%`rsext-hl7-use`).value = "receiving-responsible-organization")'
    schema: ../Organization/XON
    constants:
      hl7XONField: 'MSH-23'

  - name: sending-network-address-from-source
    resource: '%resource.source'
    condition: '%resource.extension(%`rsext-hl7-use`).value = "sending-network-address"'
    schema: Source/HD
    constants:
      hl7HDField: 'MSH-24'

  - name: sending-network-address-from-extension
    resource: '%resource.extension(%`rsext-msh-24-hd-extension`)'
    schema: ../../datatypes/extensionHD/HD
    constants:
      hl7HDField: 'MSH-24'

  - name: receiving-network-address
    resource: '%resource.destination.where(extension(%`rsext-hl7-use`).value = "receiving-network-address")'
    schema: Destination/HD
    constants:
      hl7HDField: 'MSH-25'

  - name: receiving-network-address-duplicates-receiving-application
    resource: '%resource.extension(%`rsext-msh-25-hd-extension`)'
    schema: ../../datatypes/extensionHD/HD
    constants:
      hl7HDField: 'MSH-25'

