elements:

  # the specimen.parent field in FHIR does not repeat so an extension is needed to capture additional parent identifiers
  # as such, use the extension when it is populated
  - name: specimen-identifier
    resource: '%resource.parent.resolve().identifier.where(extension(%`rsext-hl7-use`).value = "specimen-id-placer")'
    condition: '%resource.extension.where(url = "spm-3-specimen-parent-id-placer").exists().not()'
    constants:
      eipFieldPath: '%{hl7SpecimenFieldPath}-3'
    schema: ../../datatypes/identifier-placerAssignedIdentifier/EIP

  - name: specimen-identifier-backup
    resource: '%resource.parent.resolve().identifier.where(extension(%`rsext-hl7-use`).value = "specimen-id-filler")'
    condition: >
      %resource.parent.resolve().identifier.where(extension(%`rsext-hl7-use`).value = "specimen-id-placer").exists().not() and
      %resource.extension.where(url = "spm-3-specimen-parent-id-placer").exists().not()
    constants:
      eipFieldPath: '%{hl7SpecimenFieldPath}-3'
    schema: ../../datatypes/identifier-fillerAssignedIdentifier/EIP

  - name: specimen-parent-identifier
    resource: '%resource.extension.where(url = "spm-3-specimen-parent-id-placer").value'
    resourceIndex: eipIndex
    constants:
      eipFieldPath: '%{hl7SpecimenFieldPath}-3(%{eipIndex})'
    schema: ../../datatypes/identifier-placerAssignedIdentifier/EIP

  - name: specimen-parent-identifier-backup
    resource: '%resource.extension.where(url = "spm-3-specimen-parent-id-filler").value'
    condition: '%resource.extension.where(url = "spm-3-specimen-parent-id-placer").exists().not()'
    resourceIndex: eipIndex
    constants:
      eipFieldPath: '%{hl7SpecimenFieldPath}-3(%{eipIndex})'
    schema: ../../datatypes/identifier-fillerAssignedIdentifier/EIP

  - name: specimen-type-modifier
    resource: '%resource.extension.where(url = "spm-5-specimen-type-modifier").value'
    schema: ../../datatypes/codeableConcept/CWE
    resourceIndex: cweIndex
    constants:
      cweField: '%{hl7SpecimenFieldPath}-5(%{cweIndex})'

  - name: specimen-additives
    resource: '%resource.extension.where(url = "spm-6-specimen-additives").value'
    schema: ../../datatypes/codeableConcept/CWE
    resourceIndex: cweIndex
    constants:
      cweField: '%{hl7SpecimenFieldPath}-6(%{cweIndex})'

  - name: specimen-collection-site
    resource: '%resource.extension.where(url = "spm-10-specimen-collection-site").value'
    schema: ../../datatypes/codeableConcept/CWE
    constants:
      cweField: '%{hl7SpecimenFieldPath}-10'

  - name: specimen-role
    resource: '%resource.extension.where(url = "spm-11-specimen-role").value'
    schema: ../../datatypes/codeableConcept/CWE
    resourceIndex: cweIndex
    constants:
      cweField: '%{hl7SpecimenFieldPath}-11(%{cweIndex})'

  - name: grouped-specimen-count
    value: [ '%resource.extension.where(url = "spm-13-grouped-specimen-count").value' ]
    hl7Spec: [ '%{hl7SpecimenFieldPath}-13' ]

  - name: specimen-handling-code
    resource: '%resource.extension.where(url = "spm-15-specimen-handling-code").value'
    schema: ../../datatypes/codeableConcept/CWE
    resourceIndex: cweIndex
    constants:
      cweField: '%{hl7SpecimenFieldPath}-15(%{cweIndex})'

  - name: specimen-risk-code
    resource: '%resource.extension.where(url = "spm-16-specimen-risk-code").value'
    schema: ../../datatypes/codeableConcept/CWE
    resourceIndex: cweIndex
    constants:
      cweField: '%{hl7SpecimenFieldPath}-16(%{cweIndex})'

  - name: specimen-expiration-date
    value: [ '%resource.extension.where(url = "spm-19-specimen-expiration-date").value' ]
    hl7Spec: [ '%{hl7SpecimenFieldPath}-19' ]

  - name: specimen-availability
    value: [ '%resource.extension.where(url = "spm-20-specimen-availability").value' ]
    hl7Spec: [ '%{hl7SpecimenFieldPath}-20' ]

  - name: specimen-quality
    resource: '%resource.extension.where(url = "spm-22-specimen-quality").value'
    schema: ../../datatypes/codeableConcept/CWE
    constants:
      cweField: '%{hl7SpecimenFieldPath}-22'

  - name: specimen-appropriateness
    resource: '%resource.extension.where(url = "spm-23-specimen-appropriateness").value'
    schema: ../../datatypes/codeableConcept/CWE
    constants:
      cweField: '%{hl7SpecimenFieldPath}-23'

  - name: specimen-current-quantity
    resource: '%resource.extension.where(url = "spm-25-specimen-current-quantity").value'
    schema: ../../datatypes/Quantity/CQ
    constants:
      cqFieldPath: '%{hl7SpecimenFieldPath}-25'

  - name: number-of-specimen-containers
    value: [ '%resource.extension.where(url = "spm-26-number-of-specimen-containers").value' ]
    hl7Spec: [ '%{hl7SpecimenFieldPath}-26' ]

  - name: container-condition
    resource: '%resource.extension.where(url = "spm-28-container-condition").value'
    schema: ../../datatypes/codeableConcept/CWE
    constants:
      cweField: '%{hl7SpecimenFieldPath}-28'

  - name: specimen-child-role
    resource: '%resource.extension.where(url = "spm-29-specimen-child-role").value'
    schema: ../../datatypes/codeableConcept/CWE
    constants:
      cweField: '%{hl7SpecimenFieldPath}-29'