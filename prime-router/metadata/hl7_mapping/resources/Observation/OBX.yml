elements:
  - name: obx-set-id
    value: [ '%resultIndex + 1' ]
    hl7Spec: [ '%{hl7OBXField}-1' ]

  - name: obx-code
    resource: '%resource.code'
    schema: ../../datatypes/codeableConcept/CWE
    constants:
      cweFieldPath: '%{hl7OBXField}-3'

  - name: obx-sub-id
    value: [ '%resource.extension(%`rsext-sub-id`).value' ]
    hl7Spec: [ '%{hl7OBXField}-4' ]

  - name: obx-value-string
    condition: '%resource.value.is(string)'
    value: [ '%resource.value' ]
    hl7Spec: [ '%{hl7OBXField}-5' ]

  - name: obx-references-range
    value: [ '%resource.referenceRange.text' ]
    hl7Spec: [ '%{hl7OBXField}-7' ]

  - name: obx-interpretation-codes
    resource: '%resource.interpretation'
    schema: ../../datatypes/codeableConcept/CWE
    resourceIndex: interpretationIndex
    constants:
      cweFieldPath: '%{hl7OBXField}-8(%{interpretationIndex})'

  # TODO need a schema to handle the repeating
  - name: obx-nature-of-abnormal-test
    resource: '%resource.extension(%`rsext-nature-of-abnormal-test`)'
    schema: ./NatureOfAbnormalTest
    resourceIndex: abnormalTestIndex


  - name: obx-datetime-of-observation
    value: [ '%resource.effective.extension(%`rsext-hl7v2-date-time`).value' ]
    hl7Spec: [ '%{hl7OBXField}-14' ]

  - name: obx-responsible-observer
    resource: '%resource.performer.resolve().where(code.coding.code = "responsibleObserver").practitioner.resolve()'
    schema: ../Practitioner/XCN
    resourceIndex: responsibleObserverIndex
    constants:
      hl7XCNField: '%{hl7OBXField}-16(%{responsibleObserverIndex})'

  - name: obx-observation-method
    resource: '%resource.method.union(%resource.extension(%`rsext-obx-observation`).extension.where(url = "obx-17-observation-method").tail().value)'
    schema: ../../datatypes/codeableConcept/CWE
    resourceIndex: observationMethodIndex
    constants:
      cweFieldPath: '%{hl7OBXField}-17(%{observationMethodIndex})'

  - name: obx-equipment-instance-identifier
    resource: '%resource.device.resolve().identifier.union(%resource.extension(%`rsext-obx-observation`).extension.where(url = "obx-18-equipment-instance-identifier").tail().value.resolve().identifier)'
    schema: ../../datatypes/identifier-extension/EI
    resourceIndex: equipmentInstanceIdentifierIndex
    constants:
      eiFieldPath: '%{hl7OBXField}-18(%{equipmentInstanceIdentifierIndex})'

  - name: obx-datetime-of-analysis
    value: [ '%resource.extension(%`rsext-analysis-date-time`).value.extension(%`rsext-hl7v2-date-time`).value' ]
    hl7Spec: [ '%{hl7OBXField}-19' ]

  - name: obx-observation-method
    resource: '%resource.bodySite.union(%resource.extension(%`rsext-obx-observation`).extension.where(url = "obx-20-observation-site").tail().value)'
    schema: ../../datatypes/codeableConcept/CWE
    resourceIndex: observationMethodIndex
    constants:
      cweFieldPath: '%{hl7OBXField}-20(%{observationMethodIndex})'

  - name: obx-observation-instance-identifier
    resource: '%resource.identifier.where(extension(%`rsext-hl7-use`).value = "obx-21-observation-instance-identifier")'
    schema: ../../datatypes/identifier-extension/EI
    constants:
      eiFieldPath: '%{hl7OBXField}-21'

  - name: obx-performing-organization-name-from-org
    resource: '%resource.performer.resolve().ofType(Organization)'
    schema: ../Organization/XON
    constants:
      hl7XONField: '%{hl7OBXField}-23'

  - name: obx-performing-organization-name-from-practitioner-role
    resource: '%resource.performer.resolve().ofType(PractitionerRole).where(code.coding.code = "MDIR").organization.resolve()'
    schema: ../Organization/XON
    constants:
      hl7XONField: '%{hl7OBXField}-23'

  - name: obx-performing-organization-address-from-org
    resource: '%resource.performer.resolve().ofType(Organization).address'
    schema: ../../datatypes/Address/XAD
    constants:
      hl7SpecXADField: '%{hl7OBXField}-24'

  - name: obx-performing-organization-address-from-practitioner-role
    resource: '%resource.performer.resolve().ofType(PractitionerRole).where(code.coding.code = "MDIR").organization.resolve().address'
    schema: ../../datatypes/Address/XAD
    constants:
      hl7SpecXADField: '%{hl7OBXField}-24'

  - name: obx-performing-organization-medical-director
    resource: '%resource.performer.resolve().ofType(PractitionerRole).where(code.coding.code = "MDIR").practitioner.resolve()'
    schema: ../Practitioner/XCN
    constants:
      hl7XCNField: '%{hl7OBXField}-25'

  - name: obx-observation-sub-type
    value: [ '%resource.extension(%`rsext-observation-sub-type`).value' ]
    hl7Spec: [ '%{hl7OBXField}-30' ]

  - name: obx-extension-values
    resource: '%resource.extension(%`rsext-obx-observation`)'
    schema: ./OBXExtension

