##########################################################################
# This is a temporary CA transform. These settings need to be #
# moved to a sender transform once that feature is complete.             #
##########################################################################
hl7Class: ca.uhn.hl7v2.model.v251.message.ORU_R01

constants:
  #TODO: Constants are not currently working in sender transforms
  simpleReportClia: '"36D1332559"'
  simpleReportName: '"Simple Report"'
  useAoe: '"false"'
extends: ../../ORU_R01/ORU_R01-base
elements:
  #########################
  # ReportStream specific #
  #########################
  - name: sending-application-namespace-id-no-endpoint
    condition: true
    resource: 'Bundle'
    value: [ '"CDC PRIME - Atlanta"' ]

  - name: sending-application-universal-id-no-endpoint
    condition: true
    resource: 'Bundle'
    value: [ '"2.16.840.1.114222.4.1.237821"' ]

  - name: sending-application-universal-id-type-with-endpoint
    condition: true
    resource: 'Bundle'
    value: [ '"ISO"' ]

  ######################################################
  # Source: ReportStream CA Requirements from settings #
  # Using CA for now, but may need specific ones       #
  ######################################################
  - name: receiving-application-namespace-id
    condition: true
    resource: 'Bundle'
    value: [ '"CDPH CA REDIE"' ]

  - name: receiving-application-universal-id
    condition: true
    resource: 'Bundle'
    value: [ '"2.16.840.1.114222.4.3.3.10.1.1"' ]

  - name: receiving-application-universal-id-type
    condition: true
    resource: 'Bundle'
    value: [ '"ISO"' ]

  - name: receiving-facility-namespace-id
    condition: true
    resource: 'Bundle'
    value: [ '"CDPH_CID"' ]

  - name: receiving-facility-universal-id
    condition: true
    resource: 'Bundle'
    value: [ '"2.16.840.1.114222.4.1.214104"' ]

  - name: receiving-facility-universal-id-type
    condition: true
    resource: 'Bundle'
    value: [ '"ISO"' ]


  #####################################
  # Simple Report specific transforms #
  #####################################
  - name: sending-facility_namespace-id
    condition: true
    resource: 'Bundle'
    value: [ '"Simple Report"' ]

  - name: sending-facility-universal-id
    condition: true
    resource: 'Bundle'
    value: [ '"36D1332559"' ]

  - name: sending-facility-universal-id-type
    condition: true
    resource: 'Bundle'
    value: [ '"CLIA"' ]

  - name: processing-id
    condition: true
    resource: 'Bundle'
    value: [ '"P"' ]

  - name: message_profile_id
    value: [ '"PHLabReport-NoAck"' ]
    hl7Spec: [ MSH-21-1 ]

  - name: message_profile_id_namespace_id
    value: [ '"ELR_Receiver"' ]
    hl7Spec: [ MSH-21-2 ]

  - name: message_profile_id_universal_id
    value: [ '"2.16.840.1.113883.9.11"' ]
    hl7Spec: [ MSH-21-3 ]

  - name: message_profile_id_universal_id_type
    value: [ '"ISO"' ]
    hl7Spec: [ MSH-21-4 ]
    #SFT-1-1
  - name: software-vendor-name
    condition: true
    resource: 'Bundle'
    value: [ '"Centers for Disease Control and Prevention"' ]

    #SFT-1-2
  - name: software-vendor-name-type
    condition: false

    #SFT-1-6
  - name: software-vendor-assigning-authority
    condition: false

    #SFT-3
  - name: software-name
    condition: true
    resource: 'Bundle'
    value: [ '"PRIME ReportStream"' ]

  #The transforms below could be moved to the enrichment step for CA once FHIR transforms are ready
  - name: ca-order-observations
    resource: 'Bundle.entry.resource.ofType(DiagnosticReport)'
    condition: '%resource.count() > 0'
    schema: ca-order-observation
    resourceIndex: orderIndex

  #California requirement: suppress AOEs from being mapped to OBR segments
  #This makes sure only observations under diagnostic reports are mapped
  - name: observation-result-with-aoe
    resource: '%resource.result.resolve()'

  #California requirement: map AOE questions to NTE segments under Patient
  #Appending AOE questions to patient notes
  - name: patient-note
    resource: 'Bundle.entry.resource.ofType(Patient).extension(%`rsext-patient-notes`).value.text.split(''\n'') | Bundle.entry.resource.ofType(ServiceRequest).supportingInfo.resolve()'
    condition: 'Bundle.entry.resource.ofType(Patient).extension(%`rsext-patient-notes`).exists() or Bundle.entry.resource.ofType(ServiceRequest).supportingInfo.exists()'
    schema: 'ca-patient-note'
