constants:
  hl7Order: '/PATIENT_RESULT/ORDER_OBSERVATION(%{orderIndex})'
  diagnostic: 'Bundle.entry.resource.ofType(DiagnosticReport)[%orderIndex]'
  service: 'Bundle.entry.resource.ofType(DiagnosticReport)[%orderIndex].basedOn.resolve()'
elements:
  - name: ca-observation-result
    resource: '%resource.result.resolve()'
    schema: ca-observation-result
    resourceIndex: resultIndex

  - name: ca-order-segment
    schema: ca-order

  - name: ca-specimen
    schema: ca-specimen

  # California requirement: Move all regular notes and AOE questions between last OBX segment and SPM
  #   as NTE segments
  # To do that we have to compare the Observation index against the Observation count
  # to make sure is the last OBX segment and only add notes and AOE questions to that segment
  - name: ca-order-note
    resource: '%service.note.text.split(''\n'') | %service.supportingInfo.resolve()'
    condition: >-
      (%service.note.exists() or %service.supportingInfo.exists())
#      and (%diagnostic.result.count() - 1) = %resultIndex
    schema: ca-order-note
    resourceIndex: noteIndex
    constants:
      hl7NotePath: '%{hl7Order}'
      # Cannot use %resource here as this constant will be resolved in the note schema
      noteDetails: '%service.note'