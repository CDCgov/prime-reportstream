hl7Class: ca.uhn.hl7v2.model.v27.message.ORU_R01
constants:
  # Prefix for RS custom extension URLs
  rsext: '"https://reportstream.cdc.gov/fhir/StructureDefinition/"'
elements:
  - name: message-headers
    condition: >
      Bundle.entry.resource.ofType(MessageHeader).exists() and
      Bundle.entry.resource.ofType(MessageHeader).event is Coding and
      Bundle.entry.resource.ofType(MessageHeader).event.code = 'R01'
    resource: 'Bundle.entry.resource.ofType(MessageHeader)'
    required: true
    schema: ../resources/MessageHeader/MSH

  - name: software-segment
    condition: 'Bundle.entry.resource.ofType(MessageHeader).exists()'
    resource: 'Bundle.entry.resource.ofType(MessageHeader)'
    schema: ../resources/MessageHeader/SFT

  - name: patient-information
    resource: 'Bundle.entry.resource.ofType(Patient)'
    condition: '%resource.count() = 1'
    required: true
    constants:
      hl7SegmentGroup: '/PATIENT_RESULT/PATIENT'
    schema: ../common/patient

  - name: patient-note
    resource: 'Bundle.entry.resource.ofType(Patient).extension(%`rsext-patient-notes`).value'
    condition: 'Bundle.entry.resource.ofType(Patient).extension(%`rsext-patient-notes`).exists()'
    schema: ../common/note
    resourceIndex: noteIndex
    constants:
      hl7NotePath: '/PATIENT_RESULT/PATIENT'

  - name: encounter-pv1
    resource: 'Bundle.entry.resource.ofType(Encounter)'
    condition: '%resource.count() = 1'
    constants:
      hl7PV1Field: '/PATIENT_RESULT/PATIENT/VISIT/PV1'
    schema: ../resources/Encounter/PV1

  - name: encounter-pv2
    resource: 'Bundle.entry.resource.ofType(Encounter)'
    condition: '%resource.count() = 1'
    constants:
      hl7PV2Field: '/PATIENT_RESULT/PATIENT/VISIT/PV2'
    schema: ../resources/Encounter/PV2

  - name: order-observations
    resource: 'Bundle.entry.resource.ofType(DiagnosticReport)'
    condition: '%resource.count() > 0'
    required: true
    schema: base/order-observation
    resourceIndex: orderIndex

  - name: participation-request
    resource: 'Bundle.entry.resource.ofType(Device)'
    condition: 'Bundle.entry.resource.ofType(Device).udiCarrier.exists()'
    constants:
      hl7SegmentGroup: '/PATIENT_RESULT/PATIENT/PATIENT_OBSERVATION'
    schema: ../resources/Device/PRT
    resourceIndex: orderIndex

  - name: related-person-nk1
    resource: 'Bundle.entry.resource.ofType(RelatedPerson).where(extension(%`rsext-hl7v2Name`).value = "NK1")'
    condition: '%resource.patient.exists()'
    constants:
      hl7SegmentGroup: '/PATIENT_RESULT/PATIENT'
    schema: ../resources/RelatedPerson/NK1
    resourceIndex: relatedPersonIndex
