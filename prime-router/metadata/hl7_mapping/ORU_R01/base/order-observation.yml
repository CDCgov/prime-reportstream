constants:
  hl7Order: '/PATIENT_RESULT/ORDER_OBSERVATION(%{orderIndex})'
  diagnostic: 'Bundle.entry.resource.ofType(DiagnosticReport)[%orderIndex]'
  service: 'Bundle.entry.resource.ofType(DiagnosticReport)[%orderIndex].basedOn.resolve()'
  specimen: 'Bundle.entry.resource.ofType(DiagnosticReport)[%orderIndex].specimen.resolve()'
  hl7ObservationNotes: '/PATIENT_RESULT/ORDER_OBSERVATION(%{orderIndex})/OBSERVATION'
  hl7ObservationPath: '/PATIENT_RESULT/ORDER_OBSERVATION(%{orderIndex})/OBSERVATION'
elements:

  - name: common-order-service-request
    resource: '%service'
    schema: ../../resources/ServiceRequest/ORC

  - name: common-order-diagnostic-report
    resource: '%diagnostic'
    schema: ../../resources/DiagnosticReport/ORC


  - name: observation-request
    # Condition from ORU_RO1 covers this schema as well
    schema: observation-request

  - name: observation-request-service-request
    resource: '%service'
    schema: ../../resources/ServiceRequest/OBR

  - name: specimen
    resource: '%specimen'
    resourceIndex: specimenIndex
    condition: '%specimen.exists()'
    schema: ../../common/specimen
    constants:
      hl7SpecimenFieldPath: /PATIENT_RESULT/ORDER_OBSERVATION(%{orderIndex})/SPECIMEN/SPM
      performerOrganization: '%diagnostic.basedOn.resolve().performer.resolve()'

  - name: timing-segment
    resource: '%service'
    # Only create the segment if we have data for it
    condition: >
      %resource.occurrence.repeat.bounds.start.exists() or
      %resource.occurrence.repeat.bounds.end.exists() or
      %resource.priority.exists() or
      %resource.extension(%`rsext-service-priority`).exists()
    schema: timing-quantity

  - name: observation-result-with-aoe
    # Grab only the AOE observations from ServiceRequest.supportingInfo NOT associated with a specimen
    resource: '%resource.result.resolve() | %service.supportingInfo.resolve().where(specimen.exists().not())'
    schema: ../../common/observation-result
    resourceIndex: resultIndex
    constants:
      hl7ObservationPath: '/PATIENT_RESULT/ORDER_OBSERVATION(%{orderIndex})/OBSERVATION(%{resultIndex})'
      hl7OBXField: '/PATIENT_RESULT/ORDER_OBSERVATION(%{orderIndex})/OBSERVATION(%{resultIndex})/OBX'
      observation: '%diagnostic.result[%resultIndex].resolve()'

  - name: order-note
    resource: '%service.note.text.split(''\n'')'
    condition: '%service.note.exists()'
    schema: ../../common/note
    resourceIndex: noteIndex
    constants:
      hl7NotePath: '%{hl7Order}'
      # Cannot use %resource here as this constant will be resolved in the note schema
      noteDetails: '%service.note'