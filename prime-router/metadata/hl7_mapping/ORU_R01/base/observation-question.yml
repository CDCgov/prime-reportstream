constants:
  hl7ObservationPath: '/PATIENT_RESULT/ORDER_OBSERVATION(%{orderIndex})/OBSERVATION(%{resultIndex})'
  hl7OBXField: '/PATIENT_RESULT/ORDER_OBSERVATION(%{orderIndex})/OBSERVATION(%{resultIndex})/OBX'
  observation: '%diagnostic.result[%resultIndex].resolve()'
elements:
  - name: result-set-id
    value: [ '%resultIndex + 1' ]
    hl7Spec: [ '%{hl7OBXField}-1' ]

  - name: result-value-type-ce
    condition: '%resource.value is CodeableConcept'
    # Note that for v.2.5 and earlier CWE does not exist.
    value: [ '"CWE"' ]
    hl7Spec: [ '%{hl7OBXField}-2' ]

  - name: observation-identifier-code
    value: [ '%resource.code.coding.code' ]
    hl7Spec: [ '%{hl7OBXField}-3-1' ]

  - name: observation-identifier-text
    value: [ '%resource.code.text' ]
    hl7Spec: [ '%{hl7OBXField}-3-2' ]

  - name: observation-identifier-coding-system
    value: [ '%resource.code.coding.system' ]
    hl7Spec: [ '%{hl7OBXField}-3-3' ]

  # override to handle LN translated to loinc L on HL7->FHIR conversion
  - name: observation-identifier-coding-system-ln
    resource: '%resource.code.coding'
    condition: '%resource.system = "http://loinc.org"'
    value: [ '%resource.system.getCodingSystemMapping()' ]
    hl7Spec: [ '%{hl7OBXField}-3-3' ]

  - name: observation-value-cwe
    resource: '%resource.value'
    condition: '%resource is CodeableConcept'
    constants:
      cweFieldPath: '%{hl7OBXField}-5'
    schema: datatype/ce-coded-with-exceptions


