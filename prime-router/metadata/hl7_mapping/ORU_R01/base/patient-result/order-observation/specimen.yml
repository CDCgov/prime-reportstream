constants:
  specimen: 'Bundle.entry.resource.ofType(DiagnosticReport)[%orderIndex].specimen.resolve()'
  hl7SpecimenFieldPath: /PATIENT_RESULT/ORDER_OBSERVATION(%{orderIndex})/SPECIMEN/SPM

elements:

  - name: specimen
    resource: '%specimen'
    resourceIndex: specimenIndex
    condition: '%specimen.exists()'
    schema: ../../../../resources/Specimen/SPM
    constants:
      performerOrganization: '%diagnostic.basedOn.resolve().performer.resolve()'

  - name: specimen-extension
    resource: '%specimen.extension(%`rsext-spm-specimen`)'
    schema: ../../../../resources/Specimen/SPMExtension

  - name: specimen-observation
    resource: 'Bundle.entry.resource.ofType(Observation).where(focus.exists()).where(focus.resolve().id = %specimen.id)'
    schema: ../../../../resources/Observation/OBX
    resourceIndex: specimenObservationIndex
    constants:
      hl7ObservationPath: '/PATIENT_RESULT/ORDER_OBSERVATION(%{orderIndex})/SPECIMEN/SPECIMEN_OBSERVATION'
      hl7OBXField: '/PATIENT_RESULT/ORDER_OBSERVATION(%{orderIndex})/SPECIMEN/SPECIMEN_OBSERVATION(%{specimenObservationIndex})/OBX'
      resultIndex: '%specimenObservationIndex'