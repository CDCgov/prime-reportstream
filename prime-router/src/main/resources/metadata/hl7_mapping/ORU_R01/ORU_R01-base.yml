hl7Class: ca.uhn.hl7v2.model.v27.message.ORU_R01
constants:
  # Prefix for RS custom extension URLs
  rsext: '"https://reportstream.cdc.gov/fhir/StructureDefinition/"'
elements:
  - name: message-headers
    condition: >
      Bundle.entry.resource.ofType(MessageHeader).exists() and
      Bundle.entry.resource.ofType(MessageHeader).event is Coding and
      Bundle.entry.resource.ofType(MessageHeader).event.code = 'R01'
    resource: 'Bundle.entry.resource.ofType(MessageHeader)'
    required: true
    schema: classpath:/metadata/hl7_mapping/resources/MessageHeader/MSH.yml

  - name: software-segment
    condition: 'Bundle.entry.resource.ofType(MessageHeader).exists()'
    resource: 'Bundle.entry.resource.ofType(MessageHeader)'
    schema: classpath:/metadata/hl7_mapping/resources/MessageHeader/SFT.yml

  - name: patient-information
    resource: 'Bundle.entry.resource.ofType(Patient)'
    condition: '%resource.count() = 1'
    required: true
    schema: classpath:/metadata/hl7_mapping/ORU_R01/base/patient.yml

  - name: patient-note
    resource: 'Bundle.entry.resource.ofType(Patient).extension(%`rsext-patient-notes`).value'
    condition: 'Bundle.entry.resource.ofType(Patient).extension(%`rsext-patient-notes`).exists()'
    schema: classpath:/metadata/hl7_mapping/datatypes/annotation/NTE.yml
    resourceIndex: noteIndex
    constants:
      hl7NotePath: '/PATIENT_RESULT/PATIENT'

  - name: encounter-pv1
    resource: 'Bundle.entry.resource.ofType(Encounter)'
    condition: '%resource.count() = 1'
    constants:
      hl7PV1Field: '/PATIENT_RESULT/PATIENT/VISIT/PV1'
    schema: classpath:/metadata/hl7_mapping/resources/Encounter/PV1.yml

  - name: encounter-pv2
    resource: 'Bundle.entry.resource.ofType(Encounter)'
    condition: '%resource.count() = 1'
    constants:
      hl7PV2Field: '/PATIENT_RESULT/PATIENT/VISIT/PV2'
    schema: classpath:/metadata/hl7_mapping/resources/Encounter/PV2.yml

  - name: order-observations
    resource: 'Bundle.entry.resource.ofType(DiagnosticReport)'
    condition: '%resource.count() > 0'
    required: true
    schema: classpath:/metadata/hl7_mapping/ORU_R01/base/order-observation.yml
    resourceIndex: orderIndex

  - name: participation-request
    resource: 'Bundle.entry.resource.ofType(Device).where(udiCarrier.exists())'
    condition: 'Bundle.entry.resource.ofType(Device).udiCarrier.exists()'
    constants:
      hl7SegmentGroup: '/PATIENT_RESULT/PATIENT/PATIENT_OBSERVATION'
    schema: classpath:/metadata/hl7_mapping/resources/Device/PRT.yml
    resourceIndex: prtDeviceIndex

  - name: related-person-nk1
    resource: 'Bundle.entry.resource.ofType(RelatedPerson).where(extension(%`rsext-hl7v2Segment`).value = "NK1")'
    condition: '%resource.patient.exists()'
    constants:
      hl7SegmentGroup: '/PATIENT_RESULT/PATIENT'
    schema: classpath:/metadata/hl7_mapping/resources/RelatedPerson/NK1.yml
    resourceIndex: relatedPersonIndex
