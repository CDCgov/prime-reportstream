constants:
  fieldPath: /PATIENT_RESULT/ORDER_OBSERVATION(%{orderIndex})/OBR
elements:
  - name: observation-request
    schema: classpath:/metadata/hl7_mapping/common/observation-request.yml

  - name: order-organization-identifier
    condition: '%diagnostic.identifier.type.empty()'
    resource: '%resource.basedOn.resolve().performer.resolve()'
    constants:
      organizationIdFieldPath: '%{fieldPath}-3'
      identifier: '%diagnostic.identifier[0].value'
    schema: classpath:/metadata/hl7_mapping/common/organization-identifier.yml

  - name: observation-request-date-time
    condition: '%context.effective.exists() and %context.effective.is(dateTime)'
    resource: '%resource.effective'
    constants:
      dtmFieldPath: '%{fieldPath}-7'
    schema: classpath:/metadata/hl7_mapping/datatypes/dateTime/DTMorDT.yml

  - name: observation-request-date-time-start
    condition: '%context.effective.exists() and %context.effective.is(Period)'
    resource: '%resource.effective.start'
    constants:
      dtmFieldPath: '%{fieldPath}-7'
    schema: classpath:/metadata/hl7_mapping/datatypes/dateTime/DTMorDT.yml

  - name: observation-date-time-end
    condition: '%context.effective.exists() and %context.effective.is(Period)'
    resource: '%resource.effective.end'
    constants:
      dtmFieldPath: '%{fieldPath}-8'
    schema: classpath:/metadata/hl7_mapping/datatypes/dateTime/DTMorDT.yml

  - name: collector-identifier
    resource: '%service.extension(%`rsext-collector-identifier`).value.resolve()'
    constants:
      hl7XCNField: '%{fieldPath}-10'
    schema: classpath:/metadata/hl7_mapping/resources/Practitioner/XCN.yml
    resourceIndex: contactIndex

  - name: relevant-clinical-information
    resource: '%service.extension(%`rsext-clinical-information`)'
    condition: '%resource.exists()'
    value: [ '%resource.value' ]
    hl7Spec: [ '%{fieldPath}-13' ]

  - name: ordering-provider
    resource: '%service.requester.resolve().practitioner.resolve()'
    constants:
      hl7XCNField: '%{fieldPath}-16'
    schema: classpath:/metadata/hl7_mapping/common/datatype/xcn-contact.yml
    resourceIndex: contactIndex

  - name: callback-phone-number
    resource: '%service.requester.resolve().practitioner.resolve().telecom'
    condition: '%resource.exists()'
    constants:
      hl7TelecomField: '%{fieldPath}-17'
    schema: classpath:/metadata/hl7_mapping/common/datatype/xtn-telecom.yml
    resourceIndex: telecomIndex

  - name: placer-field
    resource: '%service.extension(%`rsext-placer-field-1`)'
    condition: '%resource.exists()'
    value: [ '%resource.value' ]
    hl7Spec: [ '%{fieldPath}-18' ]

  - name: placer-field-2
    resource: '%service.extension(%`rsext-placer-field-2`)'
    condition: '%resource.exists()'
    value: [ '%resource.value' ]
    hl7Spec: [ '%{fieldPath}-19' ]

  - name: filler-field-1
    resource: '%service.extension(%`rsext-filler-field-1`)'
    condition: '%resource.exists()'
    value: [ '%resource.value' ]
    hl7Spec: [ '%{fieldPath}-20' ]

  - name: filler-field-2
    resource: '%service.extension(%`rsext-filler-field-2`)'
    condition: '%resource.exists()'
    value: [ '%resource.value' ]
    hl7Spec: [ '%{fieldPath}-21' ]

  - name: results-reported-at
    resource: '%resource.issued'
    constants:
      dtmFieldPath: '%{fieldPath}-22'
    schema: classpath:/metadata/hl7_mapping/datatypes/dateTime/DTMorDT.yml

  - name: diagnostic-serv-sect-id
    value: [ '%resource.category.coding.code' ]
    hl7Spec: [ '%{fieldPath}-24' ]

  - name: result-status
    resource: '%resource.status'
    condition: '%resource.exists()'
    value: [ '%resource' ]
    hl7Spec: [ '%{fieldPath}-25' ]
    valueSet:
      values:
        partial: A
        corrected: C
        amended: C
        final: F
        preliminary: P
        cancelled: X

  - name: parent-observation-link
    resource: '%resource.identifier.where(type.coding[0].system = "http://loinc.org").type'
    constants:
      ceFieldPath: '%{fieldPath}-26-1'
    schema: classpath:/metadata/hl7_mapping/common/datatype/ce-coded-element.yml

  - name: parent-observation-sub-id
    resource: '%resource.extension(%`rsext-parent-observation-sub-id`)'
    condition: '%resource.exists()'
    value: [ '%resource.value' ]
    hl7Spec: [ '%{fieldPath}-26-2' ]

  - name: parent-observation-value-descriptor
    resource: '%resource.extension(%`rsext-parent-observation-value-descriptor`)'
    condition: '%resource.exists()'
    value: [ '%resource.value' ]
    hl7Spec: [ '%{fieldPath}-26-3' ]

  - name: placer-assigned-identifier
    resource: '%resource.extension(%`rsext-placer-assigned-identifier`).value'
    condition: '%resource.exists()'
    constants:
      entityIdFieldPath: '%{fieldPath}(%{entityIdIndex})-29-1'
    schema: classpath:/metadata/hl7_mapping/common/datatype/ei-entity-identifier.yml
    resourceIndex: entityIdIndex

  - name: filler-assigned-identifier
    resource: '%resource.extension(%`rsext-filler-assigned-identifier`).value'
    condition: '%resource.exists()'
    constants:
      entityIdFieldPath: '%{fieldPath}(%{entityIdIndex})-29-2'
    schema: classpath:/metadata/hl7_mapping/common/datatype/ei-entity-identifier.yml
    resourceIndex: entityIdIndex

  - name: reason-for-study
    resource: '%service.reasonCode'
    constants:
      ceFieldPath: '%{fieldPath}-31(%{reasonIndex})'
    schema: classpath:/metadata/hl7_mapping/common/datatype/ce-coded-element.yml
    resourceIndex: reasonIndex


  - name: collectors-comment
    condition: >
      %specimen.note.where(extension(%`rsext-cwe-annotation`)).exists() and
      %specimen.note.extension(%`rsext-cwe-annotation`).value.where(extension(%`rsext-hl7v2Field`).value = "collectors-comment").exists()
    resource: '%specimen.note.extension(%`rsext-cwe-annotation`).value.where(extension(%`rsext-hl7v2Field`).value = "collectors-comment")'
    resourceIndex: cweIndex
    constants:
      cweField: '%{fieldPath}-39(%{cweIndex})'
    schema: classpath:/metadata/hl7_mapping/datatypes/codeableConcept/CWE.yml