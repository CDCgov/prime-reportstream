constants:
  hl7Order: '/PATIENT_RESULT/ORDER_OBSERVATION(%{orderIndex})'
  diagnostic: 'Bundle.entry.resource.ofType(DiagnosticReport)[%orderIndex]'
  service: 'Bundle.entry.resource.ofType(DiagnosticReport)[%orderIndex].basedOn.resolve()'
  specimen: 'Bundle.entry.resource.ofType(DiagnosticReport)[%orderIndex].specimen.resolve()'
  hl7ObservationNotes: '/PATIENT_RESULT/ORDER_OBSERVATION(%{orderIndex})/OBSERVATION'
  hl7ObservationPath: '/PATIENT_RESULT/ORDER_OBSERVATION(%{orderIndex})/OBSERVATION'
elements:

  - name: common-order-service-request
    resource: '%service'
    schema: classpath:/metadata/hl7_mapping/resources/ServiceRequest/ORC.yml

  - name: common-order-diagnostic-report
    resource: '%diagnostic'
    schema: classpath:/metadata/hl7_mapping/resources/DiagnosticReport/ORC.yml

  - name: observation-request-service-request
    resource: '%service'
    schema: classpath:/metadata/hl7_mapping/resources/ServiceRequest/OBR.yml

  - name: observation-request-diagnostic-report
    resource: '%diagnostic'
    schema: classpath:/metadata/hl7_mapping/resources/DiagnosticReport/OBR.yml

  - name: specimen
    resource: '%specimen'
    resourceIndex: specimenIndex
    condition: '%specimen.exists()'
    schema: classpath:/metadata/hl7_mapping/resources/Specimen/SPM.yml
    constants:
      hl7SpecimenFieldPath: /PATIENT_RESULT/ORDER_OBSERVATION(%{orderIndex})/SPECIMEN/SPM
      performerOrganization: '%diagnostic.basedOn.resolve().performer.resolve()'

  - name: timing-segment
    resource: '%service'
    # Only create the segment if we have data for it
    condition: >
      %resource.occurrence.repeat.bounds.start.exists() or
      %resource.occurrence.repeat.bounds.end.exists() or
      %resource.priority.exists() or
      %resource.extension(%`rsext-service-priority`).exists()
    schema: classpath:/metadata/hl7_mapping/ORU_R01/base/timing-quantity.yml

  # Grab only the AOE observations from ServiceRequest.supportingInfo NOT associated with a specimen
  - name: observation-result-with-aoe
    resource: '%resource.result.resolve() | %service.supportingInfo.resolve().where(specimen.exists().not())'
    schema: classpath:/metadata/hl7_mapping/resources/Observation/OBX.yml
    resourceIndex: resultIndex
    constants:
      hl7OBXField: '/PATIENT_RESULT/ORDER_OBSERVATION(%{orderIndex})/OBSERVATION(%{resultIndex})/OBX'

  - name: order-note
    resource: '%service.note'
    schema: classpath:/metadata/hl7_mapping/datatypes/annotation/NTE.yml
    resourceIndex: noteIndex
    constants:
      hl7NotePath: '%{hl7Order}'