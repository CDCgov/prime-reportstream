extends: classpath:/metadata/fhir_transforms/senders/original-pipeline-transforms.yml

elements:
  - name: patient-state-from-zip-code
    resource: "Bundle.entry.resource.ofType(Patient).address"
    bundleProperty: '%resource.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/state-from-zip-code").value[x]'
    value: [ '%resource.postalCode.getStateFromZipCode()' ]

  - name: ordering-facility-state-from-zip-code
    resource: "Bundle.entry.resource.ofType(ServiceRequest).requester.resolve().organization.resolve().address"
    bundleProperty: '%resource.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/state-from-zip-code").value[x]'
    value: [ '%resource.postalCode.getStateFromZipCode()' ]

  # Ticket 16776
  # Temporary override for MSH 5 and 6 until original fields are updated

  - name: msh-5-1-override
    resource: 'Bundle.entry.resource.ofType(MessageHeader).destination.where(extension("https://reportstream.cdc.gov/fhir/StructureDefinition/hl7v2Field").value = "MSH.5")'
    bundleProperty: '%resource.name'
    value: [ '"CDC PRIME"' ]

  - name: msh-5-2-override
    resource: 'Bundle.entry.resource.ofType(MessageHeader).destination.where(extension("https://reportstream.cdc.gov/fhir/StructureDefinition/hl7v2Field").value = "MSH.5")'
    bundleProperty: '%resource.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/universal-id").value[x]'
    value: [ '"2.16.840.1.114222.4.1.237821"' ]

  - name: msh-5-3-override
    resource: 'Bundle.entry.resource.ofType(MessageHeader).destination.where(extension("https://reportstream.cdc.gov/fhir/StructureDefinition/hl7v2Field").value = "MSH.5")'
    bundleProperty: '%resource.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/universal-id-type").value[x]'
    value: [ '"ISO"' ]

  - name: msh-6-1-override
    resource: 'Bundle.entry.resource.ofType(MessageHeader).destination.receiver.resolve().where(extension("https://reportstream.cdc.gov/fhir/StructureDefinition/hl7v2Field").value = "MSH.6")'
    bundleProperty: '%resource.name'
    value: [ '"CDC PRIME"' ]

  - name: msh-6-2-override
    resource: 'Bundle.entry.resource.ofType(MessageHeader).destination.receiver.resolve().where(extension("https://reportstream.cdc.gov/fhir/StructureDefinition/hl7v2Field").value = "MSH.6")'
    bundleProperty: '%resource.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/universal-id").value[x]'
    value: [ '"2.16.840.1.114222.4.1.237821"' ]

  - name: msh-6-3-override
    resource: 'Bundle.entry.resource.ofType(MessageHeader).destination.receiver.resolve().where(extension("https://reportstream.cdc.gov/fhir/StructureDefinition/hl7v2Field").value = "MSH.6")'
    bundleProperty: '%resource.extension("https://reportstream.cdc.gov/fhir/StructureDefinition/universal-id-type").value[x]'
    value: [ '"ISO"' ]