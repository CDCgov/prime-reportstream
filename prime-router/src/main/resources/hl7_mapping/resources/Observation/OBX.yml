elements:
  - name: obx-set-id
    value: [ '%resultIndex + 1' ]
    hl7Spec: [ '%{hl7OBXField}-1' ]

  - name: obx-code
    resource: '%resource.code'
    schema: classpath:/hl7_mapping/datatypes/codeableConcept/CWE
    constants:
      cweField: '%{hl7OBXField}-3'

  - name: obx-sub-id
    value: [ '%resource.extension(%`rsext-sub-id`).value' ]
    hl7Spec: [ '%{hl7OBXField}-4' ]

  - name: obx-value
    schema: classpath:/hl7_mapping/resources/Observation/OBXValue

  - name: obx-references-range
    value: [ '%resource.referenceRange.text' ]
    hl7Spec: [ '%{hl7OBXField}-7' ]

  - name: obx-interpretation-codes
    resource: '%resource.interpretation'
    schema: classpath:/hl7_mapping/datatypes/codeableConcept/CWE
    resourceIndex: interpretationIndex
    constants:
      cweField: '%{hl7OBXField}-8(%{interpretationIndex})'

  - name: obx-nature-of-abnormal-test
    resource: '%resource.extension(%`rsext-nature-of-abnormal-test`)'
    schema: classpath:/hl7_mapping/resources/Observation/NatureOfAbnormalTest
    resourceIndex: abnormalTestIndex


  - name: obx-datetime-of-observation
    value: [ '%resource.effective.extension(%`rsext-hl7v2-date-time`).value' ]
    hl7Spec: [ '%{hl7OBXField}-14' ]

  - name: obx-producer-id
    resource: '%resource.performer.resolve().ofType(Organization).where(extension(%`rsext-hl7-use`).value.join(",").contains("obx-15-producer-id"))'
    schema: classpath:/hl7_mapping/resources/Organization/CWE
    constants:
      organizationCWEFieldPath: '%{hl7OBXField}-15'

  - name: obx-responsible-observer
    resource: '%resource.performer.resolve().where(code.coding.code = "responsibleObserver").practitioner.resolve()'
    schema: classpath:/hl7_mapping/resources/Practitioner/XCN
    resourceIndex: responsibleObserverIndex
    constants:
      hl7XCNField: '%{hl7OBXField}-16(%{responsibleObserverIndex})'

  - name: obx-observation-method
    resource: '%resource.method.union(%resource.extension(%`rsext-obx-observation`).extension.where(url = "obx-17-observation-method").tail().value)'
    schema: classpath:/hl7_mapping/datatypes/codeableConcept/CWE
    resourceIndex: observationMethodIndex
    constants:
      cweField: '%{hl7OBXField}-17(%{observationMethodIndex})'

  - name: obx-equipment-instance-identifier
    resource: '%resource.device.resolve().identifier.union(%resource.extension(%`rsext-obx-observation`).extension.where(url = "obx-18-equipment-instance-identifier").tail().value.resolve().identifier)'
    schema: classpath:/hl7_mapping/datatypes/identifier-extension/EI
    resourceIndex: equipmentInstanceIdentifierIndex
    constants:
      eiFieldPath: '%{hl7OBXField}-18(%{equipmentInstanceIdentifierIndex})'

  - name: obx-datetime-of-analysis
    value: [ '%resource.extension(%`rsext-analysis-date-time`).value.extension(%`rsext-hl7v2-date-time`).value' ]
    hl7Spec: [ '%{hl7OBXField}-19' ]

  - name: obx-observation-method
    resource: '%resource.bodySite.union(%resource.extension(%`rsext-obx-observation`).extension.where(url = "obx-20-observation-site").tail().value)'
    schema: classpath:/hl7_mapping/datatypes/codeableConcept/CWE
    resourceIndex: observationMethodIndex
    constants:
      cweField: '%{hl7OBXField}-20(%{observationMethodIndex})'

  - name: obx-observation-instance-identifier
    resource: '%resource.identifier.where(extension(%`rsext-hl7-use`).value = "obx-21-observation-instance-identifier")'
    schema: classpath:/hl7_mapping/datatypes/identifier-extension/EI
    constants:
      eiFieldPath: '%{hl7OBXField}-21'

  - name: obx-performing-organization-name-from-org
    resource: '%resource.performer.resolve().ofType(Organization).where(extension(%`rsext-hl7-use`).value.join(",").contains("obx-25-performing-organization"))'
    schema: classpath:/hl7_mapping/resources/Organization/XON
    constants:
      hl7XONField: '%{hl7OBXField}-23'

  - name: obx-performing-organization-name-from-practitioner-role
    resource: '%resource.performer.resolve().ofType(PractitionerRole).where(code.coding.code = "MDIR").organization.resolve()'
    schema: classpath:/hl7_mapping/resources/Organization/XON
    constants:
      hl7XONField: '%{hl7OBXField}-23'

  - name: obx-performing-organization-address-from-org
    resource: '%resource.performer.resolve().ofType(Organization).where(extension(%`rsext-hl7-use`).value.join(",").contains("obx-25-performing-organization")).address'
    schema: classpath:/hl7_mapping/datatypes/Address/XAD
    constants:
      xadField: '%{hl7OBXField}-24'

  - name: obx-performing-organization-address-from-practitioner-role
    resource: '%resource.performer.resolve().ofType(PractitionerRole).where(code.coding.code = "MDIR").organization.resolve().address'
    schema: classpath:/hl7_mapping/datatypes/Address/XAD
    constants:
      xadField: '%{hl7OBXField}-24'

  - name: obx-performing-organization-medical-director
    resource: '%resource.performer.resolve().ofType(PractitionerRole).where(code.coding.code = "MDIR").practitioner.resolve()'
    schema: classpath:/hl7_mapping/resources/Practitioner/XCN
    constants:
      hl7XCNField: '%{hl7OBXField}-25'

  - name: observation-aoe-identifier
    condition: '%resource.meta.tag.code="AOE"'
    value: [ '"QST"' ]
    hl7Spec: [ '%{hl7OBXField}-29' ]

  - name: obx-observation-sub-type
    value: [ '%resource.extension(%`rsext-observation-sub-type`).value' ]
    hl7Spec: [ '%{hl7OBXField}-30' ]

  - name: obx-value-attachment
    resource: '%resource.extension("https://hl7.org/fhir/R5/StructureDefinition/observation-value-attachment").value'
    schema: classpath:/hl7_mapping/datatypes/Attachment/ED
    constants:
      hl7EDField: '%{hl7OBXField}-5'

  - name: obx-extension-values
    resource: '%resource.extension(%`rsext-obx-observation`)'
    schema: classpath:/hl7_mapping/resources/Observation/OBXExtension

  - name: observation-note
    resource: '%resource.note'
    schema: classpath:/hl7_mapping/datatypes/annotation/NTE
    resourceIndex: noteIndex
    constants:
      hl7NotePath: '%{hl7ObservationPath}'

