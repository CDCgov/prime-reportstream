elements:

  - name: obx-value-st
    condition: '%context.extension(%`rsext-obx-observation`).extension.where(url = "obx-2-value-type").value = "ST"'
    value: [ '%resource.value' ]
    hl7Spec: [ '%{hl7OBXField}-5' ]

  - name: obx-value-ft
    condition: '%context.extension(%`rsext-obx-observation`).extension.where(url = "obx-2-value-type").value = "FT"'
    value: [ '%resource.value' ]
    hl7Spec: [ '%{hl7OBXField}-5' ]

  - name: obx-value-tx
    condition: '%context.extension(%`rsext-obx-observation`).extension.where(url = "obx-2-value-type").value = "TX"'
    value: [ '%resource.value' ]
    hl7Spec: [ '%{hl7OBXField}-5' ]

  - name: obx-value-tm
    condition: '%context.extension(%`rsext-obx-observation`).extension.where(url = "obx-2-value-type").value = "TM"'
    value: [ '%resource.value.extension(%`rsext-hl7v2-date-time`).value' ]
    hl7Spec: [ '%{hl7OBXField}-5' ]


  - name: obx-value-vr-1
    condition: '%context.extension(%`rsext-obx-observation`).extension.where(url = "obx-2-value-type").value = "VR"'
    value: [ '%resource.value.split("-").first()' ]
    hl7Spec: [ '%{hl7OBXField}-5-1' ]

  - name: obx-value-vr-2
    condition: '%context.extension(%`rsext-obx-observation`).extension.where(url = "obx-2-value-type").value = "VR"'
    value: [ '%resource.value.split("-").last()' ]
    hl7Spec: [ '%{hl7OBXField}-5-2' ]

  - name: obx-value-sn-string-1
    condition: '%context.extension(%`rsext-obx-observation`).extension.where(url = "obx-2-value-type").value = "SN" and %resource.value.is(string) and %resource.value.contains("+")'
    value: [ '%resource.value.split("+")[0]' ]
    hl7Spec: [ '%{hl7OBXField}-5-1' ]

  - name: obx-value-sn-string-2
    condition: '%context.extension(%`rsext-obx-observation`).extension.where(url = "obx-2-value-type").value = "SN" and %resource.value.is(string) and %resource.value.contains("+")'
    value: [ '%resource.value.split("+")[1]' ]
    hl7Spec: [ '%{hl7OBXField}-5-2' ]

  - name: obx-value-sn-string-3
    condition: '%context.extension(%`rsext-obx-observation`).extension.where(url = "obx-2-value-type").value = "SN" and %resource.value.is(string) and %resource.value.contains("+")'
    value: [ '%resource.value.split("+")[2]' ]
    hl7Spec: [ '%{hl7OBXField}-5-3' ]

  - name: obx-value-sn-string-4
    condition: '%context.extension(%`rsext-obx-observation`).extension.where(url = "obx-2-value-type").value = "SN" and %resource.value.is(string) and %resource.value.contains("+")'
    value: [ '%resource.value.split("+")[3]' ]
    hl7Spec: [ '%{hl7OBXField}-5-4' ]

  - name: obx-value-sn
    condition: '%context.extension(%`rsext-obx-observation`).extension.where(url = "obx-2-value-type").value = "SN"'
    schema: classpath:/hl7_mapping/datatypes/extensionSN/SN
    resource: '%resource.extension(%`rsext-obx-5-value-sn`)'
    constants:
      hl7SNField: '%{hl7OBXField}-5'

  - name: obx-value-cne
    condition: '%context.extension(%`rsext-obx-observation`).extension.where(url = "obx-2-value-type").value = "CNE"'
    schema: classpath:/hl7_mapping/datatypes/codeableConcept/CNE
    resource: '%resource.value'
    constants:
      cneFieldPath: '%{hl7OBXField}-5'

  - name: obx-value-ce
    condition: '%context.extension(%`rsext-obx-observation`).extension.where(url = "obx-2-value-type").value = "CE"'
    schema: classpath:/hl7_mapping/datatypes/codeableConcept/CE
    resource: '%resource.value'
    constants:
      ceFieldPath: '%{hl7OBXField}-5'

  - name: obx-value-cwe
    condition: '%context.extension(%`rsext-obx-observation`).extension.where(url = "obx-2-value-type").value = "CWE"'
    schema: classpath:/hl7_mapping/datatypes/codeableConcept/CWE
    resource: '%resource.value'
    constants:
      cweField: '%{hl7OBXField}-5'

  - name: obx-value-is
    condition: '%context.extension(%`rsext-obx-observation`).extension.where(url = "obx-2-value-type").value = "IS"'
    value: [ '%resource.value.coding.code' ]
    hl7Spec: [ '%{hl7OBXField}-5' ]

  - name: obx-value-dr
    condition: '%context.extension(%`rsext-obx-observation`).extension.where(url = "obx-2-value-type").value = "DR"'
    resource: '%resource.value'
    schema: classpath:/hl7_mapping/resources/Patient/DR # TODO this should be moved
    constants:
      hl7DRField: '%{hl7OBXField}-5'

  - name: obx-value-dtm-dt
    condition: '%context.extension(%`rsext-obx-observation`).extension.where(url = "obx-2-value-type").value = "DTM" or %context.extension(%`rsext-obx-observation`).extension.where(url = "obx-2-value-type").value = "DT"'
    value: [ '%resource.value.extension(%`rsext-hl7v2-date-time`).value' ]
    hl7Spec: [ '%{hl7OBXField}-5' ]

  - name: obx-value-nr
    condition: '%context.extension(%`rsext-obx-observation`).extension.where(url = "obx-2-value-type").value = "NR"'
    schema: classpath:/hl7_mapping/datatypes/Range/NR
    resource: '%resource.value'
    constants:
      hl7NRField: '%{hl7OBXField}-5'


  - name: obx-value-nm
    condition: '%context.extension(%`rsext-obx-observation`).extension.where(url = "obx-2-value-type").value = "NM"'
    value: [ '%resource.value.value' ]
    hl7Spec: [ '%{hl7OBXField}-5' ]



