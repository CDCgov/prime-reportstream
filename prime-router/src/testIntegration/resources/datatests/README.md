# Conversion Tests Configuration and File Generation

The translation tests test that input data is correctly converted to the target format by
comparing expected data to the actual data translated by the code. This test is driven by a
configuration file where you specify the input and expected parameters of the test.

## Limitations

For HL7 outputs, the expected report and generated actual data must have only one HL7 message

## Configuration

The configuration file for this test is `converstion-test-config.csv`. This file is a
command separated file with a header, and a row per test to perform. The columns are:

- **Input File** - the relative path to the input report. This path is relative to
  src/testIntegration/resources/datatests and must have an extension of hl7,
  csv or .internal.csv
  Note the path to the file must be in the src/test
- **Input schema** - the schema of the input data
- **Expected File** - the relative path to the report with the expected data. This path is
  relative to src/testIntegration/resources/datatests and must have an extension of
  hl7, csv or .internal.csv  
  The test will convert the input data into the same format as the expected file.
- **Output schema** - the schema to translate the data to
- **Output format** - HL7, HL7_BATCH, CSV or INTERNAL
- **Result** - set to PASS to denote the test is expected to pass, FAIL for tests that
  expected to fail.

## Generating Expected Data Files

Expected data files could be generated by hand, but it is recommended that you create
the initial file using the prime CLI tool. Based on the configuration you specify, the
prime CLI command will look as follows:

`./prime data --input-schema <Input Schema> --input <Input File>
--output-schema <Output schema> --output-format <Output format>
--output-dir <Your output folder> --output <Your output filename>`
`

E.g.
`./prime data --input-schema primedatainput/pdi-covid-19
--input ./src/testIntegration/resources/datatests/CSV_to_HL7/sample-batch-pdi-20210608-0001.csv
--output-schema hl7/test-covid-19 --output-format HL7_BATCH
--output-dir ./ --output
./src/testIntegration/resources/datatests/CSV_to_HL7/test1.hl7`

`./prime data --input-schema  hl7/test-covid-19 --input
./src/testIntegration/resources/datatests/HL7_to_INTERNAL/CE-20200415-0001.hl7
--output-schema covid-19 --output-format INTERNAL --output-dir ./
--output
./src/testIntegration/resources/datatests/HL7_to_INTERNAL/test1.internal.csv`

## Generating id-less Files to Assist PR Reviews

Everytime a FHIR file is regenerated, the ids will be different, making the diff view in a PR very difficult to read.
In `./src/testIntegration/resources/datatests/HL7_to_FHIR/` there are versions of `fhir` files with the ids removed,
so by editing these whenever the expected FHIR changes, reviewers can more easily see what changed. In order to generate
these, copy/paste (paste as plain text to avoid formatting issues) the contents from the updated `.fhir` file into the
associated `xxx.fhir` file. Then, using an IDE or another tool, search for the regex
`[0-9]{19}\.[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}` and replace occurrences of it with
`xxxxxxxxxxxxxxxxxxx.xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx`. Then do the same with the regex
`[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}` and the replacement string
`xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx`. The resulting list of changes in the `xxx.fhir` files should only be timestamps
and whatever FHIR conversion changes your PR produced.