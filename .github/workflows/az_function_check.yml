name: Azure Function Deployment

on:
  push:
    branches:
      - feature/65-Add-check-fa-for-monitoring-tasktable

jobs:
  deploy:
    runs-on: ubuntu-latest
    # strategy:
    #   matrix:
    #     FA: [pdhtest-admin-functionapp, pdhstaging-admin-functionapp, pdhprod-admin-functionapp] 
    #     RG: [prime-data-hub-test, prime-data-hub-staging, prime-data-hub-prod]

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e5e7e5ab8b370d6c329ec480221332ada57f0ab

      - name: Connect to VPN & Login into Azure  
        uses: ./.github/actions/vpn-azure
        with:
          tls-key: ${{ secrets.TLS_KEY }}
          ca-cert: ${{ secrets.CA_CRT}}
          user-crt: ${{ secrets.USER_CRT }}
          user-key: ${{ secrets.USER_KEY }}
          sp-creds: ${{ secrets.SERVICE_PRINCIPAL_CREDS }}

      - name: Run Azure Function
        id: run_function
        run: |
          az functionapp function run --function-name TaskTableChecks --resource-group prime-data-hub-staging --name pdhstaging-admin-functionapp >> result.json
          cat result.json

      - name: Format output
        id: format_out
        run: |
          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "LIST<<$EOF" >> $GITHUB_OUTPUT
          cat result.json >> $GITHUB_OUTPUT
          echo "$EOF" >> $GITHUB_OUTPUT

      - name: Slack Notification    
        if: ${{ steps.format_out.outputs.LIST  != '' }}        
        uses: ./.github/actions/notifications
        with:
          method: slack
          title: Found data older than 10 minutes in the public.task table
          message: |
            ${{ steps.format_out.outputs.LIST }}
          icon-emoji: ':bell:'
          channel: pagerduty-alert-dump
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          color: warning

        