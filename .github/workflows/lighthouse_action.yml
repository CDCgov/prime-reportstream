name: Build project and Run Lighthouse CI
on:
 push:
   branches:
     - feature/3053-508compliance
jobs:
 lhci:
   name: Lighthouse
   runs-on: ubuntu-latest
   steps:
     - name: Check out changes
       uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332
     - name: Use Node.js with yarn
       uses: actions/setup-node@1e60f620b9541d16bece96c5465dc8ee9832be0b
       with:
        node-version-file: frontend-react/.nvmrc
        cache: yarn
        cache-dependency-path: frontend-react/yarn.lock

     - name: Yarn install
       run: yarn install --immutable

     -  run: yarn install
        working-directory: frontend-react
        shell: bash
 
     - name: Build and run lighthouse
       uses: ./.github/actions/retry
       with:
         timeout_minutes: 10
         max_attempts: 1
         retry_wait_seconds: 0
         command: |
           set -e pipefail
           cd frontend-react
           ENV="test"
           if [[ $ENV != demo* && $ENV != "test" && $ENV != trialfrontend* ]]; then ENV="staging"; fi
           echo "" >> .env.$ENV
           echo "VITE_APPINSIGHTS_KEY=${{ inputs.appinsights-staging-key }}" >> .env.$ENV
           echo "::group::Build"
           yarn build:$ENV
           echo "::endgroup::"
         shell: bash
     
     - name: Upload Lighthouse Report
       run: |
         yarn add -D @lhci/cli
         yarn lhci autorun        
       env:
         LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
         