name: "WIP - Prepare the deployment branch"

on:
  push:
    branches:
      - "td/auto-branch-1851"
  # schedule:
  #   # At 16:00 on Monday and Wednesday (https://crontab.guru/#0_16_*_*_1,3)
  #   # GitHub actions run in UTC (and EDT is UTC-4)
  #   - cron: "0 16 * * 1,3"

jobs:
  prepare_branch:
    name: Prepare the deployment branch
    runs-on: ubuntu-latest
    steps:
      - name: "Check out changes"
        uses: actions/checkout@v2

      - name: Set Environment Variables
        # TODO: de-uniquify the branch name (this is here for testing purposes)
        # 86400: seconds in a 24h time-window
        run: |
          let TOMORROWS_SECONDS_SINCE_EPOCH=$(date +%s)+86400
          DEPLOYMENT_DATE=$(date --date=@${TOMORROWS_SECONDS_SINCE_EPOCH} +%Y-%m-%d)
          echo >> ${GITHUB_ENV} DEPLOYMENT_DATE=${DEPLOYMENT_DATE?}
          echo >> ${GITHUB_ENV} BRANCH_NAME=td/WIP-ignore-deployment-${DEPLOYMENT_DATE?}

      - name: Output Branch Name
        # TODO: de-uniquify the branch name (this is here for testing purposes)
        run: |
          echo "Branch name: \"${BRANCH_NAME}\""
          cat "${GITHUB_ENV}"

      - name: "Create a new branch that contains the changes to go into the deployment"
        uses: peterjgrainger/action-create-branch@v2.0.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          branch: "${{ env.BRANCH_NAME }}"

      - name: "Prepare a Pull Request from ${{ env.BRANCH_NAME }} into target branch" # TODO: Fix name
        id: pr
        uses: sudoStatus200/create-sync-pr@0.3.1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SOURCE_BRANCH: "${{ env.BRANCH_NAME }}"
          TARGET_BRANCH: "td/IGNORE-dest-1"     # TODO: Change this to production

      - name: "Produce Pull Request URL"
        run: |
          echo "PR URL:       ${{ steps.pr.outputs.PULL_REQUEST_URL }}"
          echo "PR Id:        ${{ steps.pr.outputs.PULL_REQUEST_NUMBER }}"
