name: "WIP - Prepare the deployment branch"

on:
  push:
    branches:
      - "td/auto-branch-1851"
  # schedule:
  #   # At 16:00 on Monday and Wednesday (https://crontab.guru/#0_16_*_*_1,3)
  #   # GitHub actions run in UTC (and EDT is UTC-4)
  #   - cron: "0 16 * * 1,3"

jobs:
  prepare_branch:
    name: Prepare the deployment branch
    runs-on: ubuntu-latest
    steps:
      - name: "Check out changes"
        uses: actions/checkout@v2

      - name: Set Environment Variables
        # TODO: de-uniquify the branch name (this is here for testing purposes)
        # 86400: seconds in a 24h time-window
        run: |
          let TOMORROWS_SECONDS_SINCE_EPOCH=$(date +%s)+86400
          echo >> ${GITHUB_ENV} DEPLOYMENT_DATE=$(date --date=@${TOMORROWS_SECONDS_SINCE_EPOCH?} +%Y-%m-%d)
          echo >> ${GITHUB_ENV} BRANCH_NAME=td/WIP-ignore-deployment-${DEPLOYMENT_DATE?}

      - name: Output Branch Name
        # TODO: de-uniquify the branch name (this is here for testing purposes)
        run: |
          echo "Branch name: \"${BRANCH_NAME}\""
          cat "${GITHUB_ENV?}"

      - name: "Create deployment branch"
        uses: peterjgrainger/action-create-branch@v2.0.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          branch: "${{ env.BRANCH_NAME }}"

      - name: "Create PR from deployment branch into production"
        id: cpr
        uses: peter-evans/create-pull-request@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: "td/1851-target-ignore"
          assignees: td-usds
          title: "[Deployment] Deployment branch for ${{ env.DEPLOYMENT_DATE }}"
          body: |
            This PR contains the deployment for ${{ env.DEPLOYMENT_DATE }}

      - name: "Produce Pull Request URL"
        run: |
          echo "Created Pull Request: ${{ steps.cpr.outputs.pull-request-url }}"
