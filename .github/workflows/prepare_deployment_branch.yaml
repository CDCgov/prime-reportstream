name: "WIP - Prepare the deployment branch"

on:
  push:
    branches:
      - "td/auto-branch-1851"
  # schedule:
  #   # At 16:00 on Monday and Wednesday (https://crontab.guru/#0_16_*_*_1,3)
  #   # GitHub actions run in UTC (and EDT is UTC-4)
  #   - cron: "0 16 * * 1,3"

jobs:
  prepare_branch:
    name: Prepare the deployment branch
    runs-on: ubuntu-latest
    steps:
      - name: "Check out changes"
        uses: actions/checkout@v2

      - name: Set Environment Variables
        run: |
          if [ "$GITHUB_BASE_REF" == "production" ]
          then
              echo "Building for the production environment."
              echo >> $GITHUB_ENV ACR_REPO=pdhprodcontainerregistry.azurecr.io
              echo >> $GITHUB_ENV PREFIX=pdhprod
          else
              echo "Building for the test environment."
              echo >> $GITHUB_ENV ACR_REPO=pdhstagingcontainerregistry.azurecr.io
              echo >> $GITHUB_ENV PREFIX=pdhstaging
          fi

      - name: Set Environment Variables
        # TODO: de-uniquify the branch name (this is here for testing purposes)
        run: |
          echo >> $GITHUB_ENV $BRANCH_NAME=td/WIP-ignore-deployment-$(date +%Y-%m-%d_%HH%MM%SS)

      - name: Output Branch Name
        # TODO: de-uniquify the branch name (this is here for testing purposes)
        run: |
          echo "Branch name: \"${BRANCH_NAME}\""
          export

      - name: "Create deployment branch"
        uses: peterjgrainger/action-create-branch@v2.0.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          branch: "${{ env.BRANCH_NAME }}"

      - name: "Create PR from deployment branch into production"
        uses: poorva17/create-pr-action@main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HEAD_BRANCH: "${{ env.BRANCH_NAME }}"
          # NOTE: Created for the sole purpose to NOT go against production during testing
          # TODO: Change this to 'production' once we validate that the PR is a PR and not a merge
          BASE_BRANCH: "td/1851-target-ignore"
