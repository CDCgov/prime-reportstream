name: Find next person on call
on:
  workflow_dispatch:
  push: 
    branches:
      - feature/12965-SlackNotification
  schedule:
    - cron: "7 13 * * Mon-Fri"  #UTC-5
jobs:
  run-action:
    runs-on: ubuntu-latest
    steps:
    - name: Check Out Changes
      uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11
      with:
        fetch-depth: 0

    - name: Get PD oncall schedule
      id: PD
      shell: pwsh
      run: |
        ./.github/scripts/PagerDutyAlerts/TriggerPDApi.ps1 -PD_KEY "${{ secrets.PD_ROTATION_SLACK_NOTIFICATION }}" -ScheduleIds "${{ secrets.PD_ReportStream_ScheduleId }}"
    
    - name: Get PD onCall Details
      id: PDOnCall
      shell: pwsh
      run: |
        echo  "${env:PDSchedules}" >> PDSchedules.json

    - name: JSON to variables
      uses: antifree/json-to-variables@HEAD
      with:
        filename: 'PDSchedules.json'
        prefix: Schedules
      
    - name: Show schedules
      run: |
         echo "Prime ReportStream PagerDuty Schedule Name": "${{ env.Schedules_oncallSchedule_0_ScheduleName }}"
            "Prime ReportStream PagerDuty on-call person Now": "${{ env.Schedules_oncallSchedule_0_PersonName }}"
            "Prime ReportStream PagerDuty on-call person until": "${{ env.Schedules_oncallSchedule_0_Until }}"
            "Prime ReportStream PagerDuty Next person on-call": "${{ env.Schedules_oncallSchedule_0_NextPersonName }}"
            "Prime ReportStream PagerDuty Next person on-call from": "${{ env.Schedules_oncallSchedule_0_NextFrom }}"
            "Prime ReportStream PagerDuty Next person on-call until": "${{ env.Schedules_oncallSchedule_0_NextUntil }}"
            "ReportStream Dependabot PagerDuty Schedule Name": "${{ env.Schedules_oncallSchedule_1_ScheduleName }}"
            "ReportStream Dependabot PagerDuty on-call person Now": "${{ env.Schedules_oncallSchedule_1_PersonName }}"
            "ReportStream Dependabot PagerDuty on-call person until": "${{ env.Schedules_oncallSchedule_1_Until }}"
            "ReportStream Dependabot PagerDuty Next person on-call": "${{ env.Schedules_oncallSchedule_1_NextPersonName }}"
            "ReportStream Dependabot PagerDuty Next person on-call from": "${{ env.Schedules_oncallSchedule_1_NextFrom }}"
            "ReportStream Dependabot PagerDuty Next person on-call until": "${{ env.Schedules_oncallSchedule_1_NextUntil }}"
            "ReportStream Deployment PagerDuty Schedule Name": "${{ env.Schedules_oncallSchedule_2_ScheduleName }}"
            "ReportStream Deployment PagerDuty on-call person Now": "${{ env.Schedules_oncallSchedule_2_PersonName }}"
            "ReportStream Deployment PagerDuty on-call person until": "${{ env.Schedules_oncallSchedule_2_Until }}"
            "ReportStream Deployment PagerDuty Next person on-call": "${{ env.Schedules_oncallSchedule_2_NextPersonName }}"
            "ReportStream Deployment PagerDuty Next person on-call from": "${{ env.Schedules_oncallSchedule_2_NextFrom }}"
            "ReportStream Deployment PagerDuty Next person on-call until": "${{ env.Schedules_oncallSchedule_2_NextUntil }}"
            "ReportStream Front End Checks PagerDuty Schedule Name": "${{ env.Schedules_oncallSchedule_3_ScheduleName }}"
            "ReportStream Front End Checks PagerDuty on-call person Now": "${{ env.Schedules_oncallSchedule_3_PersonName }}"
            "ReportStream Front End Checks PagerDuty on-call person until": "${{ env.Schedules_oncallSchedule_3_Until }}"
            "ReportStream Front End Checks PagerDuty Next person on-call": "${{ env.Schedules_oncallSchedule_3_NextPersonName }}"
            "ReportStream Front End Checks PagerDuty Next person on-call from": "${{ env.Schedules_oncallSchedule_3_NextFrom }}"
            "ReportStream Front End Checks PagerDuty Next person on-call until": "${{ env.Schedules_oncallSchedule_3_NextUntil }}"
  

    # - name: Slack Notification
    #   uses: ./.github/actions/notifications
    #   with:
    #     method: slack
    #     title: Pagerduty 
    #     message: |
    #       "Prime ReportStream PagerDuty Next person on-call until": "${{ env.Schedules_oncallSchedule_0_NextUntil }}"
    #       "Prime ReportStream PagerDuty on-call person Now": "${{ env.Schedules_oncallSchedule_0_PersonName }}"
    #       "Prime ReportStream PagerDuty on-call person until": "${{ env.Schedules_oncallSchedule_0_Until }}"
    #       "Prime ReportStream PagerDuty Next person on-call": "${{ env.Schedules_oncallSchedule_0_NextPersonName }}"
    #       "Prime ReportStream PagerDuty Next person on-call from": "${{ env.Schedules_oncallSchedule_0_NextFrom }}"
    #       "Prime ReportStream PagerDuty Next person on-call until": "${{ env.Schedules_oncallSchedule_0_NextUntil }}"
    #     icon-emoji: ':bell:'
    #     channel:  prime-reportstream-engineering
    #     webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
    #     color: warning