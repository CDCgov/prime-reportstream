name: SonarCloud Master

on: 
  workflow_dispatch:
  push:
    branches:
      - master
    paths:
      - "prime-router/**"

env:
  # These are for CI and not credentials of any system
  DB_USER: prime
  DB_PASSWORD: changeIT!

jobs:
  pre_job:
    name: Pre Job
    runs-on: ubuntu-latest
    outputs:
      has_router_change: ${{ steps.build_vars.outputs.has_router_change }}
    steps:
      - name: "Check out changes"
        uses: actions/checkout@8e5e7e5ab8b370d6c329ec480221332ada57f0ab
      - name: Build vars
        id: build_vars
        uses: ./.github/actions/build-vars

  docker_build_test:
    name: SonarCloud Master
    runs-on: ubuntu-latest
    needs: pre_job
    defaults:
      run:
        working-directory: prime-router
    strategy:
      fail-fast: false
      matrix:
        language: [ 'java' ]

    steps:
      - name: "Check out changes"
        uses: actions/checkout@8e5e7e5ab8b370d6c329ec480221332ada57f0ab
        with:
          fetch-depth: 0

      - name: Set up JDK 11
        uses: actions/setup-java@5ffc13f4174014e2d4d4572b3d74c3fa61aeb2c2
        with:
          java-version: '11'
          distribution: 'adopt'
          cache: 'gradle'

      - uses: gradle/wrapper-validation-action@8d49e559aae34d3e0eb16cde532684bc9702762b

      - name: Spin up build containers
        run: docker-compose -f docker-compose.postgres.yml up -d

      - name: Build Prime Router Package
        run: ./gradlew package -x fatjar

      - name: "Run SonarCloud Scan"
        uses: sonarsource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.coverage.exclusions=prime-router/src/test/**,prime-router/src/main/kotlin/cli/tests/**,frontend-react/**/__mocks__/**,frontend-react/**/mocks/**,frontend-react/**/*.test.*
            -Dsonar.cpd.exclusions=frontend-react/**/*.test.*
            -Dsonar.sources=frontend-react/src,prime-router/src
            -Dsonar.projectKey=CDCgov_prime-data-hub
            -Dsonar.organization=cdcgov
            -Dsonar.skipUnchanged=false
            -Dsonar.java.libraries=prime-router/build/libs/*.jar,prime-router/build/**/*.jar
            -Dsonar.coverage.jacoco.xmlReportPaths=prime-router/build/reports/jacoco/test/jacocoTestReport.xml
            -Dsonar.javascript.lcov.reportPaths=frontend-react/coverage/lcov.info
            
