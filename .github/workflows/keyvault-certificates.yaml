name: Check Key Vault Certificates Expiration

on:
  push: 
    branches:
      - feature/check-keyvauly-cert-expiration
    
jobs:
  check-certificates:
    runs-on: ubuntu-latest
    steps:
      - name: Check Out Changes
        uses: actions/checkout@24cb9080177205b6e8c946b17badbe402adc938f

      - name: Get Runner IP
        run: echo "::set-output name=runner_ip::$(curl https://ifconfig.me)"
        id: runner_ip

      - name: Connect to VPN & Login into Azure
        uses: ./.github/actions/vpn-azure
        with:
          tls-key: ${{ secrets.TLS_KEY }}
          ca-cert: ${{ secrets.CA_CRT}}
          user-crt: ${{ secrets.USER_CRT }}
          user-key: ${{ secrets.USER_KEY }}
          sp-creds: ${{ secrets.SERVICE_PRINCIPAL_CREDS }}

      - name: Add Runner IP to Key Vault Firewall
        uses: azure/cli@v1
        with:
          inlineScript: |
            az keyvault network-rule add --name pdhstaging-keyvault --ip-address ${{ steps.runner_ip.outputs.runner_ip }}

      - name: Get Certificates Expiration
        run: |
          az keyvault certificate list --vault-name pdhstaging-keyvault --query "[].{name:name, expires:attributes.expires}" --output table

      - name: Get Near Expiry Certificates
        id: cert-expiration
        run: |
          near_expiry_date=$(date -d "+300 days" -I)
          near_expiry_certificates=$(az keyvault certificate list --vault-name pdhstaging-keyvault --query "[?attributes.expires<=\`$near_expiry_date\`].name" -o tsv)
          echo "The following certificates will expire within the next 300 days: $near_expiry_certificates"
          echo "::set-output name=expiring_certs::$near_expiry_certificates"

      - name: Notify Slack
        #if: steps.cert-expiration.outputs.expiring_certs > 0
        uses: rtCamp/action-slack-notify@v2.1.1
        with:
          status: 'Warning'
          fields: |
            Certificates are expiring soon:
            ${{ steps.cert-expiration.outputs.expiring_certs }}
          username: 'GitHub Actions'
          icon_emoji: ':github_actions:'
          channel: '${{ secrets.SLACK_CHANNEL }}'
          mention: '@channel'
          if_mention: true
          github_token: ${{ secrets.GITHUB_TOKEN }}
          #github_base_url: ${{ env.GITHUB_SERVER_URL }}


      # - name: Send Slack Notification
      #   if: steps.cert-expiration.outputs.expiring_certs > 0
      #   uses: 8398a7/action-slack@v3
      #   with:
      #     status: "warning"
      #     author_name: "GitHub Actions"
      #     author_icon: "https://github.githubassets.com/favicon.ico"
      #     fields: |
      #       {
      #         \"title\": \"Key Vault Certificates Expiring Soon\",
      #         \"value\": \"The following certificates in Key Vault pdhstaging-keyvault will expire soon:\n${{ steps.cert-expiration.outputs.expiring_certs }}\",
      #         \"short\": false
      #       }
      #     channel: ${{ secrets.SLACK_CHANNEL }}
      #     icon_url: "https://github.githubassets.com/favicon.ico"
      #     username: "GitHub Actions"
      #     footer: "Sent by GitHub Actions"
      #     footer_icon: "https://github.githubassets.com/favicon.ico"
      #   env:
      #     SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}






      # - name: Get Certificates Expiration
      #   run: |
      #     az keyvault certificate list --vault-name pdhstaging-keyvault --query "[].{name:name, expires:attributes.expires}" --output table

      # - name: Get Near Expiry Certificates
      #   run: |
      #     near_expiry_date=$(date -d "+300 days" -I)
      #     near_expiry_certificates=$(az keyvault certificate list --vault-name pdhstaging-keyvault --query "[?attributes.expires<=\`$near_expiry_date\`].name" -o tsv)
      #     echo "The following certificates will expire within the next 300 days: $near_expiry_certificates"

      - name: Remove runner IP from firewall rule
        run: az keyvault network-rule remove --name pdhstaging-keyvault --ip-address $runner_ip

      - name: Cleanup
        run: |
          unset runner_ip



      