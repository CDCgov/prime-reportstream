name: Check Key Vault Certificates Expiration

on:
  push: 
    branches:
      - feature/check-keyvauly-cert-expiration
    
jobs:
  check-certificates:
    runs-on: ubuntu-latest
    steps:
      - name: Check Out Changes
        uses: actions/checkout@24cb9080177205b6e8c946b17badbe402adc938f

      - name: Get Runner IP
        run: echo "::set-output name=runner_ip::$(curl https://ifconfig.me)"
        id: runner_ip

      - name: Connect to VPN & Login into Azure
        uses: ./.github/actions/vpn-azure
        with:
          tls-key: ${{ secrets.TLS_KEY }}
          ca-cert: ${{ secrets.CA_CRT}}
          user-crt: ${{ secrets.USER_CRT }}
          user-key: ${{ secrets.USER_KEY }}
          sp-creds: ${{ secrets.SERVICE_PRINCIPAL_CREDS }}

      - name: Add Runner IP to Key Vault Firewall
        uses: azure/cli@v1
        with:
          inlineScript: |
            az keyvault network-rule add --name pdhstaging-keyvault --ip-address ${{ steps.runner_ip.outputs.runner_ip }}

      - name: Get certificate expiry dates
        run: |
          az keyvault certificate list --vault-name <keyvault-name> --query "[].{name:name, expiry:attributes.expires}" -o json > cert_expiry.json

      - name: Extract certificates expiring in 300 days
        run: |
          jq '.[] | select(.expiry < (now + 300*24*60*60*1000000000) | strptime("%Y-%m-%dT%H:%M:%S.%NZ") | mktime) | .name' cert_expiry.json > expiring_certs.txt

      - name: Send Slack notification
        uses: 8398a7/action-slack@v3
        with:
          text: "The following Azure Key Vault certificates are expiring in 300 days:"
          color: warning
          github_token: ${{ secrets.GITHUB_TOKEN }}
          attachment_content: expiring_certs.txt
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      # - name: Check Key Vault Certificates
      #   id: check-certs
      #   run: |
      #     certificates=$(az keyvault certificate list --vault-name pdhstaging-keyvault --query "[?attributes.expires<=\`$(date +%Y-%m-%dT%H:%MZ --date='+300 days')\`].{name:name, expiration:attributes.expires}" -o json)
      #     if [[ -z "$certificates" ]]; then
      #       echo "No certificates are expiring within the next 300 days."
      #     else
      #       echo "The following certificates are expiring within the next 30 days:"
      #       echo "$certificates" | tee certificates.txt
      #       echo "::set-output name=certificates::certificates.txt"
      #     fi

      # - name: Read file content
      #   id: read-file-content
      #   run: |
      #     file_content=$(cat certificates.txt)
      #     echo "::set-output name=file_content::$file_content"

      # - name: Send Slack notification
      #   uses: 8398a7/action-slack@v3
      #   env:
      #     SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      #   with:
      #     text: "$certificate expires in $expiry_days days\nFile Content: ${{ steps.read-file-content.outputs.file_content }}"
      #     color: warning

      # - name: Send Slack notification
      #   run: |
      #     message=${{ steps.read-file-content.outputs.file_content }}
      #     curl -X POST -H 'Content-type: application/json' --data "{\"text\":\"$message\"}" $SLACK_WEBHOOK_URL
      #   shell: bash
      #   env:
      #     SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Remove Runner IP to Key Vault Firewall
        run: az keyvault network-rule remove --name pdhstaging-keyvault --ip-address $runner_ip