name: Check Key Vault Certificates Expiration

on:
  push: 
    branches:
      - feature/check-keyvauly-cert-expiration
    
jobs:
  check-certificates:
    runs-on: ubuntu-latest
    steps:
      - name: Check Out Changes
        uses: actions/checkout@24cb9080177205b6e8c946b17badbe402adc938f

      - name: Get Runner IP
        run: echo "::set-output name=runner_ip::$(curl https://ifconfig.me)"
        id: runner_ip

      - name: Connect to VPN & Login into Azure
        uses: ./.github/actions/vpn-azure
        with:
          tls-key: ${{ secrets.TLS_KEY }}
          ca-cert: ${{ secrets.CA_CRT}}
          user-crt: ${{ secrets.USER_CRT }}
          user-key: ${{ secrets.USER_KEY }}
          sp-creds: ${{ secrets.SERVICE_PRINCIPAL_CREDS }}

      - name: Add Runner IP to Key Vault Firewall
        uses: azure/cli@v1
        with:
          inlineScript: |
            az keyvault network-rule add --name pdhstaging-keyvault --ip-address ${{ steps.runner_ip.outputs.runner_ip }}
            az keyvault network-rule add --name pdhprod-keyvault --ip-address ${{ steps.runner_ip.outputs.runner_ip }}

      - name: List KeyVault Certificates in Prod & Staging
        id: cert_list
        run: |
          az keyvault certificate list --vault-name pdhprod-keyvault --query "[?attributes.expires <= '$(date -u -d '+400 days' +%Y-%m-%dT%H:%M:%S.%NZ)'].{Name:name, Expiry:attributes.expires}" -o json > certificates.json
          az keyvault certificate list --vault-name pdhstaging-keyvault --query "[?attributes.expires <= '$(date -u -d '+400 days' +%Y-%m-%dT%H:%M:%S.%NZ)'].{Name:name, Expiry:attributes.expires}" -o json >> certificates.json
          cat certificates.json
      
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Filter certificates
        run: |
          jq '[.[] | {Name: .Name, Expires: .Expires}]' certificates.json > filtered_certificates.json
          cat filtered_certificates.json
      
      - name: Send Slack notification
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{"text": "Certificates expiring in 300 days or less are"}' ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Remove Runner IP to Key Vault Firewall
        run: |
          az keyvault network-rule remove --name pdhstaging-keyvault --ip-address $runner_ip
          az keyvault network-rule remove --name pdhprod-keyvault --ip-address $runner_ip







      # - name: Slack Notification
      #   uses: ./.github/actions/notifications
      #   with:
      #     method: slack
      #     title: Expiring Certificates
      #     message: |
      #       certificates=$(az keyvault certificate list --vault-name $keyvault_name --query "[?attributes.expires <= '$(date -u -d '+300 days' +%Y-%m-%dT%H:%M:%S.%NZ)'].{Name:name, Expiry:attributes.expires}" -o json)
      #       echo "$certificates"
      #     icon-emoji: ':bell:'
      #     channel: pagerduty-alert-dump
      #     webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
      #     color: warning
          


      # webhook_url=${{ secrets.SLACK_WEBHOOK_URL }}
      # messageprod=$(az keyvault certificate list --vault-name pdhprod-keyvault --query "[].{name:name, expires:attributes.expires}" --output table)
      # messagestg=$(az keyvault certificate list --vault-name pdhstaging-keyvault --query "[].{name:name, expires:attributes.expires}" --output table)
      # payloadprod="{\"text\":\"${messageprod}\"}"
      # payloadstg="{\"text\":\"${messagestg}\"}"
      # curl -X POST -H "Content-Type: application/json" -d "${payloadprod}" ${webhook_url}
      # curl -X POST -H "Content-Type: application/json" -d "${payloadstg}" ${webhook_url}
