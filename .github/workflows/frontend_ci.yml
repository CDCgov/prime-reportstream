name: Frontend CI

on:
  pull_request:
    paths: 
      - frontend-react/**
    types: 
      - synchronize

concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    working-directory: frontend-react
    shell: bash

env:
    TEST_ADMIN_USERNAME: ${{ secrets.TEST_ADMIN_USERNAME }}
    TEST_ADMIN_PASSWORD: ${{ secrets.TEST_ADMIN_PASSWORD }}
    TEST_SENDER_USERNAME: ${{ secrets.TEST_SENDER_USERNAME }}
    TEST_SENDER_PASSWORD: ${{ secrets.TEST_SENDER_PASSWORD }}
    TEST_RECEIVER_USERNAME: ${{ secrets.TEST_RECEIVER_USERNAME }}
    TEST_RECEIVER_PASSWORD: ${{ secrets.TEST_RECEIVER_PASSWORD }}

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      - name: Check out changes
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11
      - name: Use Node.js with yarn
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8
        with:
            node-version-file: frontend-react/.nvmrc
            cache: yarn
            cache-dependency-path: frontend-react/yarn.lock
      - name: Yarn install
        run: yarn install --immutable
      - name: Run linting
        run: yarn run lint

  unit_tests:
    name: Unit tests
    needs: lint
    runs-on: ubuntu-latest

    steps:
        - name: Check out changes
          uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11
        - name: Use Node.js with yarn
          uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8
          with:
            node-version-file: "frontend-react/.nvmrc"
            cache: yarn
            cache-dependency-path: frontend-react/yarn.lock
        - name: Yarn install
          run: yarn install --immutable
        - name: Unit tests
          run: yarn run test:ci

  e2e_tests:
    name: E2E tests
    needs: lint
    runs-on: ubuntu-latest

    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        shardIndex: [1, 2, 3, 4]
        shardTotal: [4]
    steps:
        - name: Check out changes
          uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11
        - name: Use Node.js with yarn
          uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8
          with:
            node-version-file: "frontend-react/.nvmrc"
            cache: yarn
            cache-dependency-path: frontend-react/yarn.lock
        - name: Yarn install
          run: yarn install --immutable
        - name: Install Playwright
          run: npx playwright install --with-deps
        - name: Run E2E tests
          run: yarn run test:e2e --shard=${{ matrix.shardIndex }}/${{ matrix.shardTotal }}
        - name: Upload blob report to GitHub Actions Artifacts
          if: ${{ !cancelled() }}
          uses: actions/upload-artifact@v4
          with:
            name: blob-report-${{ matrix.shardIndex }}
            path: blob-report
            retention-days: 1

  merge_e2e_reports:
      # Merge reports after playwright-tests, even if some shards have failed
      if: ${{ !cancelled() }}
      needs: [e2e_tests]

      runs-on: ubuntu-latest
      steps:
        - name: Check out changes
          uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11
        - name: Use Node.js with yarn
          uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8
          with:
            node-version-file: "frontend-react/.nvmrc"
            cache: yarn
            cache-dependency-path: frontend-react/yarn.lock
        - name: Yarn install
          run: yarn install --immutable

        - name: Download blob reports from GitHub Actions Artifacts
          uses: actions/download-artifact@65a9edc5881444af0b9093a5e628f2fe47ea3b2e
          with:
            path: all-blob-reports
            pattern: blob-report-*
            merge-multiple: true

        - name: Merge into HTML Report
          run: npx playwright merge-reports --reporter html ./all-blob-reports 

        - name: Upload HTML report
          uses: actions/upload-artifact@65462800fd760344b1a7b4382951275a0abb4808
          with:
            name: html-report--attempt-${{ github.run_attempt }}
            path: playwright-report
            retention-days: 14
  
  codeql:
    name: CodeQL Analysis
    needs: lint
    if: github.actor != 'dependabot[bot]'
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - name: Check out changes
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11
      - name: Initialize CodeQL
        uses: github/codeql-action/init@65c74964a9ed8c44ed9f19d4bbc5757a6a8e9ab9
        with:
          languages: javascript-typescript
          source-root: frontend-react
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@65c74964a9ed8c44ed9f19d4bbc5757a6a8e9ab9
        with:
          category: /language:javascript,typescript

  sonarcloud:
    name: SonarCloud Analysis
    needs: lint
    if: github.actor != 'dependabot[bot]'
    runs-on: ubuntu-latest

    steps:
      - name: Check out changes
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11
        with:
          fetch-depth: 0
      - name: Use Node.js with yarn
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8
        with:
          node-version-file: "frontend-react/.nvmrc"
          cache: yarn
          cache-dependency-path: frontend-react/yarn.lock
      - name: Yarn install
        run: yarn install --immutable
      - name: Collect coverage
        run: yarn run test:ci
      - name: Run SonarCloud Scan
        run: >
          npx sonarqube-scanner 
          -Dsonar.host.url=https://sonarcloud.io
          -Dsonar.projectBaseDir=../
          -Dsonar.token="${{ secrets.SONAR_TOKEN }}"
          -Dsonar.coverage.exclusions=prime-router/**,frontend-react/**/__mocks__/**,frontend-react/**/mocks/**,frontend-react/**/*.test.*,frontend-react/**/*.stories.*
          -Dsonar.cpd.exclusions=prime-router/**,frontend-react/**/*.test.*,frontend-react/**/*.stories.*
          -Dsonar.sources=frontend-react/src,prime-router/src
          -Dsonar.projectKey=CDCgov_prime-data-hub
          -Dsonar.organization=cdcgov
          -Dsonar.javascript.lcov.reportPaths=frontend-react/coverage/lcov.info

