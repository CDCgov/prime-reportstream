name: Terraform Validation

on: 
  push: 
    branches:
      - feature/fix-CKV2_AZURE_33-checkov-error

  #  pull_request:
  #    branches:
  #      - production
  #      - master
  #      - test
  #    paths:
  #      - '**.tf'

jobs:
  pre_job:
    name: Pre Job
    runs-on: ubuntu-latest
    outputs:
      has_operations_change: ${{ steps.build_vars.outputs.has_terraform_change }}
    steps:
      - name: Check Out Changes
        uses: actions/checkout@8e5e7e5ab8b370d6c329ec480221332ada57f0ab
      - name: Build vars
        id: build_vars
        uses: ./.github/actions/build-vars

  validate_terraform_yaml:
    name: Validate Terraform YAML
    needs: pre_job
    if: ${{ needs.pre_job.outputs.has_operations_change == 'true' }}
    environment: staging
    runs-on: ubuntu-latest
    steps:
      - name: Check Out Changes
        uses: actions/checkout@8e5e7e5ab8b370d6c329ec480221332ada57f0ab
      - name: Use specific version of Terraform
        uses: hashicorp/setup-terraform@633666f66e0061ca3b725c73b2ec20cd13a8fdd1
        with:
          terraform_version: 1.2.0
          terraform_wrapper: false
      - name: Verify Terraform Formatting
        run: terraform -chdir=operations/app/terraform/vars/staging fmt -check -recursive ../../
  checkov-job:
    name: Run Checkov On Terraform Code
    needs: validate_terraform_yaml
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@8e5e7e5ab8b370d6c329ec480221332ada57f0ab

      - name: Run Checkov action
        uses: bridgecrewio/checkov-action@b031131d118e3a1654eda07537191063cdc1e614
        with:
          directory: operations/app/terraform
          skip_check: .github/skip-checkov-list