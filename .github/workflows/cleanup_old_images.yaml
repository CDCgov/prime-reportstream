name: Azure Container Registry Cleanup

on:
  push:
    branches:
        - feature/11576-cleanup-test-staging-old-images

#   schedule:
#     - cron: '0 0 1 * *' # Runs on the first day of every month

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: "Check out changes"
        uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608

      - name: Connect to VPN & Login into Azure
        uses: ./.github/actions/vpn-azure
        with:
          tls-key: ${{ secrets.TLS_KEY }}
          ca-cert: ${{ secrets.CA_CRT}}
          user-crt: ${{ secrets.USER_CRT }}
          user-key: ${{ secrets.USER_KEY }}
          sp-creds: ${{ secrets.SERVICE_PRINCIPAL_CREDS }}

      - name: List test repository images
        id: list-test-images
        run: |
          az acr repository show-tags --name pdhtestcontainerregistry --repository pdhtest --orderby time_asc --output json | head -n -2 > test-images.json

    #   - name: List test repository images
    #     id: list-stg-images
    #     run: |
    #         STG_IMAGES=$(az acr repository show-tags --name pdhtestcontainerregistry --repository pdhtest --orderby time_asc --output table | head -n -2)
    #         echo "STG_IMAGES=$STG_IMAGES" >> $GITHUB_OUTPUT
      - name: Format output
        id: format_out
        run: |
          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "TEST_IMAGES<<$EOF" >> $GITHUB_OUTPUT
          cat test-images.json >> $GITHUB_OUTPUT
          echo "$EOF" >> $GITHUB_OUTPUT

      - name: Delete test old images
        run: |
          TEST_IMAGES=${{ steps.format_out.outputs.TEST_IMAGES }}
            for IMAGE in TEST_IMAGES; do
              echo "Deleting image $IMAGE"
              az acr repository delete --name pdhtestcontainerregistry --image pdhtestcontainerregistry@$IMAGE --yes
            done

    #   - name: Delete staging old images
    #     run: |
    #       IMAGES=$(cat test-images.txt)
    #       for IMAGE IMAGES; do
    #       echo "Deleting image $IMAGE"
    #       az acr repository delete --name pdhtestcontainerregistry --image $IMAGE --yes
    #       done
