name: Azure Container Registry Cleanup

on:
  push:
    branches:
        - feature/11576-cleanup-test-staging-old-images

#   schedule:
#     - cron: '0 0 1 * *' # Runs on the first day of every month

jobs:
  cleanup:
    runs-on: ubuntu-latest
    env:
        ENVIRONMENT: ${{ matrix.environment }}
    strategy:
        matrix:
          environment: [test, staging]
    steps:
      - name: "Check out changes"
        uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608

      - name: Connect to VPN & Login into Azure
        uses: ./.github/actions/vpn-azure
        with:
          tls-key: ${{ secrets.TLS_KEY }}
          ca-cert: ${{ secrets.CA_CRT}}
          user-crt: ${{ secrets.USER_CRT }}
          user-key: ${{ secrets.USER_KEY }}
          sp-creds: ${{ secrets.SERVICE_PRINCIPAL_CREDS }}

      - name: List test & staging repository images
        id: list-images
        run: |
          az acr repository show-tags --name pdh${{ matrix.environment }} }}containerregistry.azurecr.io --repository pdh${{ matrix.environment }} }} --orderby time_asc --output table | head -n -2 > container_id.txt
         # az acr repository show-tags --name pdhstagingcontainerregistry.azurecr.io --repository pdhstaging --orderby time_asc --output table | head -n -2 >> container_id.txt
          cat container_id.txt

    #   - name: Delete test & staging old images
    #     run: |
    #         REPOSITORY_NAME="pdhtest"
    #         IMAGES=${{ steps.list-images.outputs.LIST }}
    #         for IMAGE in `cat container_id.txt`; do
    #         echo "Deleting image $IMAGE"
    #         az acr repository delete --name $REGISTRY_NAME --image pdhtest@$IMAGE --yes
    #         done
