name: Export Cost Data

on:
  pull_request:
    branches:
      - dkrylov/costs_dash_10546
  push:
    branches:
      - dkrylov/costs_dash_10546

jobs:
  export_cost_data:
    name: Export Azure Cost Data to Storage
    runs-on: ubuntu-latest
    steps:
      - name: "Check out changes"
        uses: actions/checkout@a5ac7e51b41094c92402da3b24376905380afc29
      - name: Connect to VPN and login to Azure
        uses: ./.github/actions/vpn-azure
        with:
          env-name: prod
          sp-creds: ${{ secrets.SERVICE_PRINCIPAL_CREDS }}
          tf-auth: false
      - name: Install .NET
        run: |
          sudo apt-get update
          sudo apt-get install -y dotnet-sdk-8.0 dotnet-runtime-8.0
      - name: Install azure-cost-cli
        run: |
          dotnet tool install --global azure-cost-cli
      - name: Run azure-cost-cli
        run: |
          azure-cost accumulatedCost -g prime-data-hub-prod -t custom --from $(date --date='180 days ago' '+%m/%d/%Y') --to $(date '+%m/%d/%Y')  -o csv
      - name: Store cost data in DB
        uses: ./.github/actions/db-query
        with:
          pass: ${{ secrets['POSTGRESQL_STAGING_PWD'] }}
          host: pdhstaging-pgsql
          port: 5432
          user: prime
          database: prime_data_hub
          output-file: result.txt
          query: |
            SELECT 1 ;
