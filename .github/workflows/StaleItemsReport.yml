name: Alert Stale Items from GitHub

on:
  workflow_dispatch:
  push: 
    branches:
      - josiahsiegel/update/stale_branch_formatting
  schedule:
    - cron: "13 1 1 * *"

jobs:
  alert_stale_items:
    name: Alert on Stale items in github
    runs-on: ubuntu-latest
    steps:
      - name: Check Out Changes
        uses: actions/checkout@44c2b7a8a4ea60a981eaca3cf939b5f4305c123b
        with:
          fetch-depth: 0

      - name: Get Stale items
        shell: pwsh
        run: |
          ./.github/scripts/stale_items_report/StaleItems.ps1

      - name: Decode Slack Message
        shell: pwsh
        run: |
          $slackMessage = [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($env:SLACK_MESSAGE))
          echo $slackMessage > slack_message.md

          echo "## Stale Items`n$slackMessage" >> $env:GITHUB_STEP_SUMMARY

      - name: Get Stale items
        id: stale_out
        shell: bash
        run: |
          message=$(cat slack_message.md)
          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "MESSAGE_RESPONSE<<$EOF" >> $GITHUB_OUTPUT
          echo -e "$message" >> $GITHUB_OUTPUT
          echo "$EOF" >> $GITHUB_OUTPUT

      - name: Slack Notification
        uses: ./.github/actions/notifications
        with:
          method: slack
          title: Stale GitHub Items Summary
          message: |
            ${{ steps.stale_out.outputs.MESSAGE_RESPONSE }}
          icon-emoji: ':bell:'
          channel: temp_branch_dump
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          color: warning
          slackify-markdown: true
