name: List Azure Key Vault Certificates and Send Notification to Slack

on:
  push: 
    branches:
      - feature/check-keyvauly-cert-expiration

jobs:
  list-certificates:
    runs-on: ubuntu-latest
    steps:
    - name: Check Out Changes
      uses: actions/checkout@24cb9080177205b6e8c946b17badbe402adc938f

    - name: Get Runner IP
      run: echo "::set-output name=runner_ip::$(curl https://ifconfig.me)"
      id: runner_ip

    - name: Connect to VPN & Login into Azure
      uses: ./.github/actions/vpn-azure
      with:
        tls-key: ${{ secrets.TLS_KEY }}
        ca-cert: ${{ secrets.CA_CRT}}
        user-crt: ${{ secrets.USER_CRT }}
        user-key: ${{ secrets.USER_KEY }}
        sp-creds: ${{ secrets.SERVICE_PRINCIPAL_CREDS }}

    - name: Add Runner IP to Key Vault Firewall
      uses: azure/cli@v1
      with:
        inlineScript: |
          az keyvault network-rule add --name pdhstaging-keyvault --ip-address ${{ steps.runner_ip.outputs.runner_ip }}


    - name: List Key Vaults
      id: keyvaults
      run: |
        az keyvault list --query "[].{name:name}" --output tsv

    - name: Loop through Key Vaults
      id: loop-keyvaults
      run: |
        for key_vault_name in $(echo "${{ steps.keyvaults.outputs.stdout }}")
        do
          echo "KEY_VAULT_NAME=$key_vault_name" >> $GITHUB_ENV
          KEY_VAULT_CERT_NAMES=$(az keyvault certificate list --vault-name $key_vault_name --query "[].{name:name}" --output tsv)
          echo "KEY_VAULT_CERT_NAMES=$KEY_VAULT_CERT_NAMES" >> $GITHUB_ENV
          KEY_VAULT_CERT_NAMES_ARRAY=$(echo $KEY_VAULT_CERT_NAMES | tr '\n' ' ')
          echo "KEY_VAULT_CERT_NAMES_ARRAY=$KEY_VAULT_CERT_NAMES_ARRAY" >> $GITHUB_ENV
          NUMBER_OF_CERTS=$(echo $KEY_VAULT_CERT_NAMES_ARRAY | wc -w)
          echo "NUMBER_OF_CERTS=$NUMBER_OF_CERTS" >> $GITHUB_ENV
          CURRENT_CERT=1
          echo "CURRENT_CERT=$CURRENT_CERT" >> $GITHUB_ENV
          CURRENT_ITERATION=1
          echo "CURRENT_ITERATION=$CURRENT_ITERATION" >> $GITHUB_ENV
          BATCH_SIZE=5
          echo "BATCH_SIZE=$BATCH_SIZE" >> $GITHUB_ENV
        done

    - name: Loop through Certificates
      id: loop-certificates
      run: |
        KEY_VAULT_CERT_NAME=$(echo "${{ env.KEY_VAULT_CERT_NAMES_ARRAY }}" | awk "NR==$(( ( ${{ env.CURRENT_ITERATION }} - 1 ) * ${{ env.BATCH_SIZE }} + ${{ env.CURRENT_CERT }} ))")
        echo "Certificate: $KEY_VA


    - name: Remove Runner IP to Key Vault Firewall
      run: az keyvault network-rule remove --name pdhstaging-keyvault --ip-address $runner_ip

    - name: Cleanup
      run: |
        unset runner_ip
