# action.yml
name: 'VPN Azure'
description: 'Connect to VPN and login to Azure'
inputs:
  tls-key:
    description: "TLS key"
  ca-cert:
    description: "CA cert"
    default: false
  user-crt:
    description: "User cert"
  user-key:
    description: "User key"
  sp-creds:
    description: "Azure Service Principal creds"
    required: true
  env-name:
    required: true
  tf-auth:
    description: "Set Terraform auth env variables. True or False"
    default: false
  dns-ip:
    description: 'VPN DNS IP'
    default: '127.0.0.1'

runs:
  using: "composite"
  steps:

    - name: Set environment variables - demo1
      if: inputs.env-name == 'demo1'
      shell: bash
      run: echo "VPN_ENV=demo1" >> $GITHUB_ENV

    - name: Set environment variables - demo2
      if: inputs.env-name == 'demo2'
      shell: bash
      run: echo "VPN_ENV=demo2" >> $GITHUB_ENV

    - name: Set environment variables - demo3
      if: inputs.env-name == 'demo3'
      shell: bash
      run: echo "VPN_ENV=demo3" >> $GITHUB_ENV

    - name: Set environment variables - dev
      if: inputs.env-name == 'dev'
      shell: bash
      run: echo "VPN_ENV=dev" >> $GITHUB_ENV

    - name: Set environment variables - test
      if: inputs.env-name == 'test'
      shell: bash
      run: echo "VPN_ENV=test" >> $GITHUB_ENV

    - name: Set environment variables - staging
      if: inputs.env-name == 'staging'
      shell: bash
      run: echo "VPN_ENV=staging" >> $GITHUB_ENV

    - name: Set environment variables - production
      if: inputs.env-name == 'prod'
      shell: bash
      run: echo "VPN_ENV=prod" >> $GITHUB_ENV

    - name: Install OpenVPN
      if: inputs.ca-cert != 'false'
      run: |
        sudo apt-get update
        sudo apt-get install openvpn
        sudo apt install openvpn-systemd-resolved
      shell: bash

    - name: Update VPN DNS IP
      if: inputs.dns-ip != '127.0.0.1' && inputs.ca-cert != 'false'
      run: |
        sed -i "s/\(dhcp-option DNS \).*/\1${{ inputs.dns-ip }}/" .github/vpn/${{ env.VPN_ENV }}.ovpn
      shell: bash

    - uses: josiahsiegel/action-connect-ovpn@794339aff94452216c97f609476c367a43a31295
      if: env.VPN_ENV && inputs.ca-cert != 'false'
      id: connect_vpn
      with:
        FILE_OVPN: .github/vpn/${{ env.VPN_ENV }}.ovpn
        TLS_KEY: ${{ inputs.tls-key }}
        PING_URL: ${{ inputs.dns-ip }}
      env:
        CA_CRT: ${{ inputs.ca-cert}}
        USER_CRT: ${{ inputs.user-crt }}
        USER_KEY: ${{ inputs.user-key }}

    - name: Check VPN status
      if: env.VPN_ENV && inputs.ca-cert != 'false' && steps.connect_vpn.outputs.STATUS != 'true'
      run: |
        echo "VPN connected: ${{ steps.connect_vpn.outputs.STATUS }}"
        exit 1
      shell: bash

    - uses: azure/login@cb79c773a3cfa27f31f25eb3f677781210c9ce3d
      with:
        creds: ${{ inputs.sp-creds }}

    - name: Terraform Auth
      if: inputs.tf-auth == 'true'
      env:
        AZURE_CREDENTIALS: ${{ inputs.sp-creds }}
      run: |
        # Parse Azure secret into Terraform variables
        $servicePrincipal = ($env:AZURE_CREDENTIALS | ConvertFrom-Json)
        $env:ARM_CLIENT_ID = $servicePrincipal.clientId
        $env:ARM_CLIENT_SECRET = $servicePrincipal.clientSecret
        $env:ARM_SUBSCRIPTION_ID = $servicePrincipal.subscriptionId
        $env:ARM_TENANT_ID = $servicePrincipal.tenantId
          
        # Save environment variable setup for subsequent steps
        Get-ChildItem -Path Env: -Recurse -Include ARM_* | ForEach-Object {Write-Output "$($_.Name)=$($_.Value)"} >> $env:GITHUB_ENV
      shell: pwsh
