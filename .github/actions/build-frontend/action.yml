# action.yml
name: "Build Frontend"
description: "Build react website"
inputs:
  env-name:
    required: true
  appinsights-staging-key:
    description: Instrumentation key for staging environment
    required: true
  appinsights-prod-key:
    description: Instrumentation key for production environment
    required: true
  version:
    description: "Version tag"
    required: true
  GITHUB_TOKEN:
    description: Github provided token
    required: false
    default: ""
  SONAR_TOKEN:
    description: Token to communicate with Sonarcloud
    required: false
    default: ""

runs:
  using: "composite"
  steps:
    - name: Use Node.js with yarn
      uses: actions/setup-node@64ed1c7eab4cce3362f8c340dee64e5eaeef8f7c
      with:
        node-version-file: "frontend-react/package.json"

    - run: yarn install --ignore-platform
      working-directory: frontend-react
      shell: bash

    - name: Build release for production branch (conditional check)
      if: inputs.env-name == 'prod'
      working-directory: frontend-react
      run: |
        echo "" >> .env.production
        echo "VITE_APPINSIGHTS_KEY=${{ inputs.appinsights-prod-key }}" >> .env.production
        yarn test:ci
        yarn build:production
      shell: bash

    - name: Build release for non-production branch (conditional check)
      if: inputs.env-name != 'prod'
      working-directory: frontend-react
      run: |
        ENV=${{ inputs.env-name }}
        if [[ $ENV != demo* && $ENV != "test" && $ENV != trialfrontend* ]]; then ENV="staging"; fi
        echo "" >> .env.$ENV
        echo "VITE_APPINSIGHTS_KEY=${{ inputs.appinsights-staging-key }}" >> .env.$ENV
        yarn lint
        yarn test:ci
        yarn build:$ENV
      shell: bash
      
    - name: Set up JDK 11 to generate backend coverage stats
      uses: actions/setup-java@5ffc13f4174014e2d4d4572b3d74c3fa61aeb2c2
      with:
        java-version: '11'
        distribution: 'adopt'
        cache: 'gradle'

    - uses: gradle/wrapper-validation-action@8d49e559aae34d3e0eb16cde532684bc9702762b

    - name: Spin up build containers
      working-directory: prime-router
      run: docker-compose -f docker-compose.postgres.yml up -d
      shell: bash

    - name: Build Prime Router test report
      working-directory: prime-router
      run: ./gradlew jacocoTestReport -x fatjar
      shell: bash

    - name: SonarCloud Scan
      if: inputs.GITHUB_TOKEN != '' && inputs.SONAR_TOKEN != ''
      uses: sonarsource/sonarcloud-github-action@db501078e936e4b4c8773d1bb949ba9ddb7b6b6a
      env:
        GITHUB_TOKEN: ${{ inputs.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ inputs.SONAR_TOKEN }}
      with:
        args: >
          -Dsonar.cpd.exclusions=frontend-react/**/*.test.*,prime-router/src/test/**,prime-router/src/testIntegration/**,prime-router/src/main/kotlin/cli/tests/**
          -Dsonar.javascript.lcov.reportPaths=frontend-react/coverage/lcov.info
          -Dsonar.coverage.exclusions=prime-router/src/test/**,prime-router/src/testIntegration/**,prime-router/src/main/kotlin/cli/tests/**,frontend-react/**/__mocks__/**,frontend-react/**/mocks/**,frontend-react/**/*.test.*
          -Dsonar.sources=frontend-react/src,prime-router/src
          -Dsonar.projectKey=CDCgov_prime-data-hub
          -Dsonar.organization=cdcgov
          -Dsonar.java.libraries=prime-router/build/libs/*.jar,prime-router/build/**/*.jar
          -Dsonar.coverage.jacoco.xmlReportPaths=prime-router/build/reports/jacoco/test/jacocoTestReport.xml

    - name: Tar frontend files
      shell: bash
      working-directory: frontend-react
      run: tar -czf static-website-react.tar.gz build

    - name: Upload frontend artifact
      uses: actions/upload-artifact@0b7f8abb1508181956e8e162db84b466c27e18ce
      with:
        name: static-website-react-${{ inputs.version }}
        path: frontend-react/static-website-react.tar.gz
        retention-days: 1
