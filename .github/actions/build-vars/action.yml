# action.yml
name: 'Build Variables'
description: 'Variables shared by build workflows'
outputs:
  env_name:
    value: ${{ steps.build_result.outputs.env_name }}
  version:
    value: ${{ steps.version_result.outputs.version }}
  has_router_change:
    value: ${{ steps.backend_check.outputs.router }}
  has_react_change:
    value: ${{ steps.frontend_check.outputs.frontend_react }}

runs:
  using: "composite"
  steps:

    - name: Set Build Environment - DEV
      id: build_dev
      if: github.ref == 'refs/heads/dev-rheft'
      shell: bash
      run: echo "::set-output name=env_name::dev"

    - name: Set Build Environment - TEST
      id: build_test
      if: github.ref == 'refs/heads/ronheft/test-investigation'
      shell: bash
      run: echo "::set-output name=env_name::test"

    - name: Set Build Environment - STAGING
      id: build_staging
      if: github.ref == 'refs/heads/master'
      shell: bash
      run: echo "::set-output name=env_name::staging"

    - name: Set Build Environment - PROD
      id: build_prod
      if: github.ref == 'refs/heads/production'
      shell: bash
      run: echo "::set-output name=env_name::prod"

    - name: Set Build Environment - RESULT
      id: build_result
      shell: bash
      run: |
        echo "::set-output name=env_name::\
        ${{ steps.build_dev.outputs.env_name }}\
        ${{ steps.build_test.outputs.env_name }}\
        ${{ steps.build_staging.outputs.env_name }}\
        ${{ steps.build_prod.outputs.env_name }}"

    - name: Set tag automatically
      id: version_result
      shell: bash
      run: |
        echo "::set-output name=version::v-2022.01.13-152653"
        #echo "::set-output name=version::v-$(date +%Y.%m.%d-%H%M%S)"

    - uses: dorny/paths-filter@v2
      id: backend_check
      with:
        list-files: csv
        filters: |
          router:
            - 'prime-router/**'
            - 'operations/**'
            - '.github/actions/build-backend/action.yml'
            - '.github/actions/deploy-backend/action.yml'

    - uses: dorny/paths-filter@v2
      id: frontend_check
      with:
        list-files: csv
        filters: |
          frontend_react:
            - 'frontend-react/**'
            - 'operations/**'
            - '.github/actions/build-frontend/action.yml'
            - '.github/actions/deploy-frontend/action.yml'
