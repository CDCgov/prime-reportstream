# action.yml
name: 'Build Backend'
description: 'Build backend router'
inputs:
  version:
    description: "Version tag"
    required: true
  GITHUB_TOKEN:
    description: Github provided token
    required: false
    default: ""
  SONAR_TOKEN:
    description: Token to communicate with Sonarcloud
    required: false
    default: ""

runs:
  using: "composite"
  steps:

    # These are for CI and not credentials of any system
    - name: Set Environment Variables
      working-directory: prime-router
      shell: bash
      run: |
        echo >> $GITHUB_ENV DB_USER='prime'
        echo >> $GITHUB_ENV DB_PASSWORD='changeIT!'

    - uses: gradle/wrapper-validation-action@8d49e559aae34d3e0eb16cde532684bc9702762b

    - name: Spin up build containers
      working-directory: prime-router
      shell: bash
      run: docker-compose -f docker-compose.postgres.yml up -d

    - name: Build Prime Router Package
      working-directory: prime-router
      shell: bash
      run: ./gradlew package -x fatjar -Pshowtests

    - name: SonarCloud Scan
      if: inputs.GITHUB_TOKEN != '' && inputs.SONAR_TOKEN != ''
      uses: sonarsource/sonarcloud-github-action@db501078e936e4b4c8773d1bb949ba9ddb7b6b6a
      env:
        GITHUB_TOKEN: ${{ inputs.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ inputs.SONAR_TOKEN }}
      with:
        args: >
          -Dsonar.coverage.exclusions=prime-router/src/test/**,prime-router/src/main/kotlin/cli/tests/**
          -Dsonar.sources=prime-router/src
          -Dsonar.projectKey=CDCgov_prime-data-hub
          -Dsonar.organization=cdcgov

    - name: Tar router files
      working-directory: prime-router
      shell: bash
      run: tar -czvf prime-router-build.tar.gz build

    - name: Publish Unit Test Results
      uses: EnricoMi/publish-unit-test-result-action@39ee91a16bb587a6c2b4791d4954cf5299736efd
      # Per https://github.com/EnricoMi/publish-unit-test-result-action#support-fork-repositories-and-dependabot-branches
      if: >
        always() &&
        github.event.sender.login != 'dependabot[bot]' &&
        ( github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository )
      with:
        # This path is from the root of the repo as needed by the plugin
        files: prime-router/build/test-results/test/**/*.xml

    - name: Upload Artifact
      uses: actions/upload-artifact@0b7f8abb1508181956e8e162db84b466c27e18ce
      with:
        name: prime-router-build-${{ inputs.version }}
        path: prime-router/prime-router-build.tar.gz
        retention-days: 3
